<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#00bb55" />
  <title>Farmapp</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121a22;
      --muted:#8aa0b5;
      --text:#e8f0f7;
      --line:#243242;
      --accent:#0b5;
      --danger:#d44;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --pad:14px;
      --max: 980px;
      --bgimg: none;
      --bgdim: .55;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        linear-gradient(rgba(0,0,0,var(--bgdim)), rgba(0,0,0,var(--bgdim))),
        var(--bgimg),
        radial-gradient(1200px 600px at 30% -10%, rgba(0,180,90,.22), transparent 60%),
        var(--bg);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      background: rgba(11,15,20,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      gap:10px;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:0}
    .dot{width:14px; height:14px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 6px rgba(0,180,90,.12)}
    .title{font-weight:800; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .container{max-width:var(--max); margin:0 auto; padding: 14px}
    .tabs{display:flex; gap:8px; overflow:auto; padding-bottom:10px;}
    .tab{
      border:1px solid var(--line);
      background:transparent; color:var(--text);
      padding:10px 12px; border-radius:999px;
      white-space:nowrap; font-weight:800;
    }
    .tab.active{border-color: rgba(0,180,90,.65); background: rgba(0,180,90,.12)}
    .panel{padding: 6px 0 24px}
    .hidden{display:none}

    h1{font-size:22px; margin: 14px 2px}
    h2{font-size:16px; margin: 0 0 10px}
    .muted{color:var(--muted); line-height:1.4}
    .hint{color:var(--muted); font-size:12px; line-height:1.35; margin-top:10px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
      margin: 12px 0;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 700px){ .grid3{grid-template-columns:1fr 1fr 1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .field span{font-size:12px; color:var(--muted)}
    input, select, textarea{
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.2);
      color: var(--text);
      font-size:16px;
    }
    textarea{min-height:110px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      outline:none; border-color: rgba(0,180,90,.7); box-shadow: 0 0 0 4px rgba(0,180,90,.12)
    }

    .btn{
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,180,90,.6);
      background: rgba(0,180,90,.16);
      color: var(--text);
      font-weight: 900;
    }
    .btn.secondary{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.12);}
    .btn.danger{border-color: rgba(212,68,68,.8); background: rgba(212,68,68,.14);}
    .btn.ghost{border-color: var(--line); background: transparent;}
    .btn.small{padding:8px 10px; border-radius:10px; font-weight:900; font-size:13px}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:900; letter-spacing:.2px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .badge.free{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.10)}
    .badge.ok{border-color: rgba(0,180,90,.6); background: rgba(0,180,90,.12)}
    .badge.warn{border-color: rgba(255,200,40,.7); background: rgba(255,200,40,.10)}
    .badge.fail{border-color: rgba(212,68,68,.7); background: rgba(212,68,68,.12)}

    .moduleRow{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      padding:12px; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,.12);
      margin:10px 0;
    }
    .moduleMeta{min-width:0}
    .moduleTitle{font-weight:950}
    .moduleDesc{color:var(--muted); font-size:12px; line-height:1.35; margin-top:4px}
    .moduleRight{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .moduleActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .tileGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (min-width: 700px){ .tileGrid{ grid-template-columns: 1fr 1fr 1fr; } }
    .tile{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      min-height:74px;
      box-shadow: var(--shadow);
    }
    .tile:active{transform: translateY(1px)}
    .tileIcon{
      width:44px; height:44px; border-radius:14px;
      border:1px solid rgba(0,180,90,.35);
      background: rgba(0,180,90,.10);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      font-weight:900;
    }
    .tileText{min-width:0}
    .tileTitle{font-weight:950; line-height:1.1}
    .tileSub{font-size:12px; color:var(--muted); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .overlay.hidden{display:none}
    .overlay{position:fixed; inset:0; z-index:80}
    .overlayBg{position:absolute; inset:0; background: rgba(0,0,0,.62)}
    .modal{
      position:absolute; left:10px; right:10px; top:10px;
      max-width:560px; margin:0 auto;
      background: var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .modal h3{margin:0 0 8px}
    .modal .muted{margin:0 0 10px}
    hr{border:none; border-top:1px solid var(--line); margin:12px 0}

    .note{
      border:1px dashed rgba(138,160,181,.5);
      background: rgba(138,160,181,.07);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .actItem{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      margin:8px 0;
    }
    .actItem:active{transform: translateY(1px)}
    .actTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .actTitle{font-weight:950}
    .actTime{font-size:12px;color:var(--muted);white-space:nowrap}
    .actSub{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}
  </style>
</head>

<body>
  <header class="topbar">
    <button class="btn ghost" id="btnMinGard" aria-label="Min g√•rd">‚öô Min g√•rd</button>

    <div class="brand">
      <div class="dot"></div>
      <div style="min-width:0">
        <div class="title" id="topTitle">Farmapp</div>
        <div class="subtitle" id="statusLine">Starter‚Ä¶</div>
      </div>
    </div>

    <button class="btn ghost" id="btnPanelSetup" aria-label="Panel">üß© Panel</button>
  </header>

  <main class="container">
    <nav class="tabs" id="tabs">
      <button class="tab active" data-route="dashboard">Forside</button>
      <button class="tab" data-route="modules">Moduler</button>
      <button class="tab" data-route="work">Arbeid</button>
      <button class="tab" data-route="fieldplan">Skifteplan</button>
      <button class="tab" data-route="backup">Backup</button>
      <button class="tab" data-route="tests">Selvtest</button>
    </nav>

    <section class="panel" data-view="dashboard">
      <h1>Forside</h1>
      <p class="muted">Hurtigtaster og siste aktiviteter. (Ingen sletteknapper p√• forsiden.)</p>

      <div class="card">
        <h2>Hurtigtaster</h2>
        <div id="dashboardTiles" class="tileGrid"></div>
        <div class="hint" id="dashboardHint"></div>
      </div>

      <div class="card">
        <h2>Siste aktiviteter</h2>
        <div class="muted" style="font-size:12px; margin-bottom:8px;">Trykk p√• en aktivitet for detaljer / hopp til riktig sted.</div>
        <div id="activityList"></div>
        <div class="hint">Loggen er rullerende for √• holde appen rask.</div>
      </div>
    </section>

    <section class="panel hidden" data-view="modules">
      <h1>Moduler</h1>
      <p class="muted">Velg om snarvei skal vises p√• Forside. √Öpne moduler herfra.</p>
      <div class="card">
        <h2>Oversikt</h2>
        <div id="modulesList"></div>
        <div class="hint">Rekkef√∏lge styres i üß© Panel.</div>
      </div>
    </section>

    <section class="panel hidden" data-view="work">
      <h1>Arbeid</h1>
      <p class="muted">Hendelser, Spr√∏yting, TO DO, Handleliste og Jobbklokke.</p>
      <div id="workHost"></div>
    </section>

    <section class="panel hidden" data-view="fieldplan">
      <h1>Skifteplan</h1>
      <p class="muted">Gj√∏dselplan, gj√∏dseljournal og plantevernjournal knyttet til skifte (og evt kvalitet innen skiftet).</p>
      <div id="fieldPlanHost"></div>
    </section>

    <section class="panel hidden" data-view="settings">
      <h1>Min g√•rd</h1>
      <p class="muted">Her legger du inn skifter. Appen summerer areal og sjekker mot angitt totalareal.</p>

      <div class="card">
        <h2>G√•rdsinfo</h2>
        <label class="field">
          <span>Navn</span>
          <input id="farmName" type="text" placeholder="F.eks. Min g√•rd" />
        </label>

        <label class="field" style="margin-top:10px">
          <span>Angitt totalt areal (daa)</span>
          <input id="declaredTotalArea" type="number" inputmode="decimal" min="0" step="0.1" placeholder="F.eks. 120" />
        </label>

        <hr/>

        <label class="field">
          <span>Yr.no-lenke (sted)</span>
          <input id="yrUrl" type="text" placeholder="Lim inn yr.no-lenke til ditt sted" />
        </label>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnSaveFarmSettings">Lagre</button>
        </div>
      </div>

      <div class="card">
        <h2>Areal (beregnet fra skifter)</h2>
        <div class="grid2">
          <div><div class="muted" style="font-size:12px">Fulldyrket</div><div style="font-size:18px;font-weight:900" id="sumFulldyrket">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">Overflatedyrket</div><div style="font-size:18px;font-weight:900" id="sumOverflate">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">Innmarksbeite</div><div style="font-size:18px;font-weight:900" id="sumInnmarks">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">Totalt fra skifter</div><div style="font-size:18px;font-weight:900" id="sumTotal">‚Äî</div></div>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="badge free" id="areaCheckBadge">‚Äî</span>
        </div>
        <div class="hint">Skifte-total = fulldyrket + overflatedyrket + innmarksbeite. Avvik beregnes mot ‚ÄúAngitt totalt areal‚Äù.</div>
      </div>

      <div class="card">
        <h2>Skifter</h2>
        <div class="row">
          <button class="btn" id="btnNewField">Legg til skifte</button>
        </div>
        <hr/>
        <div id="fieldsList"></div>
      </div>

      <div class="card">
        <h2>N√∏kkeltall</h2>
        <div class="grid2">
          <div><div class="muted" style="font-size:12px">Sist lagret</div><div style="font-size:18px;font-weight:900" id="kpiUpdatedAt">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">Skifter</div><div style="font-size:18px;font-weight:900" id="kpiFieldCount">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">Hendelser</div><div style="font-size:18px;font-weight:900" id="kpiEventCount">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">Spr√∏yting</div><div style="font-size:18px;font-weight:900" id="kpiSprayCount">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">TO DO (√•pne)</div><div style="font-size:18px;font-weight:900" id="kpiTodoCount">‚Äî</div></div>
          <div><div class="muted" style="font-size:12px">Handleliste (√•pne)</div><div style="font-size:18px;font-weight:900" id="kpiShopCount">‚Äî</div></div>
        </div>
      </div>

      <div class="card">
        <h2>Kontroll</h2>
        <div class="row">
          <button class="btn secondary" id="btnSaveNow">Lagre n√•</button>
          <button class="btn danger" id="btnResetFarm">Nullstill g√•rd</button>
        </div>
        <p class="hint">Ta backup f√∏r nullstilling.</p>
      </div>
    </section>

    <section class="panel hidden" data-view="panelsetup">
      <h1>Panel</h1>
      <p class="muted">Vis/skjul snarveier og flytt rekkef√∏lge (‚¨Ü/‚¨á). Du kan ogs√• legge til egne weblinker.</p>

      <div class="card">
        <h2>Snarveier</h2>
        <div id="panelSetupList"></div>
        <div class="hint">Endringer lagres automatisk.</div>
      </div>

      <div class="card">
        <h2>Legg til weblink</h2>
        <div class="grid2">
          <label class="field"><span>Navn</span><input id="wlName" type="text" placeholder="F.eks. Felleskj√∏pet" /></label>
          <label class="field"><span>URL</span><input id="wlUrl" type="text" placeholder="https://..." /></label>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnAddWeblink">Legg til</button>
        </div>
        <div class="hint">Weblink √•pnes i ny fane.</div>
      </div>
    </section>

    <section class="panel hidden" data-view="backup">
      <h1>Backup</h1>

      <div class="card">
        <h2>Eksporter</h2>
        <p class="muted">Laster ned √©n JSON-fil med g√•rdsdata.</p>
        <button class="btn" id="btnExport">Eksporter backup</button>
      </div>

      <div class="card">
        <h2>Importer</h2>
        <p class="muted">Importer overskriver gjeldende g√•rd i appen.</p>
        <input id="importFile" type="file" accept="application/json" />
        <button class="btn danger" id="btnImport">Importer backup</button>
      </div>
    </section>

    <section class="panel hidden" data-view="tests">
      <h1>Selvtest</h1>
      <div class="card">
        <h2>Testpanel</h2>
        <div class="row">
          <button class="btn" id="btnRunTests">Kj√∏r selvtest</button>
        </div>
        <div id="testResults"></div>
      </div>
    </section>
  </main>

  <div class="overlay hidden" id="editorOverlay">
    <div class="overlayBg" id="editorOverlayBg"></div>
    <div class="modal">
      <h3 id="editorTitle">Rediger</h3>
      <p class="muted" id="editorSubtitle"></p>
      <div id="editorFields"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnEditorSave">Lagre</button>
        <button class="btn ghost" id="btnEditorCancel">Avbryt</button>
      </div>
      <div class="hint" id="editorHint"></div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      const $ = (q) => document.querySelector(q);
      const $$ = (q) => [...document.querySelectorAll(q)];

      const APP_VERSION = "1.1.0-fields-fieldplan";
      const DB_NAME = "farmapp_phase1_db";
      const DB_VERSION = 4;
      const STORE = "docs";
      const KEY_FARM = "farm";
      const KEY_PANEL = "panel";
      const KEY_WEBLINKS = "weblinks";

      const MAX_ACTIVITIES = 300;
      const AREA_TOL = 0.1;

      function setStatus(s){ $("#statusLine").textContent = s; }
      function uuid(){ try { return crypto.randomUUID(); } catch { return String(Date.now()) + "-" + Math.random().toString(16).slice(2); } }
      function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[c])); }
      function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
      function clamp0(n){ n = num(n); return n < 0 ? 0 : n; }

      function fmtDateISOToNO(isoYmd){
        if(!isoYmd) return "‚Äî";
        const d = new Date(isoYmd + "T00:00:00");
        if(Number.isNaN(d.getTime())) return isoYmd;
        return d.toLocaleDateString("nb-NO", { day:"2-digit", month:"2-digit", year:"numeric" });
      }
      function fmtDateTime(iso){
        if(!iso) return "‚Äî";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return String(iso);
        const date = d.toLocaleDateString("nb-NO", { day:"2-digit", month:"2-digit", year:"numeric" });
        const time = d.toLocaleTimeString("nb-NO", { hour:"2-digit", minute:"2-digit", hour12:false });
        return `${date} ${time}`;
      }
      function todayISO(){
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}`;
      }

      // Storage
      let storageMode = "indexeddb";
      function lsKey(k){ return `${DB_NAME}::${k}`; }

      function openDB(){
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = () => {
            const db = req.result;
            if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }
      async function idbGet(key){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readonly");
          const st = tx.objectStore(STORE);
          const req = st.get(key);
          req.onsuccess = () => { db.close(); resolve(req.result ?? null); };
          req.onerror = () => { db.close(); reject(req.error); };
        });
      }
      async function idbSet(key, val){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readwrite");
          tx.objectStore(STORE).put(val, key);
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); reject(tx.error); };
        });
      }
      async function idbClear(){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readwrite");
          tx.objectStore(STORE).clear();
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); reject(tx.error); };
        });
      }
      function lsGet(key){
        const raw = localStorage.getItem(lsKey(key));
        if(!raw) return null;
        try { return JSON.parse(raw); } catch { return null; }
      }
      function lsSet(key, val){ localStorage.setItem(lsKey(key), JSON.stringify(val)); }
      function lsClear(){
        const prefix = lsKey("");
        const toDel = [];
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(k && k.startsWith(prefix)) toDel.push(k);
        }
        toDel.forEach(k => localStorage.removeItem(k));
      }
      async function dbProbe(){
        try{
          await idbSet("__probe__", { t: Date.now() });
          const v = await idbGet("__probe__");
          if(!v) throw new Error("probe failed");
          storageMode = "indexeddb";
        }catch{
          storageMode = "localstorage";
        }
      }
      async function dbGet(key){
        if(storageMode==="localstorage") return lsGet(key);
        try { return await idbGet(key); }
        catch { storageMode="localstorage"; return lsGet(key); }
      }
      async function dbSet(key,val){
        if(storageMode==="localstorage") return lsSet(key,val);
        try { return await idbSet(key,val); }
        catch { storageMode="localstorage"; return lsSet(key,val); }
      }
      async function dbClear(){
        if(storageMode==="localstorage") return lsClear();
        try { return await idbClear(); }
        catch { storageMode="localstorage"; return lsClear(); }
      }

      // Data model
      let farm = null;
      let panel = null;
      let weblinks = null;

      function newFarm(){
        const now = new Date().toISOString();
        return {
          meta: { appVersion: APP_VERSION, createdAt: now, updatedAt: now },
          farm: {
            id: uuid(),
            name: "Min g√•rd",
            yrUrl: "https://www.yr.no",
            declaredTotalAreaDaa: 0,
            modules: {
              fields: { items: [] }, // skifter
              fieldPlan: { fertilizerPlan: [], fertilizerLog: [], plantProtectionLog: [] },

              events: { categories: ["Vedlikehold","Sl√•tt","Beite","Avvik","Notat"], entries: [] },
              spraying: { entries: [] }, // also writes to plantProtectionLog
              todo: { items: [] },
              shopping: { suppliers: ["Felleskj√∏pet","Coop","Bondekompaniet","Annet"], items: [] },
              jobTimer: { running: null, sessions: [] }
            },
            activityLog: []
          }
        };
      }

      function patchFarm(d){
        if(!d || typeof d !== "object") return newFarm();
        if(!d.meta) d.meta = { appVersion: APP_VERSION, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
        if(!d.farm) return newFarm();

        if(typeof d.farm.name !== "string") d.farm.name = "Min g√•rd";
        if(typeof d.farm.yrUrl !== "string" || !d.farm.yrUrl.trim()) d.farm.yrUrl = "https://www.yr.no";
        d.farm.declaredTotalAreaDaa = clamp0(d.farm.declaredTotalAreaDaa);

        if(!d.farm.modules) d.farm.modules = {};
        const m = d.farm.modules;

        if(!m.fields) m.fields = { items: [] };
        if(!Array.isArray(m.fields.items)) m.fields.items = [];
        m.fields.items = m.fields.items.map(f => patchField(f)).filter(Boolean);

        if(!m.fieldPlan) m.fieldPlan = { fertilizerPlan: [], fertilizerLog: [], plantProtectionLog: [] };
        if(!Array.isArray(m.fieldPlan.fertilizerPlan)) m.fieldPlan.fertilizerPlan = [];
        if(!Array.isArray(m.fieldPlan.fertilizerLog)) m.fieldPlan.fertilizerLog = [];
        if(!Array.isArray(m.fieldPlan.plantProtectionLog)) m.fieldPlan.plantProtectionLog = [];

        if(!m.events) m.events = { categories: ["Notat"], entries: [] };
        if(!Array.isArray(m.events.categories)) m.events.categories = ["Notat"];
        if(!Array.isArray(m.events.entries)) m.events.entries = [];

        if(!m.spraying) m.spraying = { entries: [] };
        if(!Array.isArray(m.spraying.entries)) m.spraying.entries = [];

        if(!m.todo) m.todo = { items: [] };
        if(!Array.isArray(m.todo.items)) m.todo.items = [];

        if(!m.shopping) m.shopping = { suppliers: ["Annet"], items: [] };
        if(!Array.isArray(m.shopping.suppliers)) m.shopping.suppliers = ["Annet"];
        if(!Array.isArray(m.shopping.items)) m.shopping.items = [];

        if(!m.jobTimer) m.jobTimer = { running:null, sessions: [] };
        if(!Array.isArray(m.jobTimer.sessions)) m.jobTimer.sessions = [];
        if(m.jobTimer.running && typeof m.jobTimer.running !== "object") m.jobTimer.running = null;

        if(!Array.isArray(d.farm.activityLog)) d.farm.activityLog = [];

        return d;
      }

      function patchField(f){
        if(!f || typeof f !== "object") return null;
        const now = new Date().toISOString();
        return {
          id: String(f.id || uuid()),
          name: String(f.name || "").trim() || "Nytt skifte",
          areas: {
            fulldyrket: clamp0(f.areas?.fulldyrket),
            overflatedyrket: clamp0(f.areas?.overflatedyrket),
            innmarksbeite: clamp0(f.areas?.innmarksbeite)
          },
          notes: String(f.notes || ""),
          createdAt: f.createdAt || now,
          updatedAt: now
        };
      }

      function defaultPanel(){
        return {
          visible: {
            "fields.new": true,
            "fieldplan.open": true,
            "events.new": true,
            "spray.new": true,
            "todo.new": true,
            "shopping.new": true,
            "job.toggle": true,
            "weather.yr": true
          },
          order: ["fields.new","fieldplan.open","events.new","spray.new","todo.new","shopping.new","job.toggle","weather.yr"]
        };
      }
      function patchPanel(p){
        const base = defaultPanel();
        if(!p || typeof p !== "object") return base;
        if(!p.visible || typeof p.visible !== "object") p.visible = {...base.visible};
        if(!Array.isArray(p.order)) p.order = base.order.slice();

        for(const id of base.order){
          if(typeof p.visible[id] !== "boolean") p.visible[id] = base.visible[id];
          if(!p.order.includes(id)) p.order.push(id);
        }
        const seen = new Set();
        p.order = p.order.filter(x => typeof x === "string" && x.trim()).filter(x => (seen.has(x) ? false : (seen.add(x), true)));
        return p;
      }
      function patchWeblinks(w){
        if(!w || typeof w !== "object") return { items: [] };
        if(!Array.isArray(w.items)) w.items = [];
        w.items = w.items.filter(x => x && typeof x === "object" && x.id && x.name && x.url);
        return w;
      }

      // Activity log
      function addActivity({type, title, subtitle, route, payload}){
        const entry = {
          id: uuid(),
          ts: new Date().toISOString(),
          type: String(type||"activity"),
          title: String(title||"Aktivitet"),
          subtitle: String(subtitle||""),
          route: String(route||"dashboard"),
          payload: payload || {}
        };
        farm.farm.activityLog.unshift(entry);
        if(farm.farm.activityLog.length > MAX_ACTIVITIES) farm.farm.activityLog.length = MAX_ACTIVITIES;
      }

      // Routing
      function routeTo(route){
        $$("#tabs .tab").forEach(b => b.classList.toggle("active", b.dataset.route === route));
        $$("[data-view]").forEach(v => v.classList.toggle("hidden", v.dataset.view !== route));
      }

      // Editor modal
      const editor = { onSave:null, onCancel:null, value:null, fields:[], hint:"" };

      function openEditor(cfg){
        editor.onSave = cfg.onSave || null;
        editor.onCancel = cfg.onCancel || null;
        editor.value = JSON.parse(JSON.stringify(cfg.value || {}));
        editor.fields = cfg.fields || [];
        editor.hint = cfg.hint || "";

        $("#editorTitle").textContent = cfg.title || "Rediger";
        $("#editorSubtitle").textContent = cfg.subtitle || "";
        $("#editorHint").textContent = editor.hint || "";

        const host = $("#editorFields");
        host.innerHTML = "";

        for(const f of editor.fields){
          const wrap = document.createElement("label");
          wrap.className = "field";
          const label = document.createElement("span");
          label.textContent = f.label;
          wrap.appendChild(label);

          let input;

          if(f.type === "select"){
            input = document.createElement("select");
            for(const [val, txt] of (f.options||[])){
              const opt = document.createElement("option");
              opt.value = val;
              opt.textContent = txt;
              input.appendChild(opt);
            }
            input.value = editor.value[f.key] ?? (f.options?.[0]?.[0] ?? "");
            input.addEventListener("input", () => editor.value[f.key] = input.value);
          } else if (f.type === "textarea"){
            input = document.createElement("textarea");
            input.value = editor.value[f.key] ?? "";
            input.addEventListener("input", () => editor.value[f.key] = input.value);
          } else if (f.type === "datalist"){
            const listId = `dl_${f.key}_${uuid()}`;
            input = document.createElement("input");
            input.type = "text";
            input.setAttribute("list", listId);
            input.placeholder = f.placeholder || "";
            input.value = editor.value[f.key] ?? "";
            const dl = document.createElement("datalist");
            dl.id = listId;
            (f.options || []).forEach(val => {
              const opt = document.createElement("option");
              opt.value = val;
              dl.appendChild(opt);
            });
            input.addEventListener("input", () => editor.value[f.key] = input.value);
            wrap.appendChild(input);
            wrap.appendChild(dl);
            host.appendChild(wrap);
            continue;
          } else {
            input = document.createElement("input");
            input.type = (f.type === "number") ? "number" : "text";
            if(f.type === "number"){
              input.inputMode = "decimal";
              if(f.step != null) input.step = String(f.step);
              if(f.min != null) input.min = String(f.min);
            }
            input.placeholder = f.placeholder || "";
            input.value = editor.value[f.key] ?? "";
            input.addEventListener("input", () => {
              editor.value[f.key] = (f.type === "number") ? Number(input.value) : input.value;
            });
          }

          wrap.appendChild(input);
          host.appendChild(wrap);
        }

        $("#editorOverlay").classList.remove("hidden");
      }

      function closeEditor(runCancel){
        if(runCancel && typeof editor.onCancel === "function"){ try{ editor.onCancel(); }catch{} }
        $("#editorOverlay").classList.add("hidden");
        editor.onSave = null; editor.onCancel = null; editor.value = null; editor.fields = []; editor.hint = "";
      }

      // Save/sync
      function syncFarmToForm(){
        $("#farmName").value = farm.farm.name ?? "";
        $("#yrUrl").value = farm.farm.yrUrl ?? "https://www.yr.no";
        $("#declaredTotalArea").value = farm.farm.declaredTotalAreaDaa ?? 0;
        $("#topTitle").textContent = farm.farm.name || "Farmapp";
      }
      function syncFormToFarm(){
        farm.farm.name = ($("#farmName").value || "").trim() || "Min g√•rd";
        farm.farm.yrUrl = ($("#yrUrl").value || "").trim() || "https://www.yr.no";
        farm.farm.declaredTotalAreaDaa = clamp0($("#declaredTotalArea").value);
        farm.meta.updatedAt = new Date().toISOString();
      }

      async function saveAll(){
        syncFormToFarm();
        farm = patchFarm(farm);
        panel = patchPanel(panel);
        weblinks = patchWeblinks(weblinks);

        await dbSet(KEY_FARM, farm);
        await dbSet(KEY_PANEL, panel);
        await dbSet(KEY_WEBLINKS, weblinks);

        $("#topTitle").textContent = farm.farm.name || "Farmapp";
        setStatus(`Lagret ‚úÖ (${storageMode})`);
      }

      // Fields sums
      function fieldTotals(){
        const items = farm.farm.modules.fields.items;
        let ful = 0, ov = 0, inn = 0;
        for(const f of items){
          ful += clamp0(f.areas?.fulldyrket);
          ov  += clamp0(f.areas?.overflatedyrket);
          inn += clamp0(f.areas?.innmarksbeite);
        }
        const total = ful + ov + inn;
        return { ful, ov, inn, total };
      }

      function scopeOptionsForField(field){
        const opts = [["whole","Hele skiftet"]];
        if((field.areas?.fulldyrket||0) > 0) opts.push(["fulldyrket", "Fulldyrket"]);
        if((field.areas?.overflatedyrket||0) > 0) opts.push(["overflatedyrket", "Overflatedyrket"]);
        if((field.areas?.innmarksbeite||0) > 0) opts.push(["innmarksbeite", "Innmarksbeite"]);
        return opts;
      }

      function fieldNameById(id){
        const f = farm.farm.modules.fields.items.find(x => x.id === id);
        return f ? f.name : "Ukjent skifte";
      }

      // Actions registry
      const ActionRegistry = new Map();
      function setAction(id, def){ ActionRegistry.set(id, def); }
      function getAction(id){ return ActionRegistry.get(id) || null; }

      function registerBaseActions(){
        setAction("fields.new", {
          title: () => "Nytt skifte",
          subtitle: () => "Legg inn areal",
          icon: () => "üß©",
          run: async () => { routeTo("settings"); actions.newField(); }
        });
        setAction("fieldplan.open", {
          title: () => "Skifteplan",
          subtitle: () => "Plan & journal",
          icon: () => "üßæ",
          run: async () => routeTo("fieldplan")
        });
        setAction("events.new", {
          title: () => "Ny hendelse",
          subtitle: () => "Velg kategori",
          icon: () => "üóíÔ∏è",
          run: async () => actions.newEvent(true)
        });
        setAction("spray.new", {
          title: () => "Ny spr√∏yting",
          subtitle: () => "Lagrer ogs√• i plantevernjournal",
          icon: () => "üíß",
          run: async () => actions.newSpray(true)
        });
        setAction("todo.new", {
          title: () => "Nytt gj√∏rem√•l",
          subtitle: () => "TO DO",
          icon: () => "‚úÖ",
          run: async () => actions.newTodo(true)
        });
        setAction("shopping.new", {
          title: () => "Ny vare",
          subtitle: () => "Handleliste",
          icon: () => "üõí",
          run: async () => actions.newShopping(true)
        });
        setAction("job.toggle", {
          title: () => farm.farm.modules.jobTimer.running ? "Stopp jobb" : "Start jobb",
          subtitle: () => {
            const r = farm.farm.modules.jobTimer.running;
            return r ? `${r.customer} ¬∑ ${r.task}`.slice(0,40) : "Kunde + oppdrag";
          },
          icon: () => "‚è±Ô∏è",
          run: async () => {
            const r = farm.farm.modules.jobTimer.running;
            if(r) await actions.stopJob(true);
            else await actions.startJob(true);
          }
        });
        setAction("weather.yr", {
          title: () => "V√¶r (yr.no)",
          subtitle: () => "√Öpner sted",
          icon: () => "üå¶Ô∏è",
          run: async () => {
            const url = (farm.farm.yrUrl || "https://www.yr.no").trim();
            window.open(url, "_blank", "noopener,noreferrer");
            addActivity({ type:"weather", title:"√Öpnet v√¶r", subtitle:url, route:"dashboard", payload:{ url } });
            await saveAll();
            renderActivities();
          }
        });
      }

      function registerWeblinkActions(){
        for(const w of weblinks.items){
          const id = `weblink:${w.id}`;
          if(ActionRegistry.has(id)) continue;
          setAction(id, {
            title: () => w.name,
            subtitle: () => "Weblink",
            icon: () => "üîó",
            run: async () => {
              const url = String(w.url||"").trim();
              if(!/^https?:\/\//i.test(url)){ alert("URL m√• starte med http:// eller https://"); return; }
              window.open(url, "_blank", "noopener,noreferrer");
              addActivity({ type:"weblink", title:"√Öpnet weblink", subtitle:`${w.name} ¬∑ ${url}`, route:"dashboard", payload:{ weblinkId: w.id } });
              await saveAll();
              renderActivities();
            }
          });
        }
      }

      function ensurePanelHasWeblinks(){
        for(const w of weblinks.items){
          const id = `weblink:${w.id}`;
          if(typeof panel.visible[id] !== "boolean") panel.visible[id] = true;
          if(!panel.order.includes(id)) panel.order.push(id);
        }
      }

      // Module catalog for Moduler tab
      const ModuleCatalog = [
        { id:"fields", title:"Skifter", desc:"Legg inn skifter med areal fordelt p√• fulldyrket/overflatedyrket/innmarksbeite.", actionId:"fields.new", open:()=> routeTo("settings") },
        { id:"fieldplan", title:"Skifteplan", desc:"Gj√∏dselplan, gj√∏dseljournal og plantevernjournal p√• skifte.", actionId:"fieldplan.open", open:()=> routeTo("fieldplan") },
        { id:"events", title:"Hendelser", desc:"Logg hendelser med kategori og tekst.", actionId:"events.new", open:()=> routeTo("work") },
        { id:"spray", title:"Spr√∏yting", desc:"Hurtig spr√∏yting ‚Äì lagres ogs√• i plantevernjournal.", actionId:"spray.new", open:()=> routeTo("work") },
        { id:"todo", title:"TO DO", desc:"Gj√∏rem√•l med ferdige-liste og s√∏k.", actionId:"todo.new", open:()=> routeTo("work") },
        { id:"shopping", title:"Handleliste", desc:"Vare + leverand√∏r (skriv selv, appen l√¶rer).", actionId:"shopping.new", open:()=> routeTo("work") },
        { id:"job", title:"Jobbklokke", desc:"Start/stopp jobb og ufakturerte jobber.", actionId:"job.toggle", open:()=> routeTo("work") },
        { id:"weather", title:"V√¶r", desc:"√Öpner yr.no-sted fra Min g√•rd.", actionId:"weather.yr", open:()=> getAction("weather.yr").run() }
      ];

      // Business actions
      const actions = {
        newField: () => {
          const items = farm.farm.modules.fields.items;
          const now = new Date().toISOString();
          const draft = {
            id: uuid(),
            name: "",
            areas: { fulldyrket: 0, overflatedyrket: 0, innmarksbeite: 0 },
            notes: "",
            createdAt: now,
            updatedAt: now
          };
          items.unshift(draft);

          openEditor({
            title: "Nytt skifte",
            subtitle: "Fordel arealet p√• kvaliteter (daa). Total beregnes automatisk.",
            hint: "Tips: Sett 0 p√• det som ikke gjelder. Minst √©n kvalitet m√• v√¶re > 0.",
            fields: [
              { key:"name", label:"Navn p√• skifte", type:"text", placeholder:"F.eks. Skifte 3" },
              { key:"ful", label:"Fulldyrket (daa)", type:"number", min:0, step:0.1 },
              { key:"ov",  label:"Overflatedyrket (daa)", type:"number", min:0, step:0.1 },
              { key:"inn", label:"Innmarksbeite (daa)", type:"number", min:0, step:0.1 },
              { key:"notes", label:"Notat", type:"textarea" }
            ],
            value: {
              name: draft.name,
              ful: draft.areas.fulldyrket,
              ov: draft.areas.overflatedyrket,
              inn: draft.areas.innmarksbeite,
              notes: draft.notes
            },
            onCancel: () => {
              // remove if empty
              const first = items[0];
              if(first && first.id === draft.id){
                const sum = (first.areas.fulldyrket||0)+(first.areas.overflatedyrket||0)+(first.areas.innmarksbeite||0);
                if(!String(first.name||"").trim() && sum === 0) items.shift();
              }
            },
            onSave: async (nv) => {
              const f = items[0];
              f.name = String(nv.name||"").trim() || "Nytt skifte";
              f.areas.fulldyrket = clamp0(nv.ful);
              f.areas.overflatedyrket = clamp0(nv.ov);
              f.areas.innmarksbeite = clamp0(nv.inn);
              f.notes = String(nv.notes||"");
              f.updatedAt = new Date().toISOString();

              const total = f.areas.fulldyrket + f.areas.overflatedyrket + f.areas.innmarksbeite;
              if(total <= 0){
                alert("Skiftet m√• ha areal > 0 p√• minst √©n kvalitet.");
                return;
              }

              addActivity({ type:"fields", title:"La til skifte", subtitle:`${f.name} ¬∑ ${total.toFixed(1)} daa`, route:"settings", payload:{ fieldId:f.id } });
              await saveAll();
              renderAll();
              routeTo("settings");
            }
          });
        },

        editField: (field) => {
          const items = farm.farm.modules.fields.items;
          openEditor({
            title: "Rediger skifte",
            subtitle: "Endre navn og arealfordeling (daa).",
            fields: [
              { key:"name", label:"Navn p√• skifte", type:"text" },
              { key:"ful", label:"Fulldyrket (daa)", type:"number", min:0, step:0.1 },
              { key:"ov",  label:"Overflatedyrket (daa)", type:"number", min:0, step:0.1 },
              { key:"inn", label:"Innmarksbeite (daa)", type:"number", min:0, step:0.1 },
              { key:"notes", label:"Notat", type:"textarea" }
            ],
            value: {
              name: field.name,
              ful: field.areas.fulldyrket,
              ov: field.areas.overflatedyrket,
              inn: field.areas.innmarksbeite,
              notes: field.notes
            },
            onSave: async (nv) => {
              field.name = String(nv.name||"").trim() || "Skifte";
              field.areas.fulldyrket = clamp0(nv.ful);
              field.areas.overflatedyrket = clamp0(nv.ov);
              field.areas.innmarksbeite = clamp0(nv.inn);
              field.notes = String(nv.notes||"");
              field.updatedAt = new Date().toISOString();

              const total = field.areas.fulldyrket + field.areas.overflatedyrket + field.areas.innmarksbeite;
              if(total <= 0){
                alert("Skiftet m√• ha areal > 0 p√• minst √©n kvalitet.");
                return;
              }

              addActivity({ type:"fields", title:"Redigert skifte", subtitle:`${field.name} ¬∑ ${total.toFixed(1)} daa`, route:"settings", payload:{ fieldId:field.id } });
              await saveAll();
              renderAll();
            }
          });
        },

        deleteField: async (field) => {
          const a = prompt("Skriv SLETT for √• slette skiftet permanent:");
          if(a !== "SLETT") return;
          const items = farm.farm.modules.fields.items;
          const idx = items.findIndex(x => x.id === field.id);
          if(idx >= 0) items.splice(idx, 1);

          // remove related entries in fieldPlan
          const fp = farm.farm.modules.fieldPlan;
          fp.fertilizerPlan = fp.fertilizerPlan.filter(e => e.fieldId !== field.id);
          fp.fertilizerLog  = fp.fertilizerLog.filter(e => e.fieldId !== field.id);
          fp.plantProtectionLog = fp.plantProtectionLog.filter(e => e.fieldId !== field.id);

          addActivity({ type:"fields", title:"Slettet skifte", subtitle: field.name, route:"settings", payload:{} });
          await saveAll();
          renderAll();
        },

        newEvent: async (goWork) => {
          const ev = farm.farm.modules.events;
          const item = { id: uuid(), date: todayISO(), category: ev.categories[0] || "Notat", text: "" };
          ev.entries.unshift(item);

          openEditor({
            title: "Ny hendelse",
            subtitle: "Velg kategori og skriv tekst.",
            fields: [
              { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
              { key:"category", label:"Kategori", type:"select", options: ev.categories.map(x => [x,x]) },
              { key:"text", label:"Tekst", type:"textarea" }
            ],
            value: item,
            onCancel: () => {
              const first = ev.entries[0];
              if(first && first.id === item.id && !(first.text||"").trim()) ev.entries.shift();
            },
            onSave: async (nv) => {
              ev.entries[0] = { ...ev.entries[0], ...nv };
              if(!String(ev.entries[0].text||"").trim()){ alert("Skriv tekst f√∏r lagring."); return; }
              addActivity({ type:"event", title:"Ny hendelse", subtitle:`${ev.entries[0].category} ¬∑ ${fmtDateISOToNO(ev.entries[0].date)}`, route:"work", payload:{ eventId: ev.entries[0].id } });
              await saveAll();
              renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        newSpray: async (goWork) => {
          const fields = farm.farm.modules.fields.items;
          if(!fields.length){
            alert("Du m√• legge inn minst ett skifte f√∏rst (Min g√•rd ‚Üí Skifter).");
            routeTo("settings");
            return;
          }

          const sp = farm.farm.modules.spraying;
          const firstField = fields[0];

          const item = {
            id: uuid(),
            date: todayISO(),
            fieldId: firstField.id,
            scope: "whole",
            product: "",
            reason: "",
            dose: "",
            water: "",
            area: "",
            notes: "",
            createdAt: new Date().toISOString()
          };
          sp.entries.unshift(item);

          const fieldOptions = fields.map(f => [f.id, f.name]);

          openEditor({
            title: "Ny spr√∏yting",
            subtitle: "Velg skifte (og evt kvalitet i skiftet). Lagres ogs√• i plantevernjournal.",
            fields: [
              { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
              { key:"fieldId", label:"Skifte", type:"select", options: fieldOptions },
              { key:"scope", label:"Kvalitet i skiftet", type:"select", options: scopeOptionsForField(firstField) },
              { key:"product", label:"Middel / produkt", type:"text", placeholder:"F.eks. Select / MCPA" },
              { key:"reason", label:"Form√•l", type:"text", placeholder:"Ugras / sopp / skadedyr" },
              { key:"dose", label:"Dose (valgfritt)", type:"text", placeholder:"F.eks. 50 ml/daa" },
              { key:"water", label:"Vannmengde (valgfritt)", type:"text", placeholder:"F.eks. 20 L/daa" },
              { key:"area", label:"Areal behandlet (valgfritt)", type:"text", placeholder:"F.eks. 12 daa" },
              { key:"notes", label:"Notat", type:"textarea" }
            ],
            value: item,
            onCancel: () => {
              const first = sp.entries[0];
              const empty = first && first.id === item.id &&
                !String(first.product||"").trim() &&
                !String(first.notes||"").trim();
              if(empty) sp.entries.shift();
            },
            onSave: async (nv) => {
              const cur = sp.entries[0];
              Object.assign(cur, nv);

              const product = String(cur.product||"").trim();
              if(!product){ alert("Skriv minst Produkt/Middel f√∏r lagring."); return; }

              // ensure scope options valid for selected field
              const f = fields.find(x => x.id === cur.fieldId) || firstField;
              const allowedScopes = new Set(scopeOptionsForField(f).map(x => x[0]));
              if(!allowedScopes.has(cur.scope)) cur.scope = "whole";

              // Write to plant protection journal
              const pp = farm.farm.modules.fieldPlan.plantProtectionLog;
              pp.unshift({
                id: uuid(),
                source: "spraying",
                sourceId: cur.id,
                fieldId: cur.fieldId,
                scope: cur.scope,
                date: cur.date,
                product: product,
                purpose: String(cur.reason||""),
                dose: String(cur.dose||""),
                water: String(cur.water||""),
                area: String(cur.area||""),
                notes: String(cur.notes||""),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
              });

              addActivity({
                type:"spray",
                title:"Ny spr√∏yting",
                subtitle:`${fmtDateISOToNO(cur.date)} ¬∑ ${product} ¬∑ ${fieldNameById(cur.fieldId)}`,
                route:"work",
                payload:{ sprayId: cur.id }
              });

              await saveAll();
              renderAll();
              if(goWork) routeTo("work");
            }
          });

          // dynamic scope options when field changes
          // (simple approach: we validate on save; keeps editor minimal/robust)
        },

        newTodo: async (goWork) => {
          const t = farm.farm.modules.todo;
          const item = { id: uuid(), text:"", dueDate:"", done:false, createdAt: new Date().toISOString(), doneAt:null };
          t.items.unshift(item);

          openEditor({
            title: "Nytt gj√∏rem√•l",
            subtitle: "Kort tekst ‚Äì evt. frist (YYYY-MM-DD).",
            fields: [
              { key:"text", label:"Tekst", type:"text" },
              { key:"dueDate", label:"Frist (valgfritt, YYYY-MM-DD)", type:"text" }
            ],
            value: item,
            onCancel: () => {
              const first = t.items[0];
              if(first && first.id === item.id && !(first.text||"").trim()) t.items.shift();
            },
            onSave: async (nv) => {
              t.items[0] = { ...t.items[0], ...nv };
              if(!String(t.items[0].text||"").trim()){ alert("Skriv tekst f√∏r lagring."); return; }
              addActivity({ type:"todo", title:"Nytt gj√∏rem√•l", subtitle:t.items[0].text.slice(0,60), route:"work", payload:{ todoId: t.items[0].id } });
              await saveAll(); renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        newShopping: async (goWork) => {
          const s = farm.farm.modules.shopping;
          const item = { id: uuid(), name:"", qty:"", supplier:"", bought:false, createdAt: new Date().toISOString(), boughtAt:null };
          s.items.unshift(item);

          openEditor({
            title: "Ny vare",
            subtitle: "Skriv vare + leverand√∏r (du kan skrive leverand√∏r selv).",
            hint: "Neste gang vil leverand√∏ren dukke opp som forslag.",
            fields: [
              { key:"name", label:"Vare", type:"text" },
              { key:"qty", label:"Mengde (valgfritt)", type:"text" },
              { key:"supplier", label:"Leverand√∏r (skriv selv)", type:"datalist", options: s.suppliers.slice().sort(), placeholder:"F.eks. Felleskj√∏pet" }
            ],
            value: item,
            onCancel: () => {
              const first = s.items[0];
              if(first && first.id === item.id && !(first.name||"").trim()) s.items.shift();
            },
            onSave: async (nv) => {
              s.items[0] = { ...s.items[0], ...nv };
              const name = String(s.items[0].name||"").trim();
              const supplier = String(s.items[0].supplier||"").trim();
              if(!name){ alert("Skriv varenavn f√∏r lagring."); return; }
              if(supplier && !s.suppliers.includes(supplier)) s.suppliers.push(supplier);
              addActivity({ type:"shopping", title:"Ny vare", subtitle:`${name}${supplier?(" ¬∑ "+supplier):""}`, route:"work", payload:{ itemId: s.items[0].id } });
              await saveAll(); renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        startJob: async (goWork) => {
          const jt = farm.farm.modules.jobTimer;
          if(jt.running){ alert("En jobb p√•g√•r allerede. Stopp den f√∏rst."); return; }

          const draft = { customer:"", task:"", note:"" };
          openEditor({
            title: "Start jobb",
            subtitle: "Skriv inn kunde og hva du gj√∏r.",
            fields: [
              { key:"customer", label:"Kunde", type:"text" },
              { key:"task", label:"Hva gj√∏r du", type:"text" },
              { key:"note", label:"Notat (valgfritt)", type:"text" }
            ],
            value: draft,
            onSave: async (nv) => {
              const customer = String(nv.customer||"").trim();
              const task = String(nv.task||"").trim();
              if(!customer || !task){ alert("Fyll inn b√•de Kunde og Hva gj√∏r du."); return; }
              jt.running = { id: uuid(), customer, task, note: String(nv.note||"").trim(), startedAt: new Date().toISOString() };
              addActivity({ type:"job", title:"Startet jobb", subtitle:`${customer} ¬∑ ${task}`, route:"work", payload:{ running:true } });
              await saveAll(); renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        stopJob: async (goWork) => {
          const jt = farm.farm.modules.jobTimer;
          if(!jt.running){ alert("Ingen jobb p√•g√•r."); return; }
          const end = new Date().toISOString();
          const r = jt.running;
          const minutes = Math.round((new Date(end) - new Date(r.startedAt)) / 60000);
          jt.sessions.unshift({ id:r.id, customer:r.customer, task:r.task, note:r.note||"", startedAt:r.startedAt, endedAt:end, minutes:Math.max(0,minutes), status:"unbilled" });
          jt.running = null;
          addActivity({ type:"job", title:"Stoppet jobb", subtitle:`${r.customer} ¬∑ ${r.task} ¬∑ ${Math.max(0, minutes)} min`, route:"work", payload:{ running:false } });
          await saveAll(); renderAll();
          if(goWork) routeTo("work");
        },

        // FieldPlan entries
        newFertilizerPlan: async () => {
          const fields = farm.farm.modules.fields.items;
          if(!fields.length){ alert("Legg inn skifte f√∏rst (Min g√•rd ‚Üí Skifter)."); routeTo("settings"); return; }
          const fp = farm.farm.modules.fieldPlan.fertilizerPlan;
          const f0 = fields[0];

          const entry = {
            id: uuid(),
            fieldId: f0.id,
            scope: "whole",
            date: todayISO(),
            product: "",
            amount: "",
            unit: "",
            notes: "",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          fp.unshift(entry);

          openEditor({
            title: "Ny gj√∏dselplan-linje",
            subtitle: "Planlagt gj√∏dsling for et skifte (evt kvalitet).",
            fields: [
              { key:"fieldId", label:"Skifte", type:"select", options: fields.map(f => [f.id, f.name]) },
              { key:"scope", label:"Kvalitet i skiftet", type:"select", options: scopeOptionsForField(f0) },
              { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
              { key:"product", label:"Produkt/type", type:"text" },
              { key:"amount", label:"Mengde", type:"text", placeholder:"F.eks. 12" },
              { key:"unit", label:"Enhet", type:"text", placeholder:"F.eks. kg/daa" },
              { key:"notes", label:"Notat", type:"textarea" }
            ],
            value: entry,
            onCancel: () => {
              const first = fp[0];
              if(first && first.id === entry.id && !String(first.product||"").trim()) fp.shift();
            },
            onSave: async (nv) => {
              Object.assign(fp[0], nv);
              fp[0].product = String(fp[0].product||"").trim();
              if(!fp[0].product){ alert("Fyll inn Produkt/type."); return; }

              const f = fields.find(x => x.id === fp[0].fieldId) || f0;
              const allowed = new Set(scopeOptionsForField(f).map(x => x[0]));
              if(!allowed.has(fp[0].scope)) fp[0].scope = "whole";

              fp[0].updatedAt = new Date().toISOString();
              addActivity({ type:"fieldplan", title:"Ny gj√∏dselplan", subtitle:`${fieldNameById(fp[0].fieldId)} ¬∑ ${fmtDateISOToNO(fp[0].date)} ¬∑ ${fp[0].product}`, route:"fieldplan", payload:{} });
              await saveAll(); renderAll(); routeTo("fieldplan");
            }
          });
        },

        newFertilizerLog: async () => {
          const fields = farm.farm.modules.fields.items;
          if(!fields.length){ alert("Legg inn skifte f√∏rst (Min g√•rd ‚Üí Skifter)."); routeTo("settings"); return; }
          const fl = farm.farm.modules.fieldPlan.fertilizerLog;
          const f0 = fields[0];

          const entry = {
            id: uuid(),
            fieldId: f0.id,
            scope: "whole",
            date: todayISO(),
            product: "",
            amount: "",
            unit: "",
            notes: "",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          fl.unshift(entry);

          openEditor({
            title: "Ny gj√∏dseljournal",
            subtitle: "Utf√∏rt gj√∏dsling for et skifte (evt kvalitet).",
            fields: [
              { key:"fieldId", label:"Skifte", type:"select", options: fields.map(f => [f.id, f.name]) },
              { key:"scope", label:"Kvalitet i skiftet", type:"select", options: scopeOptionsForField(f0) },
              { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
              { key:"product", label:"Produkt/type", type:"text" },
              { key:"amount", label:"Mengde", type:"text", placeholder:"F.eks. 12" },
              { key:"unit", label:"Enhet", type:"text", placeholder:"F.eks. kg/daa" },
              { key:"notes", label:"Notat", type:"textarea" }
            ],
            value: entry,
            onCancel: () => {
              const first = fl[0];
              if(first && first.id === entry.id && !String(first.product||"").trim()) fl.shift();
            },
            onSave: async (nv) => {
              Object.assign(fl[0], nv);
              fl[0].product = String(fl[0].product||"").trim();
              if(!fl[0].product){ alert("Fyll inn Produkt/type."); return; }

              const f = fields.find(x => x.id === fl[0].fieldId) || f0;
              const allowed = new Set(scopeOptionsForField(f).map(x => x[0]));
              if(!allowed.has(fl[0].scope)) fl[0].scope = "whole";

              fl[0].updatedAt = new Date().toISOString();
              addActivity({ type:"fieldplan", title:"Ny gj√∏dseljournal", subtitle:`${fieldNameById(fl[0].fieldId)} ¬∑ ${fmtDateISOToNO(fl[0].date)} ¬∑ ${fl[0].product}`, route:"fieldplan", payload:{} });
              await saveAll(); renderAll(); routeTo("fieldplan");
            }
          });
        },

        newPlantProtectionLog: async () => {
          const fields = farm.farm.modules.fields.items;
          if(!fields.length){ alert("Legg inn skifte f√∏rst (Min g√•rd ‚Üí Skifter)."); routeTo("settings"); return; }
          const pp = farm.farm.modules.fieldPlan.plantProtectionLog;
          const f0 = fields[0];

          const entry = {
            id: uuid(),
            source: "manual",
            sourceId: null,
            fieldId: f0.id,
            scope: "whole",
            date: todayISO(),
            product: "",
            purpose: "",
            dose: "",
            water: "",
            area: "",
            notes: "",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          pp.unshift(entry);

          openEditor({
            title: "Ny plantevernjournal",
            subtitle: "Registrer plantevern for skifte (evt kvalitet).",
            fields: [
              { key:"fieldId", label:"Skifte", type:"select", options: fields.map(f => [f.id, f.name]) },
              { key:"scope", label:"Kvalitet i skiftet", type:"select", options: scopeOptionsForField(f0) },
              { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
              { key:"product", label:"Middel / produkt", type:"text" },
              { key:"purpose", label:"Form√•l", type:"text", placeholder:"Ugras / sopp / skadedyr" },
              { key:"dose", label:"Dose", type:"text" },
              { key:"water", label:"Vannmengde", type:"text" },
              { key:"area", label:"Areal behandlet", type:"text" },
              { key:"notes", label:"Notat", type:"textarea" }
            ],
            value: entry,
            onCancel: () => {
              const first = pp[0];
              if(first && first.id === entry.id && !String(first.product||"").trim()) pp.shift();
            },
            onSave: async (nv) => {
              Object.assign(pp[0], nv);
              pp[0].product = String(pp[0].product||"").trim();
              if(!pp[0].product){ alert("Fyll inn Middel/produkt."); return; }

              const f = fields.find(x => x.id === pp[0].fieldId) || f0;
              const allowed = new Set(scopeOptionsForField(f).map(x => x[0]));
              if(!allowed.has(pp[0].scope)) pp[0].scope = "whole";

              pp[0].updatedAt = new Date().toISOString();
              addActivity({ type:"fieldplan", title:"Ny plantevernjournal", subtitle:`${fieldNameById(pp[0].fieldId)} ¬∑ ${fmtDateISOToNO(pp[0].date)} ¬∑ ${pp[0].product}`, route:"fieldplan", payload:{} });
              await saveAll(); renderAll(); routeTo("fieldplan");
            }
          });
        }
      };

      // Rendering
      function renderTiles(){
        const host = $("#dashboardTiles");
        const hint = $("#dashboardHint");
        host.innerHTML = "";
        hint.textContent = "";

        registerWeblinkActions();
        ensurePanelHasWeblinks();

        const visible = panel.order.filter(id => panel.visible[id] === true);
        if(!visible.length){
          hint.textContent = "Ingen snarveier valgt. Sl√• p√• under Moduler eller üß© Panel.";
          return;
        }

        for(const id of visible){
          const def = getAction(id);
          if(!def) continue;

          const tile = document.createElement("div");
          tile.className = "tile";
          tile.innerHTML = `
            <div class="tileIcon">${escapeHtml(def.icon?.() || "‚Ä¢")}</div>
            <div class="tileText">
              <div class="tileTitle">${escapeHtml(def.title?.() || id)}</div>
              <div class="tileSub">${escapeHtml(def.subtitle?.() || "")}</div>
            </div>
          `;
          tile.addEventListener("click", async () => {
            try { await def.run(); }
            catch(e){ alert("Noe gikk galt: " + (e?.message || String(e))); }
          });
          host.appendChild(tile);
        }
      }

      function renderActivities(){
        const host = $("#activityList");
        host.innerHTML = "";
        const list = farm.farm.activityLog || [];
        if(!list.length){
          const n = document.createElement("div");
          n.className = "note";
          n.textContent = "Ingen aktiviteter enn√•.";
          host.appendChild(n);
          return;
        }

        for(const a of list.slice(0, 40)){
          const div = document.createElement("div");
          div.className = "actItem";
          div.innerHTML = `
            <div class="actTop">
              <div class="actTitle">${escapeHtml(a.title)}</div>
              <div class="actTime">${escapeHtml(fmtDateTime(a.ts))}</div>
            </div>
            <div class="actSub">${escapeHtml(a.subtitle || "")}</div>
          `;
          div.addEventListener("click", () => {
            const route = a.route || "dashboard";
            if(["dashboard","modules","work","fieldplan","backup","tests","settings","panelsetup"].includes(route)) routeTo(route);
            else routeTo("dashboard");
          });
          host.appendChild(div);
        }
      }

      function renderModulesPage(){
        const host = $("#modulesList");
        host.innerHTML = "";

        for(const m of ModuleCatalog){
          if(!panel.order.includes(m.actionId)) panel.order.push(m.actionId);
          if(typeof panel.visible[m.actionId] !== "boolean") panel.visible[m.actionId] = true;
        }

        for(const m of ModuleCatalog){
          const isOn = panel.visible[m.actionId] === true;
          const row = document.createElement("div");
          row.className = "moduleRow";
          row.innerHTML = `
            <div class="moduleMeta">
              <div class="moduleTitle">${escapeHtml(m.title)} <span class="badge ${isOn ? "ok":"free"}">${isOn ? "P√• Forside":"Skjult"}</span></div>
              <div class="moduleDesc">${escapeHtml(m.desc)}</div>
            </div>
            <div class="moduleRight">
              <div class="moduleActions">
                <button class="btn secondary small" data-act="open">√Öpne</button>
                <button class="btn ${isOn ? "secondary":"ghost"} small" data-act="toggle">${isOn ? "Fjern fra Forside" : "Legg p√• Forside"}</button>
              </div>
            </div>
          `;
          row.querySelector('[data-act="open"]').addEventListener("click", async () => { await m.open(); });
          row.querySelector('[data-act="toggle"]').addEventListener("click", async () => {
            panel.visible[m.actionId] = !panel.visible[m.actionId];
            await dbSet(KEY_PANEL, panel);
            addActivity({ type:"modules", title: panel.visible[m.actionId] ? "Snarvei p√•" : "Snarvei av", subtitle: m.title, route:"modules", payload:{ actionId:m.actionId } });
            await saveAll();
            renderTiles();
            renderModulesPage();
            renderActivities();
          });
          host.appendChild(row);
        }
      }

      function renderPanelSetup(){
        const host = $("#panelSetupList");
        host.innerHTML = "";

        registerWeblinkActions();
        ensurePanelHasWeblinks();

        const ids = panel.order.slice();
        for(const [id] of ActionRegistry.entries()){ if(!ids.includes(id)) ids.push(id); }
        const seen = new Set();
        const finalIds = ids.filter(x => (seen.has(x) ? false : (seen.add(x), true)));

        for(const id of finalIds){
          const def = getAction(id);
          if(!def) continue;

          const on = panel.visible[id] === true;

          const row = document.createElement("div");
          row.className = "moduleRow";
          row.innerHTML = `
            <div class="moduleMeta">
              <div class="moduleTitle">${escapeHtml(def.title?.() || id)} <span class="badge ${on?"ok":"free"}">${on?"P√•":"Av"}</span></div>
              <div class="moduleDesc">${escapeHtml(def.subtitle?.() || "")}</div>
            </div>
            <div class="moduleRight">
              <div class="moduleActions">
                <button class="btn secondary small" data-act="up">‚¨Ü</button>
                <button class="btn secondary small" data-act="down">‚¨á</button>
                <button class="btn ${on ? "secondary":""} small" data-act="toggle">${on ? "P√•" : "Av"}</button>
                ${id.startsWith("weblink:") ? `<button class="btn danger small" data-act="remove">Slett</button>` : ``}
              </div>
            </div>
          `;

          row.querySelector('[data-act="up"]').addEventListener("click", async () => { moveInOrder(id, -1); await dbSet(KEY_PANEL, panel); renderTiles(); renderPanelSetup(); });
          row.querySelector('[data-act="down"]').addEventListener("click", async () => { moveInOrder(id, +1); await dbSet(KEY_PANEL, panel); renderTiles(); renderPanelSetup(); });
          row.querySelector('[data-act="toggle"]').addEventListener("click", async () => {
            panel.visible[id] = !on;
            await dbSet(KEY_PANEL, panel);
            addActivity({ type:"panel", title: panel.visible[id] ? "Snarvei p√•" : "Snarvei av", subtitle: def.title?.() || id, route:"panelsetup", payload:{ actionId:id } });
            await saveAll();
            renderTiles(); renderPanelSetup(); renderModulesPage(); renderActivities();
          });

          if(id.startsWith("weblink:")){
            row.querySelector('[data-act="remove"]').addEventListener("click", async () => {
              if(!confirm("Slette weblink og fjerne snarvei?")) return;
              const wId = id.split("weblink:")[1];
              weblinks.items = weblinks.items.filter(x => x.id !== wId);
              delete panel.visible[id];
              panel.order = panel.order.filter(x => x !== id);
              ActionRegistry.delete(id);

              addActivity({ type:"weblink", title:"Slettet weblink", subtitle:"", route:"panelsetup", payload:{} });
              await dbSet(KEY_WEBLINKS, weblinks);
              await dbSet(KEY_PANEL, panel);
              await saveAll(); 
