<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#00bb55" />
  <title>Gårdsapp</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#131a22;
      --muted:#8aa0b5;
      --text:#e8f0f7;
      --line:#243242;
      --accent:#0b5;
      --danger:#d44;
      --warn:#e0b400;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --pad:14px;
      --max: 980px;
      font-synthesis-weight: none;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(0,180,90,.25), transparent 60%), var(--bg);
      color:var(--text);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      background: rgba(11,15,20,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .dot{width:14px; height:14px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 6px rgba(0,180,90,.12)}
    .title{font-weight:700; letter-spacing:.2px}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px}

    .container{max-width:var(--max); margin:0 auto; padding: 14px}
    .tabs{
      display:flex; gap:8px; overflow:auto; padding-bottom:10px;
    }
    .tab{
      border:1px solid var(--line);
      background:transparent; color:var(--text);
      padding:10px 12px; border-radius:999px;
      white-space:nowrap; font-weight:600;
    }
    .tab.active{border-color: rgba(0,180,90,.65); background: rgba(0,180,90,.12)}

    .panel{padding: 6px 0 24px}
    .hidden{display:none}
    h1{font-size:22px; margin: 14px 2px}
    h2{font-size:16px; margin: 0 0 10px}
    h3{margin:0 0 10px}
    .muted{color:var(--muted); line-height:1.4}
    .hint{color:var(--muted); font-size:12px; line-height:1.35; margin-top:10px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
      margin: 12px 0;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 700px){
      .grid3{grid-template-columns:1fr 1fr 1fr}
    }
    .kpi{padding:12px; border:1px solid var(--line); border-radius:14px; background: rgba(0,0,0,.12)}
    .kpiLabel{font-size:12px; color:var(--muted)}
    .kpiValue{font-size:18px; font-weight:750; margin-top:4px}

    .field{display:flex; flex-direction:column; gap:6px}
    .field span{font-size:12px; color:var(--muted)}
    input, select, textarea{
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.2);
      color: var(--text);
      font-size:16px;
    }
    input:focus, select:focus, textarea:focus{
      outline:none; border-color: rgba(0,180,90,.7); box-shadow: 0 0 0 4px rgba(0,180,90,.12)
    }

    .btn{
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,180,90,.6);
      background: rgba(0,180,90,.16);
      color: var(--text);
      font-weight: 700;
    }
    .btn.secondary{
      border-color: rgba(138,160,181,.6);
      background: rgba(138,160,181,.12);
    }
    .btn.danger{
      border-color: rgba(212,68,68,.8);
      background: rgba(212,68,68,.14);
    }
    .btn.ghost{
      border-color: var(--line);
      background: transparent;
    }
    .btn.full{width:100%; justify-content:center}

    .results{margin-top:12px}
    .resultItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      background: rgba(0,0,0,.12);
    }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:800; letter-spacing:.2px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(0,180,90,.6); background: rgba(0,180,90,.12)}
    .badge.fail{border-color: rgba(212,68,68,.7); background: rgba(212,68,68,.12)}
    .badge.locked{border-color: rgba(224,180,0,.6); background: rgba(224,180,0,.12)}
    .badge.free{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.10)}
    .badge.on{border-color: rgba(0,180,90,.6); background: rgba(0,180,90,.10)}
    .badge.off{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.08)}
    .small{font-size:12px; color:var(--muted); line-height:1.35; margin-top:8px}

    .note{
      border:1px dashed rgba(138,160,181,.5);
      background: rgba(138,160,181,.07);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .moduleRow{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      padding:12px; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,.12);
      margin:10px 0;
    }
    .moduleMeta{min-width:0}
    .moduleTitle{font-weight:900}
    .moduleDesc{color:var(--muted); font-size:12px; line-height:1.35; margin-top:4px}
    .moduleRight{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .moduleActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:800;
      border:1px solid var(--line);
      color: var(--muted);
    }

    .overlay.hidden{display:none}
    .overlay{position:fixed; inset:0; z-index:80}
    .overlayBg{position:absolute; inset:0; background: rgba(0,0,0,.62)}
    .modal{
      position:absolute; left:10px; right:10px; top:10px;
      max-width:560px; margin:0 auto;
      background: var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .modal h3{margin:0 0 8px}
    .modal .muted{margin:0 0 10px}
    hr{border:none; border-top:1px solid var(--line); margin:12px 0}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="title">Gårdsapp</div>
        <div class="subtitle" id="statusLine">Starter…</div>
      </div>
    </div>
  </header>

  <main class="container">
    <nav class="tabs" id="tabs">
      <button class="tab active" data-route="dashboard">Oversikt</button>
      <button class="tab" data-route="work">Arbeid</button>
      <button class="tab" data-route="farm">Gård</button>
      <button class="tab" data-route="backup">Backup</button>
      <button class="tab" data-route="tests">Selvtest</button>
      <button class="tab" data-route="modules">Moduler</button>
    </nav>

    <section class="panel" data-view="dashboard">
      <h1>Oversikt</h1>
      <p class="muted">Produksjonsnøytral modulplattform. Bruk “Arbeid” for aktive moduler.</p>

      <div class="card">
        <h2>Nøkkeltall</h2>
        <div class="grid2">
          <div class="kpi">
            <div class="kpiLabel">Gårdsnavn</div>
            <div class="kpiValue" id="kpiFarmName">—</div>
          </div>
          <div class="kpi">
            <div class="kpiLabel">Sist lagret</div>
            <div class="kpiValue" id="kpiUpdatedAt">—</div>
          </div>
          <div class="kpi">
            <div class="kpiLabel">Areal total (daa)</div>
            <div class="kpiValue" id="kpiTotalDaa">—</div>
          </div>
          <div class="kpi">
            <div class="kpiLabel">Aktive moduler</div>
            <div class="kpiValue" id="kpiEnabledModules">—</div>
          </div>
          <div class="kpi">
            <div class="kpiLabel">Loggposter</div>
            <div class="kpiValue" id="kpiLogCount">—</div>
          </div>
          <div class="kpi">
            <div class="kpiLabel">Produksjoner (aktive)</div>
            <div class="kpiValue" id="kpiProdCount">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Hurtigvalg</h2>
        <div class="row">
          <button class="btn" id="btnCreateFarm">Opprett/Nullstill gård</button>
          <button class="btn secondary" id="btnSaveFarm">Lagre nå</button>
        </div>
        <p class="hint">Ta backup før nullstilling.</p>
      </div>
    </section>

    <section class="panel hidden" data-view="work">
      <h1>Arbeid</h1>
      <p class="muted">Her vises UI for aktive moduler (gratis + låst opp).</p>
      <div id="workHost"></div>
    </section>

    <section class="panel hidden" data-view="farm">
      <h1>Gård</h1>
      <div class="card">
        <h2>Grunninfo (gratis kjerne)</h2>

        <label class="field">
          <span>Navn</span>
          <input id="farmName" type="text" placeholder="F.eks. Min gård" />
        </label>

        <div class="grid3">
          <label class="field">
            <span>Dyrket mark (daa)</span>
            <input id="areaDyrket" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
          <label class="field">
            <span>Beite (daa)</span>
            <input id="areaBeite" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
          <label class="field">
            <span>Utmark (daa)</span>
            <input id="areaUtmark" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
        </div>

        <div class="row">
          <button class="btn" id="btnSaveFarm2">Lagre</button>
        </div>

        <p class="hint">Detaljert areal, ressurser og logg ligger under “Arbeid”.</p>
      </div>
    </section>

    <section class="panel hidden" data-view="backup">
      <h1>Backup</h1>

      <div class="card">
        <h2>Eksporter</h2>
        <p class="muted">Laster ned én JSON-fil med hele gården + modulstatus + lisenser.</p>
        <button class="btn" id="btnExport">Eksporter backup</button>
      </div>

      <div class="card">
        <h2>Importer</h2>
        <p class="muted">Importer overskriver gjeldende gård i databasen.</p>
        <input id="importFile" type="file" accept="application/json" />
        <button class="btn danger" id="btnImport">Importer backup</button>
      </div>
    </section>

    <section class="panel hidden" data-view="tests">
      <h1>Selvtest</h1>

      <div class="card">
        <h2>Testpanel</h2>
        <p class="muted">Kjør alle tester eller per modul.</p>

        <label class="field" style="margin-top:10px">
          <span>Velg modul</span>
          <select id="testModuleSelect"></select>
        </label>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnRunTestsAll">Kjør alle tester</button>
          <button class="btn secondary" id="btnRunTestsModule">Kjør valgte modul</button>
        </div>

        <div id="testResults" class="results"></div>
      </div>
    </section>

    <section class="panel hidden" data-view="modules">
      <h1>Moduler</h1>

      <div class="card">
        <h2>Modulbutikk</h2>
        <p class="muted">Gratis-moduler er tilgjengelige. Betalte moduler kan låses opp per modul.</p>
        <div class="note" style="margin-top:10px">
          Demo-opplåsing: bruk kode <b>DEMO-OPEN</b>. Senere bytter vi dette til ekte betaling.
        </div>
      </div>

      <div class="card">
        <h2>Mine moduler</h2>
        <div id="modulesList"></div>
      </div>
    </section>
  </main>

  <!-- License modal -->
  <div class="overlay hidden" id="licenseOverlay">
    <div class="overlayBg" id="licenseOverlayBg"></div>
    <div class="modal">
      <h3>Lås opp modul</h3>
      <p class="muted" id="licenseModalText">—</p>

      <label class="field" style="margin-top:10px">
        <span>Aktiveringskode</span>
        <input id="licenseCodeInput" type="text" placeholder="f.eks. DEMO-..." />
      </label>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnApplyLicense">Aktiver</button>
        <button class="btn ghost" id="btnCancelLicense">Avbryt</button>
      </div>

      <p class="hint">Demo: <b>DEMO-OPEN</b> låser opp modulen.</p>
    </div>
  </div>

  <!-- Generic editor modal -->
  <div class="overlay hidden" id="editorOverlay">
    <div class="overlayBg" id="editorOverlayBg"></div>
    <div class="modal">
      <h3 id="editorTitle">Rediger</h3>
      <p class="muted" id="editorSubtitle"></p>
      <div id="editorFields"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnEditorSave">Lagre</button>
        <button class="btn ghost" id="btnEditorCancel">Avbryt</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      // =========================
      //  APP / DB BASICS
      // =========================
      const APP_VERSION = "0.4.0";
      const DB_NAME = "farmapp_db";
      const DB_VERSION = 2;
      const STORE = "documents";
      const FARM_KEY = "currentFarm";
      const LICENSE_KEY = "licenses";
      const MODULE_PREFS_KEY = "modulePrefs";

      const $ = (q) => document.querySelector(q);
      const $$ = (q) => [...document.querySelectorAll(q)];

      let state = {
        farmData: null,
        licenses: null,
        modulePrefs: null,
        licenseModalTarget: null,
        editor: { onSave: null, value: null, fields: [] }
      };

      function setStatus(text) { $("#statusLine").textContent = text; }

      function fmtDate(iso) {
        if (!iso) return "—";
        const d = new Date(iso);
        return d.toLocaleString("no-NO", { dateStyle: "medium", timeStyle: "short" });
      }

      function num(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
        }[c]));
      }

      function nowIso(){ return new Date().toISOString(); }

      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }

      async function dbGet(key) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readonly");
          const store = tx.objectStore(STORE);
          const req = store.get(key);
          req.onsuccess = () => { db.close(); resolve(req.result ?? null); };
          req.onerror = () => { db.close(); reject(req.error); };
        });
      }

      async function dbSet(key, value) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readwrite");
          const store = tx.objectStore(STORE);
          store.put(value, key);
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); reject(tx.error); };
        });
      }

      async function dbClearAll() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readwrite");
          tx.objectStore(STORE).clear();
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); reject(tx.error); };
        });
      }

      // =========================
      //  DATA MODEL (CORE)
      // =========================
      function createNewFarm() {
        const now = nowIso();
        return {
          meta: { schemaVersion: APP_VERSION, createdAt: now, updatedAt: now },
          farm: {
            id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
            name: "Min gård",
            area: { dyrketDaa: 0, beiteDaa: 0, utmarkDaa: 0 },
            modules: {}
          }
        };
      }

      function validateCore(data) {
        const errors = [];
        if (!data || typeof data !== "object") errors.push("Data mangler.");
        if (!data?.meta) errors.push("meta mangler.");
        if (!data?.farm) errors.push("farm mangler.");
        if (!data?.farm?.id) errors.push("farm.id mangler.");
        if (typeof data?.farm?.name !== "string") errors.push("farm.name må være tekst.");

        const a = data?.farm?.area;
        if (!a) errors.push("farm.area mangler.");
        for (const k of ["dyrketDaa","beiteDaa","utmarkDaa"]) {
          const v = a?.[k];
          if (typeof v !== "number" || Number.isNaN(v) || v < 0) errors.push(`farm.area.${k} må være et tall ≥ 0.`);
        }
        if (!data?.farm?.modules || typeof data.farm.modules !== "object") errors.push("farm.modules må finnes (objekt).");
        return { ok: errors.length === 0, errors };
      }

      // =========================
      //  MODULE REGISTRY
      // =========================
      const ModuleRegistry = (function(){
        const modules = [];
        function add(m){ modules.push(m); return m; }
        function list(){ return modules.slice(); }
        function get(id){ return modules.find(x => x.id === id) || null; }
        return { add, list, get };
      })();

      // =========================
      //  LICENSE + PREFS
      // =========================
      function defaultLicenses() {
        const out = {};
        for (const m of ModuleRegistry.list()) {
          out[m.id] = (m.priceModel === "free")
            ? { status: "free", updatedAt: nowIso() }
            : { status: "locked", updatedAt: nowIso() };
        }
        return out;
      }

      function defaultModulePrefs() {
        const out = {};
        for (const m of ModuleRegistry.list()) out[m.id] = { enabled: m.defaultEnabled === true };
        return out;
      }

      function licenseAllows(moduleId) {
        const lic = state.licenses?.[moduleId];
        if (!lic) return false;
        if (lic.status === "free" || lic.status === "unlocked") return true;
        if (lic.status === "trial") {
          const end = lic.trialEndsAt ? new Date(lic.trialEndsAt).getTime() : 0;
          return Date.now() <= end;
        }
        return false;
      }

      function licenseLabel(moduleId) {
        const lic = state.licenses?.[moduleId];
        if (!lic) return { cls: "locked", text: "Låst" };
        if (lic.status === "free") return { cls: "free", text: "Gratis" };
        if (lic.status === "unlocked") return { cls: "ok", text: "Låst opp" };
        if (lic.status === "trial") return { cls: "locked", text: "Prøve" };
        return { cls: "locked", text: "Låst" };
      }

      function isEnabled(moduleId) {
        const p = state.modulePrefs?.[moduleId];
        return p ? !!p.enabled : false;
      }

      async function setEnabled(moduleId, enabled) {
        if (!state.modulePrefs) state.modulePrefs = defaultModulePrefs();
        state.modulePrefs[moduleId] = { enabled: !!enabled };
        await dbSet(MODULE_PREFS_KEY, state.modulePrefs);
        ensureDataPatched();
        await saveFarm();
        renderModules();
        renderTestModuleSelect();
        renderWork();
        renderKPIs();
      }

      async function applyActivationCode(moduleId, code) {
        const c = (code || "").trim();
        if (!c) return { ok:false, msg:"Skriv inn en kode." };
        if (c === "DEMO-OPEN") {
          state.licenses[moduleId] = { status: "unlocked", updatedAt: nowIso() };
          await dbSet(LICENSE_KEY, state.licenses);
          return { ok:true, msg:"Modul låst opp (demo)." };
        }
        return { ok:false, msg:"Ugyldig kode." };
      }

      // =========================
      //  MODULES
      // =========================

      // FREE: farm core
      ModuleRegistry.add({
        id: "farm.core",
        title: "Kjerne: Gård",
        description: "Grunnmodell, lagring og basisfelt (navn/areal).",
        priceModel: "free",
        defaultEnabled: true,
        dependsOn: [],
        order: 10,
        dataPatch: (d) => {
          if (!d.farm.modules.core) d.farm.modules.core = { notes: "" };
        },
        validate: (d) => validateCore(d),
        calc: (d) => ({ ok: true }),
        ui: null,
        tests: [
          { name: "farm.core: Ny gård validerer", run: () => {
            const d = createNewFarm();
            const v = validateCore(d);
            if (!v.ok) throw new Error(v.errors.join(" | "));
          }},
          { name: "farm.core: Negativt areal feiler", run: () => {
            const d = createNewFarm();
            d.farm.area.utmarkDaa = -1;
            const v = validateCore(d);
            if (v.ok) throw new Error("Skulle feile ved negativ utmark");
          }}
        ]
      });

      // FREE: area core
      ModuleRegistry.add({
        id: "area.core",
        title: "Kjerne: Areal",
        description: "Grunnareal som kapasitet. Detaljer kommer i arealenheter/skifter.",
        priceModel: "free",
        defaultEnabled: true,
        dependsOn: ["farm.core"],
        order: 20,
        dataPatch: (d) => { if (!d.farm.modules.area) d.farm.modules.area = {}; },
        validate: () => ({ ok:true, errors:[] }),
        calc: (d) => {
          const a = d.farm.area;
          return { totalDaa: (a.dyrketDaa||0) + (a.beiteDaa||0) + (a.utmarkDaa||0) };
        },
        ui: null,
        tests: [
          { name: "area.core: totalDaa", run: () => {
            const d = createNewFarm();
            d.farm.area = { dyrketDaa: 10, beiteDaa: 2, utmarkDaa: 3 };
            const r = ModuleRegistry.get("area.core").calc(d);
            if (r.totalDaa !== 15) throw new Error("Forventet 15");
          }}
        ]
      });

      // FREE: resources core (UPGRADED with UI)
      ModuleRegistry.add({
        id: "resources.core",
        title: "Kjerne: Ressurser",
        description: "Arbeidstimer, maskiner og bygg (enkelt register).",
        priceModel: "free",
        defaultEnabled: false,
        dependsOn: ["farm.core"],
        order: 30,
        dataPatch: (d) => {
          if (!d.farm.modules.resources) d.farm.modules.resources = {
            labor:{hoursPerWeek:0},
            machines: [],
            buildings: []
          };
        },
        validate: (d) => {
          const errors = [];
          const r = d?.farm?.modules?.resources;
          if (!r) return { ok:false, errors:["resources mangler."] };
          if (typeof r.labor?.hoursPerWeek !== "number" || r.labor.hoursPerWeek < 0) errors.push("Labor hoursPerWeek må være ≥ 0.");
          if (!Array.isArray(r.machines)) errors.push("machines må være liste.");
          if (!Array.isArray(r.buildings)) errors.push("buildings må være liste.");
          return { ok: errors.length === 0, errors };
        },
        calc: (d) => {
          const r = d.farm.modules.resources;
          return {
            hoursPerWeek: r?.labor?.hoursPerWeek ?? 0,
            machines: (r?.machines || []).length,
            buildings: (r?.buildings || []).length
          };
        },
        ui: {
          render: (host, d, results, api) => {
            const r = d.farm.modules.resources;

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h2>Ressurser</h2>
              <p class="muted">Registrer kapasitet og ressurser. Senere bruker optimalisering dette som begrensning.</p>
              <div class="grid3" style="margin-top:10px">
                <label class="field">
                  <span>Arbeidstimer per uke</span>
                  <input id="resHours" type="number" min="0" step="0.5" />
                </label>
                <div class="kpi">
                  <div class="kpiLabel">Maskiner</div>
                  <div class="kpiValue">${results?.machines ?? 0}</div>
                </div>
                <div class="kpi">
                  <div class="kpiLabel">Bygg</div>
                  <div class="kpiValue">${results?.buildings ?? 0}</div>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn secondary" id="btnSaveRes">Lagre ressurser</button>
              </div>
            `;

            // Set + save hours
            const inp = card.querySelector("#resHours");
            inp.value = String(r.labor.hoursPerWeek ?? 0);
            card.querySelector("#btnSaveRes").addEventListener("click", async () => {
              r.labor.hoursPerWeek = Number(inp.value);
              await api.saveAndRefresh();
            });

            // Machines
            const machineCard = document.createElement("div");
            machineCard.className = "card";
            machineCard.innerHTML = `
              <h2>Maskiner</h2>
              <div id="machineRows"></div>
              <div class="row" style="margin-top:10px">
                <button class="btn" id="btnAddMachine">Legg til maskin</button>
                <button class="btn danger" id="btnClearMachines">Slett alle</button>
              </div>
            `;
            const mHost = machineCard.querySelector("#machineRows");
            for (let i=0;i<r.machines.length;i++){
              const m = r.machines[i];
              const row = document.createElement("div");
              row.className = "moduleRow";
              row.innerHTML = `
                <div class="moduleMeta">
                  <div class="moduleTitle">${escapeHtml(m.name || "Maskin")}</div>
                  <div class="small">${escapeHtml(m.type || "type?")} · ${escapeHtml(m.note || "")}</div>
                </div>
                <div class="moduleRight">
                  <div class="moduleActions">
                    <button class="btn secondary" data-act="edit">Rediger</button>
                    <button class="btn danger" data-act="del">Slett</button>
                  </div>
                </div>
              `;
              row.querySelector('[data-act="del"]').addEventListener("click", async () => {
                if (!confirm("Slette maskinen?")) return;
                r.machines.splice(i,1);
                await api.saveAndRefresh();
              });
              row.querySelector('[data-act="edit"]').addEventListener("click", () => {
                api.openEditor({
                  title: "Rediger maskin",
                  subtitle: "Enkelt register. Service/vedlikehold kommer senere.",
                  fields: [
                    { key:"name", label:"Navn", type:"text" },
                    { key:"type", label:"Type", type:"text" },
                    { key:"note", label:"Merknad", type:"text" }
                  ],
                  value: m,
                  onSave: async (nv) => {
                    r.machines[i] = { ...m, ...nv };
                    await api.saveAndRefresh();
                  }
                });
              });
              mHost.appendChild(row);
            }
            machineCard.querySelector("#btnAddMachine").addEventListener("click", async () => {
              r.machines.push({
                id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
                name: `Maskin ${r.machines.length+1}`,
                type: "Traktor / Redskap / Annet",
                note: ""
              });
              await api.saveAndRefresh();
            });
            machineCard.querySelector("#btnClearMachines").addEventListener("click", async () => {
              if (!confirm("Slette alle maskiner?")) return;
              r.machines = [];
              await api.saveAndRefresh();
            });

            // Buildings
            const bCard = document.createElement("div");
            bCard.className = "card";
            bCard.innerHTML = `
              <h2>Bygg</h2>
              <div id="buildingRows"></div>
              <div class="row" style="margin-top:10px">
                <button class="btn" id="btnAddBuilding">Legg til bygg</button>
                <button class="btn danger" id="btnClearBuildings">Slett alle</button>
              </div>
            `;
            const bHost = bCard.querySelector("#buildingRows");
            for (let i=0;i<r.buildings.length;i++){
              const b = r.buildings[i];
              const row = document.createElement("div");
              row.className = "moduleRow";
              row.innerHTML = `
                <div class="moduleMeta">
                  <div class="moduleTitle">${escapeHtml(b.name || "Bygg")}</div>
                  <div class="small">${escapeHtml(b.type || "type?")} · ${escapeHtml(b.note || "")}</div>
                </div>
                <div class="moduleRight">
                  <div class="moduleActions">
                    <button class="btn secondary" data-act="edit">Rediger</button>
                    <button class="btn danger" data-act="del">Slett</button>
                  </div>
                </div>
              `;
              row.querySelector('[data-act="del"]').addEventListener("click", async () => {
                if (!confirm("Slette bygget?")) return;
                r.buildings.splice(i,1);
                await api.saveAndRefresh();
              });
              row.querySelector('[data-act="edit"]').addEventListener("click", () => {
                api.openEditor({
                  title: "Rediger bygg",
                  subtitle: "Enkelt register. Kapasitet/energibruk kan legges på senere.",
                  fields: [
                    { key:"name", label:"Navn", type:"text" },
                    { key:"type", label:"Type", type:"text" },
                    { key:"note", label:"Merknad", type:"text" }
                  ],
                  value: b,
                  onSave: async (nv) => {
                    r.buildings[i] = { ...b, ...nv };
                    await api.saveAndRefresh();
                  }
                });
              });
              bHost.appendChild(row);
            }
            bCard.querySelector("#btnAddBuilding").addEventListener("click", async () => {
              r.buildings.push({
                id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
                name: `Bygg ${r.buildings.length+1}`,
                type: "Fjøs / Lager / Annet",
                note: ""
              });
              await api.saveAndRefresh();
            });
            bCard.querySelector("#btnClearBuildings").addEventListener("click", async () => {
              if (!confirm("Slette alle bygg?")) return;
              r.buildings = [];
              await api.saveAndRefresh();
            });

            host.appendChild(card);
            host.appendChild(machineCard);
            host.appendChild(bCard);
          }
        },
        tests: [
          { name: "resources.core: dataPatch", run: () => {
            const d = createNewFarm();
            ModuleRegistry.get("resources.core").dataPatch(d);
            if (!d.farm.modules.resources?.labor) throw new Error("Mangler labor");
          }},
          { name: "resources.core: validate hours >= 0", run: () => {
            const d = createNewFarm();
            ModuleRegistry.get("resources.core").dataPatch(d);
            d.farm.modules.resources.labor.hoursPerWeek = -1;
            const v = ModuleRegistry.get("resources.core").validate(d);
            if (v.ok) throw new Error("Skulle feile ved negative timer");
          }}
        ]
      });

      // FREE: log module (universal)
      ModuleRegistry.add({
        id: "log.core",
        title: "Logg: Hendelser",
        description: "Universell hendelseslogg for drift, vedlikehold, avvik, notater osv.",
        priceModel: "free",
        defaultEnabled: false,
        dependsOn: ["farm.core"],
        order: 40,
        dataPatch: (d) => {
          if (!d.farm.modules.log) d.farm.modules.log = { entries: [] };
        },
        validate: (d) => {
          const errors = [];
          const log = d?.farm?.modules?.log;
          if (!log || !Array.isArray(log.entries)) return { ok:false, errors:["log.entries må finnes (liste)."] };
          for (let i=0;i<log.entries.length;i++){
            const e = log.entries[i];
            if (!e?.id) errors.push(`Entry ${i+1}: id mangler.`);
            if (!e?.date) errors.push(`Entry ${i+1}: dato mangler.`);
            if (typeof e?.category !== "string") errors.push(`Entry ${i+1}: kategori må være tekst.`);
            if (typeof e?.text !== "string" || !e.text.trim()) errors.push(`Entry ${i+1}: tekst mangler.`);
          }
          return { ok: errors.length===0, errors };
        },
        calc: (d) => {
          const n = d.farm.modules.log?.entries?.length ?? 0;
          return { count: n };
        },
        ui: {
          render: (host, d, results, api) => {
            const log = d.farm.modules.log;
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h2>Hendelseslogg</h2>
              <p class="muted">Legg inn hva som er gjort, når og hvorfor. Dette kan brukes til rapporter senere.</p>
              <div class="grid2" style="margin-top:10px">
                <div class="kpi"><div class="kpiLabel">Antall poster</div><div class="kpiValue">${results?.count ?? 0}</div></div>
                <div class="note">Tips: Bruk kategorier som “Vedlikehold”, “Sprøyting”, “Slått”, “Avvik”, “Notat”.</div>
              </div>
            `;

            const list = document.createElement("div");
            list.className = "card";
            list.innerHTML = `<h2>Poster</h2><div id="logRows"></div>`;
            const rowsHost = list.querySelector("#logRows");

            const btnRow = document.createElement("div");
            btnRow.className = "row";
            btnRow.style.marginTop = "10px";

            const btnAdd = document.createElement("button");
            btnAdd.className = "btn";
            btnAdd.textContent = "Ny loggpost";
            btnAdd.addEventListener("click", async () => {
              log.entries.unshift({
                id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
                date: nowIso().slice(0,10),
                category: "Notat",
                text: ""
              });
              // open editor right away
              api.openEditor({
                title: "Ny loggpost",
                subtitle: "Skriv kort og konkret.",
                fields: [
                  { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
                  { key:"category", label:"Kategori", type:"text" },
                  { key:"text", label:"Tekst", type:"text" }
                ],
                value: log.entries[0],
                onSave: async (nv) => {
                  log.entries[0] = { ...log.entries[0], ...nv };
                  await api.saveAndRefresh();
                }
              });
              await api.saveAndRefresh();
            });

            const btnClear = document.createElement("button");
            btnClear.className = "btn danger";
            btnClear.textContent = "Slett alle";
            btnClear.addEventListener("click", async () => {
              if (!confirm("Slette alle loggposter?")) return;
              log.entries = [];
              await api.saveAndRefresh();
            });

            btnRow.appendChild(btnAdd);
            btnRow.appendChild(btnClear);
            list.appendChild(btnRow);

            for (let i=0;i<log.entries.length;i++){
              const e = log.entries[i];
              const row = document.createElement("div");
              row.className = "moduleRow";
              row.innerHTML = `
                <div class="moduleMeta">
                  <div class="moduleTitle">${escapeHtml(e.category || "Logg")}</div>
                  <div class="small">${escapeHtml(e.date || "")}</div>
                  <div class="moduleDesc">${escapeHtml((e.text||"").slice(0,120))}${(e.text||"").length>120?"…":""}</div>
                </div>
                <div class="moduleRight">
                  <div class="moduleActions">
                    <button class="btn secondary" data-act="edit">Rediger</button>
                    <button class="btn danger" data-act="del">Slett</button>
                  </div>
                </div>
              `;
              row.querySelector('[data-act="del"]').addEventListener("click", async () => {
                if (!confirm("Slette denne posten?")) return;
                log.entries.splice(i,1);
                await api.saveAndRefresh();
              });
              row.querySelector('[data-act="edit"]').addEventListener("click", () => {
                api.openEditor({
                  title: "Rediger loggpost",
                  subtitle: "Dato, kategori og tekst.",
                  fields: [
                    { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
                    { key:"category", label:"Kategori", type:"text" },
                    { key:"text", label:"Tekst", type:"text" }
                  ],
                  value: e,
                  onSave: async (nv) => {
                    log.entries[i] = { ...e, ...nv };
                    await api.saveAndRefresh();
                  }
                });
              });
              rowsHost.appendChild(row);
            }

            host.appendChild(card);
            host.appendChild(list);
          }
        },
        tests: [
          { name: "log.core: dataPatch lager entries[]", run: () => {
            const d = createNewFarm();
            ModuleRegistry.get("log.core").dataPatch(d);
            if (!Array.isArray(d.farm.modules.log.entries)) throw new Error("Mangler log.entries[]");
          }},
          { name: "log.core: validate feiler uten tekst", run: () => {
            const d = createNewFarm();
            ModuleRegistry.get("log.core").dataPatch(d);
            d.farm.modules.log.entries = [{ id:"1", date:"2026-01-01", category:"Notat", text:"" }];
            const v = ModuleRegistry.get("log.core").validate(d);
            if (v.ok) throw new Error("Skulle feile uten tekst");
          }}
        ]
      });

      // PAID: area units (skifter)
      ModuleRegistry.add({
        id: "area.units",
        title: "Areal: Arealenheter / skifter",
        description: "Detaljert arealstyring: skifter, beiteområder, utmark, veksthus osv. Summering og kontroll.",
        priceModel: "paid",
        defaultEnabled: false,
        dependsOn: ["farm.core","area.core"],
        order: 50,
        dataPatch: (d) => {
          if (!d.farm.modules.areaUnits) d.farm.modules.areaUnits = { units: [] };
        },
        validate: (d) => {
          const errors = [];
          const mod = d?.farm?.modules?.areaUnits;
          if (!mod || !Array.isArray(mod.units)) return { ok:false, errors:["farm.modules.areaUnits.units må finnes (liste)."] };

          const allowedTypes = ["dyrket","innmarksbeite","utmark","veksthus","fruktbær","annet"];
          const allowedUse = ["slått","beite","kombinert","brakklagt","annet"];
          const allowedQuality = ["svært_god","god","middels","svak","ukjent"];

          for (let i=0;i<mod.units.length;i++){
            const u = mod.units[i];
            if (!u?.id) errors.push(`Enhet ${i+1}: id mangler.`);
            if (typeof u?.name !== "string" || !u.name.trim()) errors.push(`Enhet ${i+1}: navn mangler.`);
            if (!allowedTypes.includes(u.type)) errors.push(`Enhet ${i+1}: ugyldig type.`);
            if (typeof u.areaDaa !== "number" || Number.isNaN(u.areaDaa) || u.areaDaa <= 0) errors.push(`Enhet ${i+1}: areal (daa) må være > 0.`);
            if (!allowedQuality.includes(u.quality)) errors.push(`Enhet ${i+1}: ugyldig kvalitet.`);
            if (!allowedUse.includes(u.use)) errors.push(`Enhet ${i+1}: ugyldig bruk.`);
          }
          return { ok: errors.length === 0, errors };
        },
        calc: (d) => {
          const mod = d.farm.modules.areaUnits;
          const sums = { dyrket:0, innmarksbeite:0, utmark:0, veksthus:0, fruktbær:0, annet:0, total:0 };

          for (const u of (mod?.units || [])) {
            const a = (u && typeof u.areaDaa === "number") ? u.areaDaa : 0;
            sums.total += a;
            if (u?.type && sums[u.type] != null) sums[u.type] += a;
            else sums.annet += a;
          }

          const base = d.farm.area || { dyrketDaa:0, beiteDaa:0, utmarkDaa:0 };
          const deltas = {
            dyrket: sums.dyrket - (base.dyrketDaa||0),
            innmarksbeite: sums.innmarksbeite - (base.beiteDaa||0),
            utmark: sums.utmark - (base.utmarkDaa||0)
          };
          return { sums, deltas };
        },
        ui: {
          render: (host, d, results, api) => {
            const mod = d.farm.modules.areaUnits;

            const header = document.createElement("div");
            header.className = "card";
            header.innerHTML = `
              <h2>Arealenheter / skifter</h2>
              <p class="muted">Legg inn skifter/beiteområder med type, areal, kvalitet og bruk. Appen summerer og sjekker mot grunnareal.</p>
            `;

            const sums = results?.sums || {};
            const deltas = results?.deltas || {};
            const kpi = document.createElement("div");
            kpi.className = "card";
            kpi.innerHTML = `
              <h2>Oppsummering</h2>
              <div class="grid2">
                <div class="kpi"><div class="kpiLabel">Sum enheter (daa)</div><div class="kpiValue">${(sums.total||0).toFixed(1)}</div></div>
                <div class="kpi"><div class="kpiLabel">Dyrket (daa)</div><div class="kpiValue">${(sums.dyrket||0).toFixed(1)}</div></div>
                <div class="kpi"><div class="kpiLabel">Innmarksbeite (daa)</div><div class="kpiValue">${(sums.innmarksbeite||0).toFixed(1)}</div></div>
                <div class="kpi"><div class="kpiLabel">Utmark (daa)</div><div class="kpiValue">${(sums.utmark||0).toFixed(1)}</div></div>
              </div>
              <div class="small" style="margin-top:10px">
                Avvik mot grunnareal: Dyrket ${fmtDelta(deltas.dyrket)} / Innmarksbeite ${fmtDelta(deltas.innmarksbeite)} / Utmark ${fmtDelta(deltas.utmark)}
              </div>
            `;

            const list = document.createElement("div");
            list.className = "card";
            list.innerHTML = `<h2>Enheter</h2><div id="areaUnitsRows"></div>`;
            const rowsHost = list.querySelector("#areaUnitsRows");

            const btnRow = document.createElement("div");
            btnRow.className = "row";
            btnRow.style.marginTop = "10px";

            const btnAdd = document.createElement("button");
            btnAdd.className = "btn";
            btnAdd.textContent = "Legg til enhet";
            btnAdd.addEventListener("click", async () => {
              mod.units.push({
                id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
                name: `Enhet ${mod.units.length + 1}`,
                type: "dyrket",
                areaDaa: 1,
                quality: "ukjent",
                use: "annet",
                note: ""
              });
              await api.saveAndRefresh();
            });

            const btnClear = document.createElement("button");
            btnClear.className = "btn danger";
            btnClear.textContent = "Slett alle";
            btnClear.addEventListener("click", async () => {
              if (!confirm("Slette alle arealenheter?")) return;
              mod.units = [];
              await api.saveAndRefresh();
            });

            btnRow.appendChild(btnAdd);
            btnRow.appendChild(btnClear);
            list.appendChild(btnRow);

            for (let i=0;i<mod.units.length;i++){
              const u = mod.units[i];
              const row = document.createElement("div");
              row.className = "moduleRow";
              row.innerHTML = `
                <div class="moduleMeta">
                  <div class="moduleTitle">${escapeHtml(u.name || `Enhet ${i+1}`)}</div>
                  <div class="moduleDesc">Type: ${escapeHtml(u.type)} · ${Number(u.areaDaa||0).toFixed(1)} daa</div>
                  <div class="small">Kvalitet: ${escapeHtml(u.quality)} · Bruk: ${escapeHtml(u.use)}</div>
                </div>
                <div class="moduleRight">
                  <div class="moduleActions">
                    <button class="btn secondary" data-act="edit">Rediger</button>
                    <button class="btn danger" data-act="del">Slett</button>
                  </div>
                </div>
              `;

              row.querySelector('[data-act="del"]').addEventListener("click", async () => {
                if (!confirm("Slette denne enheten?")) return;
                mod.units.splice(i, 1);
                await api.saveAndRefresh();
              });

              row.querySelector('[data-act="edit"]').addEventListener("click", () => {
                api.openEditor({
                  title: "Rediger arealenhet",
                  subtitle: "Endringer lagres lokalt på telefonen.",
                  fields: [
                    { key:"name", label:"Navn", type:"text" },
                    { key:"type", label:"Type", type:"select", options:[
                      ["dyrket","Dyrket"],["innmarksbeite","Innmarksbeite"],["utmark","Utmark"],["veksthus","Veksthus"],["fruktbær","Frukt/bær"],["annet","Annet"]
                    ]},
                    { key:"areaDaa", label:"Areal (daa)", type:"number" },
                    { key:"quality", label:"Kvalitet", type:"select", options:[
                      ["svært_god","Svært god"],["god","God"],["middels","Middels"],["svak","Svak"],["ukjent","Ukjent"]
                    ]},
                    { key:"use", label:"Bruk", type:"select", options:[
                      ["slått","Slått"],["beite","Beite"],["kombinert","Kombinert"],["brakklagt","Brakklagt"],["annet","Annet"]
                    ]},
                    { key:"note", label:"Merknad", type:"text" }
                  ],
                  value: u,
                  onSave: async (newVal) => {
                    newVal.areaDaa = Number(newVal.areaDaa);
                    mod.units[i] = newVal;
                    await api.saveAndRefresh();
                  }
                });
              });

              rowsHost.appendChild(row);
            }

            host.appendChild(header);
            host.appendChild(kpi);
            host.appendChild(list);

            function fmtDelta(x){
              const n = Number(x||0);
              const s = (n>=0?"+":"") + n.toFixed(1);
              return `<span>${s}</span>`;
            }
          }
        },
        tests: [
          { name: "area.units: dataPatch lager struktur", run: () => {
            const d = createNewFarm();
            ModuleRegistry.get("area.units").dataPatch(d);
            if (!d.farm.modules.areaUnits || !Array.isArray(d.farm.modules.areaUnits.units)) throw new Error("Mangler units[]");
          }},
          { name: "area.units: summering total", run: () => {
            const d = createNewFarm();
            ModuleRegistry.get("area.units").dataPatch(d);
            d.farm.modules.areaUnits.units = [
              {id:"1",name:"A",type:"dyrket",areaDaa:10,quality:"ukjent",use:"annet",note:""},
              {id:"2",name:"B",type:"utmark",areaDaa:5,quality:"ukjent",use:"annet",note:""}
            ];
            const r = ModuleRegistry.get("area.units").calc(d);
            if (r.sums.total !== 15) throw new Error("Forventet total 15");
          }}
        ]
      });

      // PAID: productions profiles (universal)
      ModuleRegistry.add({
        id: "productions.core",
        title: "Produksjonsprofiler",
        description: "Aktiver hva gården driver med (korn, melk, grønt, frukt/bær, svin, fjørfe, foredling osv.).",
        priceModel: "paid",
        defaultEnabled: false,
        dependsOn: ["farm.core"],
        order: 60,
        dataPatch: (d) => {
          if (!d.farm.modules.productions) d.farm.modules.productions = { active: [], settings: {} };
        },
        validate: (d) => {
          const p = d?.farm?.modules?.productions;
          if (!p || !Array.isArray(p.active)) return { ok:false, errors:["productions.active må være liste."] };
          return { ok:true, errors:[] };
        },
        calc: (d) => ({ active: d.farm.modules.productions?.active || [] }),
        ui: {
          render: (host, d, results, api) => {
            const p = d.farm.modules.productions;
            const catalog = [
              { id:"korn", name:"Korn" },
              { id:"grovfor", name:"Grovfôr" },
              { id:"melk", name:"Melk" },
              { id:"kjott", name:"Kjøtt" },
              { id:"gronnsaker", name:"Grønnsaker" },
              { id:"fruktbaer", name:"Frukt/bær" },
              { id:"svin", name:"Svin" },
              { id:"fjorfe", name:"Fjørfe" },
              { id:"foredling", name:"Foredling" }
            ];

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h2>Produksjonsprofiler</h2>
              <p class="muted">Velg hvilke produksjoner som er relevante. Dette styrer hva appen viser senere.</p>
              <div class="small">Aktive: <b>${(results?.active || []).length}</b></div>
            `;

            const list = document.createElement("div");
            list.className = "card";
            list.innerHTML = `<h2>Velg produksjoner</h2><div id="prodRows"></div>`;
            const rows = list.querySelector("#prodRows");

            for (const item of catalog) {
              const on = (p.active || []).includes(item.id);
              const row = document.createElement("div");
              row.className = "moduleRow";
              row.innerHTML = `
                <div class="moduleMeta">
                  <div class="moduleTitle">${escapeHtml(item.name)}</div>
                  <div class="small">${escapeHtml(item.id)}</div>
                </div>
                <div class="moduleRight">
                  <div class="moduleActions">
                    <button class="btn ${on ? "secondary" : ""}" data-act="toggle">${on ? "Deaktiver" : "Aktiver"}</button>
                  </div>
                </div>
              `;
              row.querySelector('[data-act="toggle"]').addEventListener("click", async () => {
                const idx = p.active.indexOf(item.id);
                if (idx >= 0) p.active.splice(idx,1);
                else p.active.push(item.id);
                await api.saveAndRefresh();
              });
              rows.appendChild(row);
            }

            host.appendChild(card);
            host.appendChild(list);
          }
        },
        tests: [
          { name: "productions.core: dataPatch", run: () => {
            const d = createNewFarm();
            ModuleRegistry.get("productions.core").dataPatch(d);
            if (!Array.isArray(d.farm.modules.productions.active)) throw new Error("Mangler active[]");
          }}
        ]
      });

      // =========================
      //  ROUTING / UI HELPERS
      // =========================
      function routeTo(route) {
        $$("#tabs .tab").forEach(b => b.classList.toggle("active", b.dataset.route === route));
        $$("[data-view]").forEach(v => v.classList.toggle("hidden", v.dataset.view !== route));
      }

      function openLicenseModal(moduleId) {
        state.licenseModalTarget = moduleId;
        const m = ModuleRegistry.get(moduleId);
        const label = licenseLabel(moduleId);
        $("#licenseModalText").innerHTML = `
          <div><b>${escapeHtml(m.title)}</b></div>
          <div class="small">Status: <span class="badge ${label.cls}">${escapeHtml(label.text)}</span></div>
        `;
        $("#licenseCodeInput").value = "";
        $("#licenseOverlay").classList.remove("hidden");
      }
      function closeLicenseModal() {
        state.licenseModalTarget = null;
        $("#licenseOverlay").classList.add("hidden");
      }

      function openEditor(cfg) {
        state.editor.onSave = cfg.onSave || null;
        state.editor.value = JSON.parse(JSON.stringify(cfg.value || {}));
        state.editor.fields = cfg.fields || [];

        $("#editorTitle").textContent = cfg.title || "Rediger";
        $("#editorSubtitle").textContent = cfg.subtitle || "";
        const host = $("#editorFields");
        host.innerHTML = "";

        for (const f of state.editor.fields) {
          const wrap = document.createElement("label");
          wrap.className = "field";
          const label = document.createElement("span");
          label.textContent = f.label;
          wrap.appendChild(label);

          let input;
          if (f.type === "select") {
            input = document.createElement("select");
            for (const [val, txt] of f.options || []) {
              const opt = document.createElement("option");
              opt.value = val;
              opt.textContent = txt;
              input.appendChild(opt);
            }
            input.value = state.editor.value[f.key] ?? (f.options?.[0]?.[0] ?? "");
          } else {
            input = document.createElement("input");
            input.type = f.type === "number" ? "number" : "text";
            input.value = (state.editor.value[f.key] ?? "");
          }

          input.addEventListener("change", () => {
            state.editor.value[f.key] = (f.type === "number") ? Number(input.value) : input.value;
          });

          wrap.appendChild(input);
          host.appendChild(wrap);
        }

        $("#editorOverlay").classList.remove("hidden");
      }
      function closeEditor() {
        $("#editorOverlay").classList.add("hidden");
        state.editor.onSave = null;
        state.editor.value = null;
        state.editor.fields = [];
      }

      // =========================
      //  DATA PATCHING & VALIDATION
      // =========================
      function ensureDataPatched() {
        const d = state.farmData;
        if (!d) return;
        for (const m of ModuleRegistry.list()) {
          const enabled = isEnabled(m.id);
          const allowed = licenseAllows(m.id) || m.priceModel === "free";
          if (enabled && allowed && typeof m.dataPatch === "function") m.dataPatch(d);
        }
      }

      // =========================
      //  SAVE / RESET / BACKUP
      // =========================
      function syncFarmToForm() {
        const d = state.farmData;
        if (!d) return;
        $("#farmName").value = d.farm.name ?? "";
        $("#areaDyrket").value = d.farm.area.dyrketDaa ?? 0;
        $("#areaBeite").value = d.farm.area.beiteDaa ?? 0;
        $("#areaUtmark").value = d.farm.area.utmarkDaa ?? 0;
      }

      function syncFormToFarm() {
        const d = state.farmData;
        if (!d) return;
        d.farm.name = ($("#farmName").value || "").trim() || "Min gård";
        d.farm.area.dyrketDaa = num($("#areaDyrket").value);
        d.farm.area.beiteDaa  = num($("#areaBeite").value);
        d.farm.area.utmarkDaa = num($("#areaUtmark").value);
        d.meta.updatedAt = nowIso();
      }

      function renderKPIs() {
        const d = state.farmData;
        if (!d) return;

        const areaTotal = (d.farm.area.dyrketDaa||0) + (d.farm.area.beiteDaa||0) + (d.farm.area.utmarkDaa||0);
        const enabledCount = Object.values(state.modulePrefs || {}).filter(x => x?.enabled).length;
        const logCount = d.farm.modules.log?.entries?.length ?? 0;
        const prodCount = d.farm.modules.productions?.active?.length ?? 0;

        $("#kpiFarmName").textContent = d.farm.name ?? "—";
        $("#kpiUpdatedAt").textContent = fmtDate(d.meta.updatedAt);
        $("#kpiTotalDaa").textContent = String(areaTotal);
        $("#kpiEnabledModules").textContent = String(enabledCount);
        $("#kpiLogCount").textContent = String(logCount);
        $("#kpiProdCount").textContent = String(prodCount);
      }

      async function saveFarm() {
        if (!state.farmData) return;
        syncFormToFarm();
        ensureDataPatched();

        const errors = [];
        for (const m of ModuleRegistry.list()) {
          if (!isEnabled(m.id)) continue;
          if (!(licenseAllows(m.id) || m.priceModel === "free")) continue;
          if (typeof m.validate === "function") {
            const v = m.validate(state.farmData);
            if (!v?.ok && v?.errors?.length) errors.push(...v.errors.map(e => `${m.id}: ${e}`));
          }
        }
        if (errors.length) { alert("Kan ikke lagre:\n\n" + errors.join("\n")); return; }

        await dbSet(FARM_KEY, state.farmData);
        setStatus("Lagret ✅");
        renderKPIs();
      }

      async function resetFarm() {
        await dbClearAll();
        state.farmData = createNewFarm();
        state.licenses = defaultLicenses();
        state.modulePrefs = defaultModulePrefs();

        // Always enable core
        state.modulePrefs["farm.core"] = { enabled: true };
        state.modulePrefs["area.core"] = { enabled: true };

        ensureDataPatched();

        await dbSet(FARM_KEY, state.farmData);
        await dbSet(LICENSE_KEY, state.licenses);
        await dbSet(MODULE_PREFS_KEY, state.modulePrefs);

        syncFarmToForm();
        renderModules();
        renderTestModuleSelect();
        renderWork();
        renderKPIs();
        setStatus("Ny gård opprettet ✅");
      }

      function downloadJSON(filename, obj) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function exportBackup() {
        if (!state.farmData) return;
        const payload = {
          exportedAt: nowIso(),
          appVersion: APP_VERSION,
          farm: state.farmData,
          licenses: state.licenses,
          modulePrefs: state.modulePrefs
        };
        const safeName = (state.farmData.farm.name || "farm").toLowerCase().replace(/[^a-z0-9]+/g, "-");
        downloadJSON(`${safeName}-backup.json`, payload);
        setStatus("Backup eksportert ✅");
      }

      async function importBackup() {
        const input = $("#importFile");
        const file = input.files?.[0];
        if (!file) { alert("Velg en backup-fil først."); return; }
        const text = await file.text();
        let parsed;
        try { parsed = JSON.parse(text); } catch { alert("Ugyldig JSON-fil."); return; }

        const farm = parsed?.farm ?? parsed?.data ?? parsed;
        const licenses = parsed?.licenses ?? null;
        const modulePrefs = parsed?.modulePrefs ?? null;

        const v = validateCore(farm);
        if (!v.ok) { alert("Import stoppet:\n\n" + v.errors.join("\n")); return; }

        state.farmData = farm;
        state.farmData.meta.updatedAt = nowIso();
        state.licenses = (licenses && typeof licenses === "object") ? licenses : defaultLicenses();
        state.modulePrefs = (modulePrefs && typeof modulePrefs === "object") ? modulePrefs : defaultModulePrefs();

        state.modulePrefs["farm.core"] = { enabled: true };
        state.modulePrefs["area.core"] = { enabled: true };

        ensureDataPatched();

        await dbSet(FARM_KEY, state.farmData);
        await dbSet(LICENSE_KEY, state.licenses);
        await dbSet(MODULE_PREFS_KEY, state.modulePrefs);

        syncFarmToForm();
        renderModules();
        renderTestModuleSelect();
        renderWork();
        renderKPIs();
        setStatus("Importert ✅");
        input.value = "";
      }

      // =========================
      //  MODULE STORE UI
      // =========================
      function priceText(m) {
        if (m.priceModel === "free") return "Gratis";
        if (m.priceModel === "paid") return "Engangskjøp";
        if (m.priceModel === "subscription") return "Abonnement";
        return "—";
      }

      function renderModules() {
        const host = $("#modulesList");
        host.innerHTML = "";

        const sorted = ModuleRegistry.list().slice().sort((a,b) => (a.order||999)-(b.order||999));

        for (const m of sorted) {
          const lic = licenseLabel(m.id);
          const enabled = isEnabled(m.id);
          const allowed = licenseAllows(m.id) || m.priceModel === "free";
          const deps = (m.dependsOn || []).join(", ");

          const row = document.createElement("div");
          row.className = "moduleRow";

          const left = document.createElement("div");
          left.className = "moduleMeta";
          left.innerHTML = `
            <div class="moduleTitle">${escapeHtml(m.title)}</div>
            <div class="moduleDesc">${escapeHtml(m.description)}</div>
            <div class="small">
              <span class="pill">ID: ${escapeHtml(m.id)}</span>
              <span class="pill">Pris: ${escapeHtml(priceText(m))}</span>
              ${deps ? `<span class="pill">Avhengig av: ${escapeHtml(deps)}</span>` : ``}
            </div>
          `;

          const right = document.createElement("div");
          right.className = "moduleRight";

          const topBadges = document.createElement("div");
          topBadges.innerHTML = `
            <span class="badge ${lic.cls}">${escapeHtml(lic.text)}</span>
            <span class="badge ${enabled ? "on" : "off"}">${enabled ? "På" : "Av"}</span>
          `;

          const actions = document.createElement("div");
          actions.className = "moduleActions";

          const btnToggle = document.createElement("button");
          btnToggle.className = "btn secondary";
          btnToggle.textContent = enabled ? "Skru av" : "Skru på";
          btnToggle.disabled = !allowed;
          btnToggle.addEventListener("click", async () => {
            if (!enabled) {
              const deps = m.dependsOn || [];
              const missing = deps.filter(d => {
                const dep = ModuleRegistry.get(d);
                const depAllowed = licenseAllows(d) || dep?.priceModel === "free";
                return !isEnabled(d) || !depAllowed;
              });
              if (missing.length) {
                alert("Kan ikke slå på. Mangler/er låst:\n\n" + missing.join("\n"));
                return;
              }
            }
            await setEnabled(m.id, !enabled);
          });

          const btnUnlock = document.createElement("button");
          btnUnlock.className = "btn";
          btnUnlock.textContent = allowed ? "Administrer" : "Lås opp";
          btnUnlock.addEventListener("click", () => openLicenseModal(m.id));

          actions.appendChild(btnToggle);
          actions.appendChild(btnUnlock);

          right.appendChild(topBadges);
          right.appendChild(actions);

          row.appendChild(left);
          row.appendChild(right);
          host.appendChild(row);
        }
      }

      // =========================
      //  WORKBENCH
      // =========================
      function renderWork() {
        const host = $("#workHost");
        host.innerHTML = "";

        const enabledModules = ModuleRegistry.list()
          .filter(m => isEnabled(m.id))
          .slice()
          .sort((a,b) => (a.order||999)-(b.order||999));

        if (!enabledModules.length) {
          const c = document.createElement("div");
          c.className = "card";
          c.innerHTML = `<h2>Ingen aktive moduler</h2><p class="muted">Gå til “Moduler” og skru på ønskede moduler.</p>`;
          host.appendChild(c);
          return;
        }

        const api = {
          saveAndRefresh: async () => {
            await saveFarm();
            renderWork();
            renderKPIs();
          },
          openEditor
        };

        for (const m of enabledModules) {
          const allowed = licenseAllows(m.id) || m.priceModel === "free";

          if (allowed && typeof m.dataPatch === "function") m.dataPatch(state.farmData);

          let results = null;
          if (allowed && typeof m.calc === "function") {
            try { results = m.calc(state.farmData); } catch { results = null; }
          }

          const wrap = document.createElement("div");
          wrap.className = "card";
          const lic = licenseLabel(m.id);

          wrap.innerHTML = `
            <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between">
              <div style="min-width:0">
                <h2 style="margin:0 0 6px">${escapeHtml(m.title)}</h2>
                <div class="small">${escapeHtml(m.id)} · <span class="badge ${lic.cls}">${escapeHtml(lic.text)}</span></div>
              </div>
              <div class="row">
                ${allowed ? "" : `<button class="btn" data-unlock> Lås opp </button>`}
              </div>
            </div>
            <div data-body></div>
          `;

          const body = wrap.querySelector("[data-body]");
          if (!allowed) {
            body.innerHTML = `<p class="muted">Denne modulen er låst. Lås opp for å bruke den.</p>`;
            wrap.querySelector("[data-unlock]").addEventListener("click", () => openLicenseModal(m.id));
          } else if (m.ui && typeof m.ui.render === "function") {
            m.ui.render(body, state.farmData, results, api);
          } else {
            body.innerHTML = `<p class="muted">Ingen UI i denne modulen ennå.</p>`;
          }

          host.appendChild(wrap);
        }
      }

      // =========================
      //  TEST RUNNER
      // =========================
      function getTestCasesFor(moduleIdOrAll) {
        const list = [];
        for (const m of ModuleRegistry.list()) {
          if (moduleIdOrAll !== "ALL" && m.id !== moduleIdOrAll) continue;
          for (const t of (m.tests || [])) list.push({ moduleId: m.id, name: t.name, run: t.run });
        }
        return list;
      }

      function renderTestResults(results) {
        const host = $("#testResults");
        host.innerHTML = "";
        for (const r of results) {
          const div = document.createElement("div");
          div.className = "resultItem";
          const badge = `<span class="badge ${r.ok ? "ok" : "fail"}">${r.ok ? "OK" : "FEIL"}</span>`;
          div.innerHTML = `
            <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
              <div style="font-weight:900; min-width:0">
                <div>${escapeHtml(r.name)}</div>
                <div class="small">Modul: ${escapeHtml(r.moduleId)}</div>
              </div>
              ${badge}
            </div>
            ${r.ok ? "" : `<div class="small">${escapeHtml(r.error)}</div>`}
          `;
          host.appendChild(div);
        }
      }

      function runTests(moduleIdOrAll) {
        const cases = getTestCasesFor(moduleIdOrAll);
        const results = [];
        for (const t of cases) {
          try { t.run(); results.push({ moduleId: t.moduleId, name: t.name, ok: true }); }
          catch (e) { results.push({ moduleId: t.moduleId, name: t.name, ok: false, error: e?.message ?? String(e) }); }
        }
        renderTestResults(results);
        const okCount = results.filter(r => r.ok).length;
        setStatus(`Tester: ${okCount}/${results.length} OK`);
      }

      function renderTestModuleSelect() {
        const sel = $("#testModuleSelect");
        sel.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "ALL";
        optAll.textContent = "Alle moduler";
        sel.appendChild(optAll);

        const sorted = ModuleRegistry.list().slice().sort((a,b) => (a.order||999)-(b.order||999));
        for (const m of sorted) {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = `${m.title} (${m.id})`;
          sel.appendChild(opt);
        }
      }

      // =========================
      //  LOAD / INIT
      // =========================
      async function loadOrCreate() {
        setStatus("Laster data…");

        const farm = await dbGet(FARM_KEY);
        const lic = await dbGet(LICENSE_KEY);
        const prefs = await dbGet(MODULE_PREFS_KEY);

        state.farmData = farm || createNewFarm();
        state.licenses = lic || defaultLicenses();
        state.modulePrefs = prefs || defaultModulePrefs();

        // Always enable core
        state.modulePrefs["farm.core"] = { enabled: true };
        state.modulePrefs["area.core"] = { enabled: true };

        ensureDataPatched();

        const v = validateCore(state.farmData);
        setStatus(v.ok ? "Klar ✅" : "Datafeil: ta backup før vi fikser.");

        await dbSet(FARM_KEY, state.farmData);
        await dbSet(LICENSE_KEY, state.licenses);
        await dbSet(MODULE_PREFS_KEY, state.modulePrefs);

        syncFarmToForm();
        renderModules();
        renderTestModuleSelect();
        renderWork();
        renderKPIs();
      }

      // =========================
      //  UI WIRING
      // =========================
      function wireUI() {
        $$("#tabs .tab").forEach(b => b.addEventListener("click", () => routeTo(b.dataset.route)));

        $("#btnCreateFarm").addEventListener("click", () => {
          if (confirm("Dette nullstiller gården i appen. Ta backup først hvis du vil!\n\nFortsette?")) resetFarm();
        });
        $("#btnSaveFarm").addEventListener("click", async () => { await saveFarm(); renderWork(); renderKPIs(); });
        $("#btnSaveFarm2").addEventListener("click", async () => { await saveFarm(); renderWork(); renderKPIs(); });

        ["#farmName","#areaDyrket","#areaBeite","#areaUtmark"].forEach(id => {
          $(id).addEventListener("change", async () => { await saveFarm(); renderWork(); renderKPIs(); });
        });

        $("#btnExport").addEventListener("click", exportBackup);
        $("#btnImport").addEventListener("click", () => {
          if (confirm("Import overskriver gjeldende gård i appen.\n\nFortsette?")) importBackup();
        });

        $("#btnRunTestsAll").addEventListener("click", () => runTests("ALL"));
        $("#btnRunTestsModule").addEventListener("click", () => {
          const id = $("#testModuleSelect").value || "ALL";
          runTests(id);
        });

        $("#licenseOverlayBg").addEventListener("click", closeLicenseModal);
        $("#btnCancelLicense").addEventListener("click", closeLicenseModal);
        $("#btnApplyLicense").addEventListener("click", async () => {
          const moduleId = state.licenseModalTarget;
          if (!moduleId) return;
          const res = await applyActivationCode(moduleId, $("#licenseCodeInput").value);
          if (!res.ok) { alert(res.msg); return; }
          await dbSet(LICENSE_KEY, state.licenses);
          await setEnabled(moduleId, true);
          alert(res.msg);
          closeLicenseModal();
        });

        $("#editorOverlayBg").addEventListener("click", closeEditor);
        $("#btnEditorCancel").addEventListener("click", closeEditor);
        $("#btnEditorSave").addEventListener("click", async () => {
          if (!state.editor.onSave || !state.editor.value) { closeEditor(); return; }
          await state.editor.onSave(state.editor.value);
          closeEditor();
        });
      }

      (async function boot() {
        setStatus("Starter…");
        wireUI();
        await loadOrCreate();
      })();
    })();
  </script>
</body>
</html>
