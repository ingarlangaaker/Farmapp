<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#00bb55" />
  <title>GÃ¥rdsapp</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#131a22;
      --muted:#8aa0b5;
      --text:#e8f0f7;
      --line:#243242;
      --accent:#0b5;
      --danger:#d44;
      --warn:#e0b400;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --pad:14px;
      --max: 980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(0,180,90,.25), transparent 60%), var(--bg);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      background: rgba(11,15,20,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      gap:10px;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:0}
    .dot{width:14px; height:14px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 6px rgba(0,180,90,.12)}
    .title{font-weight:800; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .container{max-width:var(--max); margin:0 auto; padding: 14px}
    .tabs{display:flex; gap:8px; overflow:auto; padding-bottom:10px;}
    .tab{
      border:1px solid var(--line);
      background:transparent; color:var(--text);
      padding:10px 12px; border-radius:999px;
      white-space:nowrap; font-weight:700;
    }
    .tab.active{border-color: rgba(0,180,90,.65); background: rgba(0,180,90,.12)}

    .panel{padding: 6px 0 24px}
    .hidden{display:none}
    h1{font-size:22px; margin: 14px 2px}
    h2{font-size:16px; margin: 0 0 10px}
    h3{font-size:14px; margin: 0 0 8px}
    .muted{color:var(--muted); line-height:1.4}
    .hint{color:var(--muted); font-size:12px; line-height:1.35; margin-top:10px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
      margin: 12px 0;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 700px){ .grid3{grid-template-columns:1fr 1fr 1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .field span{font-size:12px; color:var(--muted)}
    input, select, textarea{
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.2);
      color: var(--text);
      font-size:16px;
    }
    textarea{min-height:110px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      outline:none; border-color: rgba(0,180,90,.7); box-shadow: 0 0 0 4px rgba(0,180,90,.12)
    }

    .btn{
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,180,90,.6);
      background: rgba(0,180,90,.16);
      color: var(--text);
      font-weight: 800;
    }
    .btn.secondary{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.12);}
    .btn.danger{border-color: rgba(212,68,68,.8); background: rgba(212,68,68,.14);}
    .btn.ghost{border-color: var(--line); background: transparent;}
    .btn.small{padding:8px 10px; border-radius:10px; font-weight:800; font-size:13px}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:900; letter-spacing:.2px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(0,180,90,.6); background: rgba(0,180,90,.12)}
    .badge.fail{border-color: rgba(212,68,68,.7); background: rgba(212,68,68,.12)}
    .badge.locked{border-color: rgba(224,180,0,.6); background: rgba(224,180,0,.12)}
    .badge.free{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.10)}
    .badge.on{border-color: rgba(0,180,90,.6); background: rgba(0,180,90,.10)}
    .badge.off{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.08)}
    .small{font-size:12px; color:var(--muted); line-height:1.35; margin-top:8px}

    .moduleRow{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      padding:12px; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,.12);
      margin:10px 0;
    }
    .moduleMeta{min-width:0}
    .moduleTitle{font-weight:950}
    .moduleDesc{color:var(--muted); font-size:12px; line-height:1.35; margin-top:4px}
    .moduleRight{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .moduleActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .tileGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (min-width: 700px){ .tileGrid{ grid-template-columns: 1fr 1fr 1fr; } }
    .tile{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      min-height:74px;
      box-shadow: var(--shadow);
    }
    .tile:active{transform: translateY(1px)}
    .tileIcon{
      width:44px; height:44px; border-radius:14px;
      border:1px solid rgba(0,180,90,.35);
      background: rgba(0,180,90,.10);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .tileIcon svg{width:26px;height:26px;opacity:.95}
    .tileText{min-width:0}
    .tileTitle{font-weight:950; line-height:1.1}
    .tileSub{font-size:12px; color:var(--muted); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .overlay.hidden{display:none}
    .overlay{position:fixed; inset:0; z-index:80}
    .overlayBg{position:absolute; inset:0; background: rgba(0,0,0,.62)}
    .modal{
      position:absolute; left:10px; right:10px; top:10px;
      max-width:620px; margin:0 auto;
      background: var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .modal h3{margin:0 0 8px}
    hr{border:none; border-top:1px solid var(--line); margin:12px 0}

    .note{
      border:1px dashed rgba(138,160,181,.5);
      background: rgba(138,160,181,.07);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .pillbar{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
    }
    .pill.active{border-color: rgba(0,180,90,.65); background: rgba(0,180,90,.12);}
  </style>
</head>
<body>
  <header class="topbar">
    <button class="btn ghost" id="btnMinGard" aria-label="Min gÃ¥rd">âš™ Min gÃ¥rd</button>

    <div class="brand">
      <div class="dot"></div>
      <div style="min-width:0">
        <div class="title" id="topTitle">GÃ¥rdsapp</div>
        <div class="subtitle" id="statusLine">Starterâ€¦</div>
      </div>
    </div>

    <button class="btn ghost" id="btnPanelSetup" aria-label="Panel">ðŸ§© Panel</button>
  </header>

  <main class="container">
    <nav class="tabs" id="tabs">
      <button class="tab active" data-route="dashboard">Forside</button>
      <button class="tab" data-route="work">Arbeid</button>
      <button class="tab" data-route="backup">Backup</button>
      <button class="tab" data-route="tests">Selvtest</button>
      <button class="tab" data-route="modules">Moduler</button>
    </nav>

    <!-- FORSIDE -->
    <section class="panel" data-view="dashboard">
      <h1>Forside</h1>
      <p class="muted">Hurtigtaster og siste aktiviteter. Du bestemmer hva som vises i ðŸ§© Panel.</p>

      <div class="card">
        <h2>Siste aktiviteter</h2>
        <p class="muted" style="margin-top:-6px">Trykk pÃ¥ en aktivitet for detaljer.</p>
        <div id="activityList"></div>
        <div class="hint" id="activityHint"></div>
      </div>

      <div class="card">
        <h2>Hurtigtaster</h2>
        <div id="dashboardTiles" class="tileGrid"></div>
        <div class="small" id="dashboardHint"></div>
      </div>
    </section>

    <!-- ARBEID -->
    <section class="panel hidden" data-view="work">
      <h1>Arbeid</h1>
      <p class="muted">Her jobber du i modulene.</p>
      <div id="workHost"></div>
    </section>

    <!-- MIN GÃ…RD -->
    <section class="panel hidden" data-view="settings">
      <h1>Min gÃ¥rd</h1>
      <p class="muted">GÃ¥rdsdata og innstillinger.</p>

      <div class="card">
        <h2>GÃ¥rdsinfo</h2>

        <label class="field">
          <span>Navn</span>
          <input id="farmName" type="text" placeholder="F.eks. Min gÃ¥rd" />
        </label>

        <div class="grid3">
          <label class="field">
            <span>Dyrket mark (daa)</span>
            <input id="areaDyrket" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
          <label class="field">
            <span>Beite (daa)</span>
            <input id="areaBeite" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
          <label class="field">
            <span>Utmark (daa)</span>
            <input id="areaUtmark" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
        </div>

        <hr/>

        <label class="field">
          <span>VÃ¦r-lenke (yr.no) â€“ lim inn sted-URL</span>
          <input id="yrUrl" type="text" placeholder="https://www.yr.no/nb/v%C3%A6rvarsel/daglig-tabell/..." />
        </label>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnSaveFarmSettings">Lagre</button>
        </div>
        <div class="hint">Tips: Finn riktig sted pÃ¥ yr.no â†’ del/kopier lenke â†’ lim inn her.</div>
      </div>

      <div class="card">
        <h2>NÃ¸kkeltall</h2>
        <div class="grid2">
          <div>
            <div class="muted" style="font-size:12px">Sist lagret</div>
            <div style="font-size:18px;font-weight:900" id="kpiUpdatedAt">â€”</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Areal total (daa)</div>
            <div style="font-size:18px;font-weight:900" id="kpiTotalDaa">â€”</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Hendelser</div>
            <div style="font-size:18px;font-weight:900" id="kpiEventCount">â€”</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">TO DO (Ã¥pne)</div>
            <div style="font-size:18px;font-weight:900" id="kpiTodoOpen">â€”</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">TO DO (ferdige)</div>
            <div style="font-size:18px;font-weight:900" id="kpiTodoDone">â€”</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Handleliste (Ã¥pne)</div>
            <div style="font-size:18px;font-weight:900" id="kpiShopOpen">â€”</div>
          </div>
        </div>
        <div class="hint">Hvis noe virker rart: ta backup og/eller kjÃ¸r Selvtest.</div>
      </div>

      <div class="card">
        <h2>Kontroll</h2>
        <div class="row">
          <button class="btn secondary" id="btnSaveNow">Lagre nÃ¥</button>
          <button class="btn danger" id="btnResetFarm">Nullstill gÃ¥rd</button>
        </div>
        <p class="hint">Ta backup fÃ¸r nullstilling.</p>
      </div>
    </section>

    <!-- PANEL -->
    <section class="panel hidden" data-view="panelsetup">
      <h1>Panel</h1>
      <p class="muted">Velg snarveier til forsiden. Flytt rekkefÃ¸lge (â¬†/â¬‡). Basis-knapper kan flyttes, men ikke skrus av.</p>

      <div class="card">
        <h2>Snarveier</h2>
        <div id="panelSetupList"></div>
        <div class="hint">Endringer lagres automatisk.</div>
      </div>

      <div class="card">
        <h2>Weblink</h2>
        <p class="muted">Lag egne snarveier til nettsider (Ã¥pnes i ny fane).</p>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnAddWeblink">Legg til weblink</button>
        </div>
        <div id="weblinkList" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- BACKUP -->
    <section class="panel hidden" data-view="backup">
      <h1>Backup</h1>
      <div class="card">
        <h2>Eksporter</h2>
        <p class="muted">Laster ned Ã©n JSON-fil med gÃ¥rden + innstillinger + snarveier + aktivitetshistorikk.</p>
        <button class="btn" id="btnExport">Eksporter backup</button>
      </div>

      <div class="card">
        <h2>Importer</h2>
        <p class="muted">Importer overskriver gjeldende gÃ¥rd i appen.</p>
        <input id="importFile" type="file" accept="application/json" />
        <button class="btn danger" id="btnImport">Importer backup</button>
      </div>
    </section>

    <!-- TESTS -->
    <section class="panel hidden" data-view="tests">
      <h1>Selvtest</h1>
      <div class="card">
        <h2>Testpanel</h2>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnRunTestsAll">KjÃ¸r tester</button>
        </div>
        <div id="testResults"></div>
      </div>
    </section>

    <!-- MODULER (minimal i Fase 1: beholdt for struktur, men alt er gratis/kjerne) -->
    <section class="panel hidden" data-view="modules">
      <h1>Moduler</h1>
      <div class="card">
        <h2>Aktive moduler</h2>
        <p class="muted">I Fase 1 er dette en enkel kjerne (Hendelser, TO DO, Handleliste, Jobbklokke).</p>
        <div id="modulesList"></div>
      </div>
    </section>
  </main>

  <!-- GENERIC EDITOR -->
  <div class="overlay hidden" id="editorOverlay">
    <div class="overlayBg" id="editorOverlayBg"></div>
    <div class="modal">
      <h3 id="editorTitle">Rediger</h3>
      <p class="muted" id="editorSubtitle"></p>
      <div id="editorFields"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnEditorSave">Lagre</button>
        <button class="btn ghost" id="btnEditorCancel">Avbryt</button>
      </div>
      <div class="hint" id="editorHint"></div>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="overlay hidden" id="detailsOverlay">
    <div class="overlayBg" id="detailsOverlayBg"></div>
    <div class="modal">
      <h3 id="detailsTitle">Detaljer</h3>
      <div class="note" id="detailsBody"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn secondary" id="btnDetailsGo">GÃ¥ til</button>
        <button class="btn" id="btnDetailsEdit">Rediger</button>
        <button class="btn ghost" id="btnDetailsClose">Lukk</button>
      </div>
      <div class="hint" id="detailsHint"></div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      const APP_VERSION = "1.0.0-phase1B";
      const DB_NAME = "farmapp_db";
      const DB_VERSION = 5;
      const STORE = "documents";

      const KEY_FARM = "farm";
      const KEY_PANEL = "panel";
      const KEY_WEBLINKS = "weblinks";

      const $ = (q) => document.querySelector(q);
      const $$ = (q) => [...document.querySelectorAll(q)];

      let storageMode = "indexeddb"; // or localstorage

      const state = {
        farm: null,
        panel: null,
        weblinks: null,
        editor: { onSave:null, onCancel:null, value:null, fields:[], hint:"" },
        details: { item:null }
      };

      // ---------- format: dd.mm.Ã¥Ã¥Ã¥Ã¥ + 24t ----------
      function fmtDateISOToDDMMYYYY(isoYYYYMMDD){
        if (!isoYYYYMMDD) return "â€”";
        const d = new Date(isoYYYYMMDD + "T00:00:00");
        if (Number.isNaN(d.getTime())) return "â€”";
        return d.toLocaleDateString("nb
