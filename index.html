<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gårdsapp</title>

<style>
/* ====== UI / THEME ====== */
body{margin:0;font-family:system-ui;background:#0b0f14;color:#e8f0f7}
.top{padding:12px 16px;border-bottom:1px solid #243242;display:flex;justify-content:space-between}
.tabs{display:flex;gap:8px;padding:10px;overflow:auto}
.tab{padding:8px 12px;border:1px solid #243242;border-radius:999px;background:none;color:#e8f0f7}
.tab.active{background:#0b5;border-color:#0b5}
.panel{padding:12px}
.hidden{display:none}
.card{border:1px solid #243242;border-radius:12px;padding:12px;margin:10px 0;background:#131a22}
.btn{padding:8px 12px;border-radius:8px;border:1px solid #0b5;background:#0b52;color:#fff}
.btn.secondary{border-color:#8aa0b5;background:#8aa0b522}
.btn.danger{border-color:#d44;background:#d442}
.row{display:flex;gap:8px;flex-wrap:wrap}
.field{display:flex;flex-direction:column;gap:4px}
input,select{padding:8px;border-radius:8px;border:1px solid #243242;background:#0002;color:#fff}
.moduleRow{display:flex;justify-content:space-between;border:1px solid #243242;padding:10px;border-radius:10px;margin:8px 0}
.badge{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #243242}
.badge.free{background:#8aa0b522}
.badge.locked{background:#e0b40022;border-color:#e0b400}
.badge.on{background:#0b522}
.badge.off{background:#8aa0b522}
.small{font-size:12px;color:#8aa0b5}
</style>
</head>

<body>
<div class="top">
  <b>Gårdsapp</b>
  <span id="status">Starter…</span>
</div>

<div class="tabs">
  <button class="tab active" data-tab="home">Oversikt</button>
  <button class="tab" data-tab="farm">Gård</button>
  <button class="tab" data-tab="modules">Moduler</button>
  <button class="tab" data-tab="tests">Tester</button>
</div>

<div class="panel" id="home">
  <div class="card">
    <h3>Status</h3>
    <div id="kpi"></div>
  </div>
</div>

<div class="panel hidden" id="farm">
  <div class="card">
    <h3>Gård (gratis kjerne)</h3>
    <div class="field"><span>Navn</span><input id="farmName"></div>
    <div class="row">
      <div class="field"><span>Dyrket daa</span><input type="number" id="dyrket"></div>
      <div class="field"><span>Beite daa</span><input type="number" id="beite"></div>
      <div class="field"><span>Utmark daa</span><input type="number" id="utmark"></div>
    </div>
    <button class="btn" onclick="saveFarm()">Lagre</button>
  </div>
</div>

<div class="panel hidden" id="modules">
  <div class="card">
    <h3>Moduler</h3>
    <div id="moduleList"></div>
  </div>
</div>

<div class="panel hidden" id="tests">
  <div class="card">
    <h3>Tester</h3>
    <button class="btn" onclick="runTests()">Kjør tester</button>
    <div id="testResults"></div>
  </div>
</div>

<script>
/* ====== STATE ====== */
let state = {
  farm:{
    name:"Min gård",
    area:{dyrket:0,beite:0,utmark:0},
    modules:{}
  },
  licenses:{},
  enabled:{}
};

/* ====== MODULE REGISTRY ====== */
const modules = [];

function addModule(m){ modules.push(m); }

/* === CORE MODULES === */
addModule({
  id:"farm.core",
  title:"Kjerne: Gård",
  price:"free",
  default:true,
  patch(d){},
  tests:[()=>true]
});

addModule({
  id:"area.core",
  title:"Kjerne: Areal",
  price:"free",
  default:true,
  patch(d){},
  tests:[()=>true]
});

/* === AREA UNITS (SALGBAR) === */
addModule({
  id:"area.units",
  title:"Arealenheter / skifter",
  price:"paid",
  default:false,
  patch(d){
    if(!d.modules.areaUnits){
      d.modules.areaUnits={units:[]};
    }
  },
  tests:[
    ()=>{
      const d={modules:{}};
      modules.find(m=>m.id==="area.units").patch(d);
      if(!d.modules.areaUnits) throw "Mangler areaUnits";
      return true;
    }
  ]
});

/* ====== INIT ====== */
modules.forEach(m=>{
  state.enabled[m.id]=m.default||false;
  state.licenses[m.id]=m.price==="free"?"free":"locked";
});

modules.forEach(m=>{
  if(state.enabled[m.id]) m.patch(state.farm);
});

/* ====== UI ====== */
document.querySelectorAll(".tab").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.add("hidden"));
    b.classList.add("active");
    document.getElementById(b.dataset.tab).classList.remove("hidden");
  };
});

function render(){
  document.getElementById("kpi").innerText=
    state.farm.name+" | Dyrket "+state.farm.area.dyrket+" daa";

  const list=document.getElementById("moduleList");
  list.innerHTML="";
  modules.forEach(m=>{
    const row=document.createElement("div");
    row.className="moduleRow";
    row.innerHTML=`
      <div>
        <b>${m.title}</b>
        <div class="small">${m.id}</div>
      </div>
      <div>
        <span class="badge ${state.licenses[m.id]==="free"?"free":"locked"}">
          ${state.licenses[m.id]}
        </span>
        <span class="badge ${state.enabled[m.id]?"on":"off"}">
          ${state.enabled[m.id]?"På":"Av"}
        </span>
        <button class="btn secondary">Toggle</button>
      </div>
    `;
    row.querySelector("button").onclick=()=>{
      if(state.licenses[m.id]==="locked"){
        alert("Denne modulen er låst (betalingsklar)");
        return;
      }
      state.enabled[m.id]=!state.enabled[m.id];
      if(state.enabled[m.id]) m.patch(state.farm);
      render();
    };
    list.appendChild(row);
  });
}

function saveFarm(){
  state.farm.name=document.getElementById("farmName").value;
  state.farm.area.dyrket=+document.getElementById("dyrket").value||0;
  state.farm.area.beite=+document.getElementById("beite").value||0;
  state.farm.area.utmark=+document.getElementById("utmark").value||0;
  render();
}

function runTests(){
  const out=document.getElementById("testResults");
  out.innerHTML="";
  modules.forEach(m=>{
    m.tests.forEach((t,i)=>{
      try{t();out.innerHTML+=`<div>✔ ${m.id} test ${i+1}</div>`;}
      catch(e){out.innerHTML+=`<div>✖ ${m.id}: ${e}</div>`;}
    });
  });
}

render();
document.getElementById("status").innerText="Klar ✅";
</script>
</body>
</html>
