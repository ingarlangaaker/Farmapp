<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#00bb55" />
  <title>Farmapp</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121a22;
      --muted:#8aa0b5;
      --text:#e8f0f7;
      --line:#243242;
      --accent:#0b5;
      --danger:#d44;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --pad:14px;
      --max: 980px;
      --bgimg: none;
      --bgdim: .55;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        linear-gradient(rgba(0,0,0,var(--bgdim)), rgba(0,0,0,var(--bgdim))),
        var(--bgimg),
        radial-gradient(1200px 600px at 30% -10%, rgba(0,180,90,.22), transparent 60%),
        var(--bg);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      background: rgba(11,15,20,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      gap:10px;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:0}
    .dot{width:14px; height:14px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 6px rgba(0,180,90,.12)}
    .title{font-weight:800; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .container{max-width:var(--max); margin:0 auto; padding: 14px}
    .tabs{display:flex; gap:8px; overflow:auto; padding-bottom:10px;}
    .tab{
      border:1px solid var(--line);
      background:transparent; color:var(--text);
      padding:10px 12px; border-radius:999px;
      white-space:nowrap; font-weight:800;
    }
    .tab.active{border-color: rgba(0,180,90,.65); background: rgba(0,180,90,.12)}
    .panel{padding: 6px 0 24px}
    .hidden{display:none}

    h1{font-size:22px; margin: 14px 2px}
    h2{font-size:16px; margin: 0 0 10px}
    .muted{color:var(--muted); line-height:1.4}
    .hint{color:var(--muted); font-size:12px; line-height:1.35; margin-top:10px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
      margin: 12px 0;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width: 700px){ .grid3{grid-template-columns:1fr 1fr 1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .field span{font-size:12px; color:var(--muted)}
    input, select, textarea{
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.2);
      color: var(--text);
      font-size:16px;
    }
    textarea{min-height:110px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      outline:none; border-color: rgba(0,180,90,.7); box-shadow: 0 0 0 4px rgba(0,180,90,.12)
    }

    .btn{
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,180,90,.6);
      background: rgba(0,180,90,.16);
      color: var(--text);
      font-weight: 900;
    }
    .btn.secondary{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.12);}
    .btn.danger{border-color: rgba(212,68,68,.8); background: rgba(212,68,68,.14);}
    .btn.ghost{border-color: var(--line); background: transparent;}
    .btn.small{padding:8px 10px; border-radius:10px; font-weight:900; font-size:13px}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:900; letter-spacing:.2px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(0,180,90,.6); background: rgba(0,180,90,.12)}
    .badge.fail{border-color: rgba(212,68,68,.7); background: rgba(212,68,68,.12)}
    .badge.free{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.10)}
    .badge.on{border-color: rgba(0,180,90,.6); background: rgba(0,180,90,.10)}
    .badge.off{border-color: rgba(138,160,181,.6); background: rgba(138,160,181,.08)}
    .small{font-size:12px; color:var(--muted); line-height:1.35; margin-top:8px}

    .moduleRow{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      padding:12px; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,.12);
      margin:10px 0;
    }
    .moduleMeta{min-width:0}
    .moduleTitle{font-weight:950}
    .moduleDesc{color:var(--muted); font-size:12px; line-height:1.35; margin-top:4px}
    .moduleRight{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .moduleActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .tileGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (min-width: 700px){ .tileGrid{ grid-template-columns: 1fr 1fr 1fr; } }
    .tile{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      min-height:74px;
      box-shadow: var(--shadow);
    }
    .tile:active{transform: translateY(1px)}
    .tileIcon{
      width:44px; height:44px; border-radius:14px;
      border:1px solid rgba(0,180,90,.35);
      background: rgba(0,180,90,.10);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      font-weight:900;
    }
    .tileText{min-width:0}
    .tileTitle{font-weight:950; line-height:1.1}
    .tileSub{font-size:12px; color:var(--muted); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .overlay.hidden{display:none}
    .overlay{position:fixed; inset:0; z-index:80}
    .overlayBg{position:absolute; inset:0; background: rgba(0,0,0,.62)}
    .modal{
      position:absolute; left:10px; right:10px; top:10px;
      max-width:560px; margin:0 auto;
      background: var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .modal h3{margin:0 0 8px}
    .modal .muted{margin:0 0 10px}
    hr{border:none; border-top:1px solid var(--line); margin:12px 0}

    .note{
      border:1px dashed rgba(138,160,181,.5);
      background: rgba(138,160,181,.07);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .actItem{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      margin:8px 0;
    }
    .actItem:active{transform: translateY(1px)}
    .actTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .actTitle{font-weight:950}
    .actTime{font-size:12px;color:var(--muted);white-space:nowrap}
    .actSub{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}
  </style>
</head>

<body>
  <header class="topbar">
    <button class="btn ghost" id="btnMinGard" aria-label="Min g√•rd">‚öô Min g√•rd</button>

    <div class="brand">
      <div class="dot"></div>
      <div style="min-width:0">
        <div class="title" id="topTitle">Farmapp</div>
        <div class="subtitle" id="statusLine">Starter‚Ä¶</div>
      </div>
    </div>

    <button class="btn ghost" id="btnPanelSetup" aria-label="Panel">üß© Panel</button>
  </header>

  <main class="container">
    <nav class="tabs" id="tabs">
      <button class="tab active" data-route="dashboard">Forside</button>
      <button class="tab" data-route="work">Arbeid</button>
      <button class="tab" data-route="backup">Backup</button>
      <button class="tab" data-route="tests">Selvtest</button>
    </nav>

    <section class="panel" data-view="dashboard">
      <h1>Forside</h1>
      <p class="muted">Hurtigtaster og siste aktiviteter. Panel (üß©) styrer hvilke snarveier som vises.</p>

      <div class="card">
        <h2>Hurtigtaster</h2>
        <div id="dashboardTiles" class="tileGrid"></div>
        <div class="small" id="dashboardHint"></div>
      </div>

      <div class="card">
        <h2>Siste aktiviteter</h2>
        <div class="muted" style="font-size:12px; margin-bottom:8px;">
          Trykk p√• en aktivitet for detaljer / hopp til riktig sted.
        </div>
        <div id="activityList"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn secondary small" id="btnClearActivity">T√∏m aktivitetslogg</button>
        </div>
        <div class="hint">Loggen er rullerende for √• holde appen rask.</div>
      </div>
    </section>

    <section class="panel hidden" data-view="work">
      <h1>Arbeid</h1>
      <p class="muted">Hendelser, TO DO, Handleliste og Jobbklokke.</p>
      <div id="workHost"></div>
    </section>

    <section class="panel hidden" data-view="settings">
      <h1>Min g√•rd</h1>
      <p class="muted">Grunninnstillinger (og Yr.no-lenke). Forside er for handling.</p>

      <div class="card">
        <h2>G√•rdsinfo</h2>

        <label class="field">
          <span>Navn</span>
          <input id="farmName" type="text" placeholder="F.eks. Min g√•rd" />
        </label>

        <div class="grid3">
          <label class="field">
            <span>Dyrket mark (daa)</span>
            <input id="areaDyrket" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
          <label class="field">
            <span>Beite (daa)</span>
            <input id="areaBeite" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
          <label class="field">
            <span>Utmark (daa)</span>
            <input id="areaUtmark" type="number" inputmode="decimal" min="0" step="0.1" />
          </label>
        </div>

        <hr/>

        <label class="field">
          <span>Yr.no-lenke (sted)</span>
          <input id="yrUrl" type="text" placeholder="Lim inn yr.no-lenke til ditt sted" />
        </label>
        <div class="hint">
          Tips: √Öpne yr.no ‚Üí finn stedet ditt ‚Üí kopier lenken ‚Üí lim inn her.
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnSaveFarmSettings">Lagre</button>
        </div>
      </div>

      <div class="card">
        <h2>N√∏kkeltall</h2>
        <div class="grid2">
          <div>
            <div class="muted" style="font-size:12px">Sist lagret</div>
            <div style="font-size:18px;font-weight:900" id="kpiUpdatedAt">‚Äî</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Areal total (daa)</div>
            <div style="font-size:18px;font-weight:900" id="kpiTotalDaa">‚Äî</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Hendelser</div>
            <div style="font-size:18px;font-weight:900" id="kpiEventCount">‚Äî</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">TO DO (√•pne)</div>
            <div style="font-size:18px;font-weight:900" id="kpiTodoCount">‚Äî</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Handleliste (√•pne)</div>
            <div style="font-size:18px;font-weight:900" id="kpiShopCount">‚Äî</div>
          </div>
          <div>
            <div class="muted" style="font-size:12px">Ufakturerte jobber</div>
            <div style="font-size:18px;font-weight:900" id="kpiJobsCount">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Kontroll</h2>
        <div class="row">
          <button class="btn secondary" id="btnSaveNow">Lagre n√•</button>
          <button class="btn danger" id="btnResetFarm">Nullstill g√•rd</button>
        </div>
        <p class="hint">Ta backup f√∏r nullstilling.</p>
      </div>
    </section>

    <section class="panel hidden" data-view="panelsetup">
      <h1>Panel</h1>
      <p class="muted">Vis/skjul snarveier og flytt rekkef√∏lge (‚¨Ü/‚¨á). Du kan ogs√• legge til egne weblinker.</p>

      <div class="card">
        <h2>Snarveier</h2>
        <div id="panelSetupList"></div>
        <div class="hint">Endringer lagres automatisk.</div>
      </div>

      <div class="card">
        <h2>Legg til weblink</h2>
        <div class="grid2">
          <label class="field">
            <span>Navn</span>
            <input id="wlName" type="text" placeholder="F.eks. Felleskj√∏pet" />
          </label>
          <label class="field">
            <span>URL</span>
            <input id="wlUrl" type="text" placeholder="https://..." />
          </label>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnAddWeblink">Legg til</button>
        </div>
        <div class="hint">Weblink √•pnes i ny fane.</div>
      </div>
    </section>

    <section class="panel hidden" data-view="backup">
      <h1>Backup</h1>

      <div class="card">
        <h2>Eksporter</h2>
        <p class="muted">Laster ned √©n JSON-fil med g√•rdsdata.</p>
        <button class="btn" id="btnExport">Eksporter backup</button>
      </div>

      <div class="card">
        <h2>Importer</h2>
        <p class="muted">Importer overskriver gjeldende g√•rd i appen.</p>
        <input id="importFile" type="file" accept="application/json" />
        <button class="btn danger" id="btnImport">Importer backup</button>
      </div>
    </section>

    <section class="panel hidden" data-view="tests">
      <h1>Selvtest</h1>
      <div class="card">
        <h2>Testpanel</h2>
        <div class="row">
          <button class="btn" id="btnRunTests">Kj√∏r selvtest</button>
        </div>
        <div id="testResults"></div>
      </div>
    </section>
  </main>

  <!-- Editor modal -->
  <div class="overlay hidden" id="editorOverlay">
    <div class="overlayBg" id="editorOverlayBg"></div>
    <div class="modal">
      <h3 id="editorTitle">Rediger</h3>
      <p class="muted" id="editorSubtitle"></p>
      <div id="editorFields"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnEditorSave">Lagre</button>
        <button class="btn ghost" id="btnEditorCancel">Avbryt</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // =========================
      //  Helpers
      // =========================
      const $ = (q) => document.querySelector(q);
      const $$ = (q) => [...document.querySelectorAll(q)];
      const APP_VERSION = "1.0.0-phase1";
      const DB_NAME = "farmapp_phase1_db";
      const DB_VERSION = 1;
      const STORE = "docs";
      const KEY_FARM = "farm";
      const KEY_PANEL = "panel";
      const KEY_WEBLINKS = "weblinks";

      const MAX_ACTIVITIES = 300; // rullerende logg

      function setStatus(s){ $("#statusLine").textContent = s; }
      function uuid(){
        try { return crypto.randomUUID(); }
        catch { return String(Date.now()) + "-" + Math.random().toString(16).slice(2); }
      }
      function escapeHtml(s){
        return String(s ?? "").replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
        }[c]));
      }
      function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

      // dd.mm.√•√•√•√• og 24t (globalt)
      function fmtDateISOToNO(isoYmd){
        if(!isoYmd) return "‚Äî";
        const d = new Date(isoYmd + "T00:00:00");
        if(Number.isNaN(d.getTime())) return isoYmd;
        return d.toLocaleDateString("nb-NO", { day:"2-digit", month:"2-digit", year:"numeric" });
      }
      function fmtDateTime(iso){
        if(!iso) return "‚Äî";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return String(iso);
        const date = d.toLocaleDateString("nb-NO", { day:"2-digit", month:"2-digit", year:"numeric" });
        const time = d.toLocaleTimeString("nb-NO", { hour:"2-digit", minute:"2-digit", hour12:false });
        return `${date} ${time}`;
      }
      function todayISO(){
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}`;
      }

      // =========================
      //  Storage: IndexedDB -> localStorage fallback
      // =========================
      let storageMode = "indexeddb";
      function lsKey(k){ return `${DB_NAME}::${k}`; }

      function openDB(){
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = () => {
            const db = req.result;
            if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }
      async function idbGet(key){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readonly");
          const st = tx.objectStore(STORE);
          const req = st.get(key);
          req.onsuccess = () => { db.close(); resolve(req.result ?? null); };
          req.onerror = () => { db.close(); reject(req.error); };
        });
      }
      async function idbSet(key, val){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readwrite");
          tx.objectStore(STORE).put(val, key);
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); reject(tx.error); };
        });
      }
      async function idbClear(){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE, "readwrite");
          tx.objectStore(STORE).clear();
          tx.oncomplete = () => { db.close(); resolve(); };
          tx.onerror = () => { db.close(); reject(tx.error); };
        });
      }
      function lsGet(key){
        const raw = localStorage.getItem(lsKey(key));
        if(!raw) return null;
        try { return JSON.parse(raw); } catch { return null; }
      }
      function lsSet(key, val){
        localStorage.setItem(lsKey(key), JSON.stringify(val));
      }
      function lsClear(){
        const prefix = lsKey("");
        const toDel = [];
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(k && k.startsWith(prefix)) toDel.push(k);
        }
        toDel.forEach(k => localStorage.removeItem(k));
      }
      async function dbProbe(){
        try{
          await idbSet("__probe__", { t: Date.now() });
          const v = await idbGet("__probe__");
          if(!v) throw new Error("probe failed");
          storageMode = "indexeddb";
        }catch{
          storageMode = "localstorage";
        }
      }
      async function dbGet(key){
        if(storageMode==="localstorage") return lsGet(key);
        try { return await idbGet(key); }
        catch { storageMode="localstorage"; return lsGet(key); }
      }
      async function dbSet(key,val){
        if(storageMode==="localstorage") return lsSet(key,val);
        try { return await idbSet(key,val); }
        catch { storageMode="localstorage"; return lsSet(key,val); }
      }
      async function dbClear(){
        if(storageMode==="localstorage") return lsClear();
        try { return await idbClear(); }
        catch { storageMode="localstorage"; return lsClear(); }
      }

      // =========================
      //  State
      // =========================
      let farm = null;
      let panel = null;
      let weblinks = null;

      // Editor modal state
      const editor = { onSave:null, onCancel:null, value:null, fields:[] };

      // =========================
      //  Data Model (Phase 1)
      // =========================
      function newFarm(){
        const now = new Date().toISOString();
        return {
          meta: { appVersion: APP_VERSION, createdAt: now, updatedAt: now },
          farm: {
            id: uuid(),
            name: "Min g√•rd",
            area: { dyrketDaa: 0, beiteDaa: 0, utmarkDaa: 0 },
            yrUrl: "https://www.yr.no",
            modules: {
              events: {
                categories: ["Vedlikehold","Sl√•tt","Beite","Spr√∏yting","Avvik","Notat"],
                entries: []
              },
              todo: {
                items: [] // {id,text,dueDate,done,doneAt,createdAt}
              },
              shopping: {
                suppliers: ["Felleskj√∏pet","Coop","Bondekompaniet","Annet"],
                items: [] // {id,name,qty,supplier,bought,boughtAt,createdAt}
              },
              jobTimer: {
                running: null, // {id, customer, task, note, startedAt}
                sessions: []   // {id, customer, task, note, startedAt, endedAt, minutes, status}
              }
            },
            activityLog: [] // {id, ts, type, title, subtitle, route, payload}
          }
        };
      }

      function patchFarm(d){
        if(!d || typeof d !== "object") return newFarm();
        if(!d.meta) d.meta = { appVersion: APP_VERSION, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
        if(!d.farm) return newFarm();

        // basics
        if(typeof d.farm.name !== "string") d.farm.name = "Min g√•rd";
        if(!d.farm.area) d.farm.area = { dyrketDaa:0, beiteDaa:0, utmarkDaa:0 };
        for(const k of ["dyrketDaa","beiteDaa","utmarkDaa"]){
          d.farm.area[k] = num(d.farm.area[k]);
          if(d.farm.area[k] < 0) d.farm.area[k] = 0;
        }
        if(typeof d.farm.yrUrl !== "string" || !d.farm.yrUrl.trim()) d.farm.yrUrl = "https://www.yr.no";

        if(!d.farm.modules) d.farm.modules = {};
        const m = d.farm.modules;

        if(!m.events) m.events = { categories: ["Vedlikehold","Sl√•tt","Beite","Spr√∏yting","Avvik","Notat"], entries: [] };
        if(!Array.isArray(m.events.categories)) m.events.categories = ["Notat"];
        if(!Array.isArray(m.events.entries)) m.events.entries = [];

        if(!m.todo) m.todo = { items: [] };
        if(!Array.isArray(m.todo.items)) m.todo.items = [];

        if(!m.shopping) m.shopping = { suppliers: ["Annet"], items: [] };
        if(!Array.isArray(m.shopping.suppliers)) m.shopping.suppliers = ["Annet"];
        if(!Array.isArray(m.shopping.items)) m.shopping.items = [];

        if(!m.jobTimer) m.jobTimer = { running:null, sessions: [] };
        if(!Array.isArray(m.jobTimer.sessions)) m.jobTimer.sessions = [];
        if(m.jobTimer.running && typeof m.jobTimer.running !== "object") m.jobTimer.running = null;

        if(!Array.isArray(d.farm.activityLog)) d.farm.activityLog = [];

        return d;
      }

      function defaultPanel(){
        // Visible shortcuts; order defines rendering
        return {
          visible: {
            "events.new": true,
            "todo.new": true,
            "shopping.new": true,
            "job.toggle": true,
            "weather.yr": true
          },
          order: ["events.new","todo.new","shopping.new","job.toggle","weather.yr"]
        };
      }
      function patchPanel(p){
        const base = defaultPanel();
        if(!p || typeof p !== "object") return base;
        if(!p.visible || typeof p.visible !== "object") p.visible = {...base.visible};
        if(!Array.isArray(p.order)) p.order = base.order.slice();

        // ensure base actions exist
        for(const id of base.order){
          if(typeof p.visible[id] !== "boolean") p.visible[id] = base.visible[id];
          if(!p.order.includes(id)) p.order.push(id);
        }

        // remove junk, uniq
        const seen = new Set();
        p.order = p.order.filter(x => typeof x === "string" && x.trim()).filter(x => (seen.has(x) ? false : (seen.add(x), true)));
        return p;
      }

      function patchWeblinks(w){
        if(!w || typeof w !== "object") return { items: [] };
        if(!Array.isArray(w.items)) w.items = [];
        // each: {id, name, url, createdAt}
        w.items = w.items.filter(x => x && typeof x === "object" && x.id && x.name && x.url);
        return w;
      }

      // =========================
      //  Activity Log
      // =========================
      function addActivity({type, title, subtitle, route, payload}){
        const entry = {
          id: uuid(),
          ts: new Date().toISOString(),
          type: String(type||"activity"),
          title: String(title||"Aktivitet"),
          subtitle: String(subtitle||""),
          route: String(route||"dashboard"),
          payload: payload || {}
        };
        farm.farm.activityLog.unshift(entry);
        if(farm.farm.activityLog.length > MAX_ACTIVITIES){
          farm.farm.activityLog.length = MAX_ACTIVITIES;
        }
      }

      // =========================
      //  Routing
      // =========================
      function routeTo(route){
        $$("#tabs .tab").forEach(b => b.classList.toggle("active", b.dataset.route === route));
        $$("[data-view]").forEach(v => v.classList.toggle("hidden", v.dataset.view !== route));
      }

      // =========================
      //  Editor Modal
      // =========================
      function openEditor(cfg){
        editor.onSave = cfg.onSave || null;
        editor.onCancel = cfg.onCancel || null;
        editor.value = JSON.parse(JSON.stringify(cfg.value || {}));
        editor.fields = cfg.fields || [];

        $("#editorTitle").textContent = cfg.title || "Rediger";
        $("#editorSubtitle").textContent = cfg.subtitle || "";
        const host = $("#editorFields");
        host.innerHTML = "";

        for(const f of editor.fields){
          const wrap = document.createElement("label");
          wrap.className = "field";
          const label = document.createElement("span");
          label.textContent = f.label;
          wrap.appendChild(label);

          let input;
          if(f.type === "select"){
            input = document.createElement("select");
            for(const [val, txt] of (f.options||[])){
              const opt = document.createElement("option");
              opt.value = val;
              opt.textContent = txt;
              input.appendChild(opt);
            }
            input.value = editor.value[f.key] ?? (f.options?.[0]?.[0] ?? "");
          }else if(f.type === "textarea"){
            input = document.createElement("textarea");
            input.value = editor.value[f.key] ?? "";
          }else{
            input = document.createElement("input");
            input.type = (f.type === "number") ? "number" : "text";
            input.value = editor.value[f.key] ?? "";
          }

          input.addEventListener("input", () => {
            editor.value[f.key] = (f.type === "number") ? Number(input.value) : input.value;
          });

          wrap.appendChild(input);
          host.appendChild(wrap);
        }

        $("#editorOverlay").classList.remove("hidden");
      }
      function closeEditor(runCancel){
        if(runCancel && typeof editor.onCancel === "function"){
          try{ editor.onCancel(); }catch{}
        }
        $("#editorOverlay").classList.add("hidden");
        editor.onSave = null;
        editor.onCancel = null;
        editor.value = null;
        editor.fields = [];
      }

      // =========================
      //  Save / Sync
      // =========================
      function syncFarmToForm(){
        $("#farmName").value = farm.farm.name ?? "";
        $("#areaDyrket").value = farm.farm.area.dyrketDaa ?? 0;
        $("#areaBeite").value = farm.farm.area.beiteDaa ?? 0;
        $("#areaUtmark").value = farm.farm.area.utmarkDaa ?? 0;
        $("#yrUrl").value = farm.farm.yrUrl ?? "https://www.yr.no";
        $("#topTitle").textContent = farm.farm.name || "Farmapp";
        applyBackground();
      }
      function syncFormToFarm(){
        farm.farm.name = ($("#farmName").value || "").trim() || "Min g√•rd";
        farm.farm.area.dyrketDaa = num($("#areaDyrket").value);
        farm.farm.area.beiteDaa  = num($("#areaBeite").value);
        farm.farm.area.utmarkDaa = num($("#areaUtmark").value);
        farm.farm.yrUrl = ($("#yrUrl").value || "").trim() || "https://www.yr.no";
        farm.meta.updatedAt = new Date().toISOString();
      }

      async function saveAll(){
        syncFormToFarm();
        farm = patchFarm(farm);
        panel = patchPanel(panel);
        weblinks = patchWeblinks(weblinks);

        await dbSet(KEY_FARM, farm);
        await dbSet(KEY_PANEL, panel);
        await dbSet(KEY_WEBLINKS, weblinks);

        $("#topTitle").textContent = farm.farm.name || "Farmapp";
        setStatus(`Lagret ‚úÖ (${storageMode})`);
      }

      function renderKPIs(){
        const a = farm.farm.area;
        const total = (a.dyrketDaa||0) + (a.beiteDaa||0) + (a.utmarkDaa||0);
        const evCount = farm.farm.modules.events.entries.length;
        const todoOpen = farm.farm.modules.todo.items.filter(x => !x.done).length;
        const shopOpen = farm.farm.modules.shopping.items.filter(x => !x.bought).length;
        const jobsUnbilled = farm.farm.modules.jobTimer.sessions.filter(x => x.status === "unbilled").length;

        $("#kpiUpdatedAt").textContent = fmtDateTime(farm.meta.updatedAt);
        $("#kpiTotalDaa").textContent = String(total);
        $("#kpiEventCount").textContent = String(evCount);
        $("#kpiTodoCount").textContent = String(todoOpen);
        $("#kpiShopCount").textContent = String(shopOpen);
        $("#kpiJobsCount").textContent = String(jobsUnbilled);
      }

      // =========================
      //  Actions (Forside tiles)
      // =========================
      const ActionRegistry = new Map();

      function setAction(id, def){ ActionRegistry.set(id, def); }
      function getAction(id){ return ActionRegistry.get(id) || null; }

      function registerBaseActions(){
        setAction("events.new", {
          title: () => "Ny hendelse",
          subtitle: () => "Velg kategori",
          icon: () => "üóíÔ∏è",
          run: async () => actions.newEvent(true)
        });

        setAction("todo.new", {
          title: () => "Nytt gj√∏rem√•l",
          subtitle: () => "TO DO",
          icon: () => "‚úÖ",
          run: async () => actions.newTodo(true)
        });

        setAction("shopping.new", {
          title: () => "Ny vare",
          subtitle: () => "Handleliste",
          icon: () => "üõí",
          run: async () => actions.newShopping(true)
        });

        setAction("job.toggle", {
          title: () => {
            const r = farm.farm.modules.jobTimer.running;
            return r ? "Stopp jobb" : "Start jobb";
          },
          subtitle: () => {
            const r = farm.farm.modules.jobTimer.running;
            if(!r) return "Kunde + oppdrag";
            return `${r.customer} ¬∑ ${r.task}`.slice(0,40);
          },
          icon: () => "‚è±Ô∏è",
          run: async () => {
            const r = farm.farm.modules.jobTimer.running;
            if(r) await actions.stopJob(true);
            else await actions.startJob(true);
          }
        });

        setAction("weather.yr", {
          title: () => "V√¶r (yr.no)",
          subtitle: () => "√Öpner sted",
          icon: () => "üå¶Ô∏è",
          run: async () => {
            const url = (farm.farm.yrUrl || "https://www.yr.no").trim();
            remindActivityClick();
            window.open(url, "_blank", "noopener,noreferrer");
            addActivity({
              type: "weather",
              title: "√Öpnet v√¶r",
              subtitle: url,
              route: "dashboard",
              payload: { url }
            });
            await saveAll();
            renderActivities();
          }
        });
      }

      function registerWeblinkActions(){
        // each weblink becomes action "weblink:<id>"
        for(const w of weblinks.items){
          const id = `weblink:${w.id}`;
          if(ActionRegistry.has(id)) continue;
          setAction(id, {
            title: () => w.name,
            subtitle: () => "Weblink",
            icon: () => "üîó",
            run: async () => {
              const url = String(w.url||"").trim();
              if(!/^https?:\/\//i.test(url)){
                alert("URL m√• starte med http:// eller https://");
                return;
              }
              window.open(url, "_blank", "noopener,noreferrer");
              addActivity({
                type: "weblink",
                title: "√Öpnet weblink",
                subtitle: `${w.name} ¬∑ ${url}`,
                route: "dashboard",
                payload: { weblinkId: w.id }
              });
              await saveAll();
              renderActivities();
            }
          });
        }
      }

      function ensurePanelHasWeblinks(){
        // new weblinks default visible = true and appended to order
        for(const w of weblinks.items){
          const id = `weblink:${w.id}`;
          if(typeof panel.visible[id] !== "boolean"){
            panel.visible[id] = true;
          }
          if(!panel.order.includes(id)){
            panel.order.push(id);
          }
        }
      }

      function remindActivityClick(){
        // no-op now; placeholder if we want hints
      }

      // =========================
      //  Core business actions
      // =========================
      const actions = {
        newEvent: async (goWork) => {
          const ev = farm.farm.modules.events;
          const item = { id: uuid(), date: todayISO(), category: ev.categories[0] || "Notat", text: "" };
          ev.entries.unshift(item);

          openEditor({
            title: "Ny hendelse",
            subtitle: "Velg kategori og skriv tekst.",
            fields: [
              { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
              { key:"category", label:"Kategori", type:"select", options: ev.categories.map(x => [x,x]) },
              { key:"text", label:"Tekst", type:"textarea" }
            ],
            value: item,
            onCancel: () => {
              const first = ev.entries[0];
              if(first && first.id === item.id && !(first.text||"").trim()) ev.entries.shift();
            },
            onSave: async (nv) => {
              ev.entries[0] = { ...ev.entries[0], ...nv };
              if(!String(ev.entries[0].text||"").trim()){
                alert("Skriv tekst f√∏r lagring.");
                return;
              }
              addActivity({
                type: "event",
                title: "Ny hendelse",
                subtitle: `${ev.entries[0].category} ¬∑ ${fmtDateISOToNO(ev.entries[0].date)}`,
                route: "work",
                payload: { eventId: ev.entries[0].id }
              });
              await saveAll();
              renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        newTodo: async (goWork) => {
          const t = farm.farm.modules.todo;
          const item = { id: uuid(), text:"", dueDate:"", done:false, createdAt: new Date().toISOString(), doneAt:null };
          t.items.unshift(item);

          openEditor({
            title: "Nytt gj√∏rem√•l",
            subtitle: "Kort tekst ‚Äì evt. frist (YYYY-MM-DD).",
            fields: [
              { key:"text", label:"Tekst", type:"text" },
              { key:"dueDate", label:"Frist (valgfritt, YYYY-MM-DD)", type:"text" }
            ],
            value: item,
            onCancel: () => {
              const first = t.items[0];
              if(first && first.id === item.id && !(first.text||"").trim()) t.items.shift();
            },
            onSave: async (nv) => {
              t.items[0] = { ...t.items[0], ...nv };
              if(!String(t.items[0].text||"").trim()){
                alert("Skriv tekst f√∏r lagring.");
                return;
              }
              addActivity({
                type: "todo",
                title: "Nytt gj√∏rem√•l",
                subtitle: t.items[0].text.slice(0,60),
                route: "work",
                payload: { todoId: t.items[0].id }
              });
              await saveAll();
              renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        newShopping: async (goWork) => {
          const s = farm.farm.modules.shopping;
          const item = { id: uuid(), name:"", qty:"", supplier: s.suppliers[0] || "Annet", bought:false, createdAt: new Date().toISOString(), boughtAt:null };
          s.items.unshift(item);

          openEditor({
            title: "Ny vare",
            subtitle: "Velg leverand√∏r.",
            fields: [
              { key:"name", label:"Vare", type:"text" },
              { key:"qty", label:"Mengde (valgfritt)", type:"text" },
              { key:"supplier", label:"Leverand√∏r", type:"select", options: s.suppliers.map(x => [x,x]) }
            ],
            value: item,
            onCancel: () => {
              const first = s.items[0];
              if(first && first.id === item.id && !(first.name||"").trim()) s.items.shift();
            },
            onSave: async (nv) => {
              s.items[0] = { ...s.items[0], ...nv };
              if(!String(s.items[0].name||"").trim()){
                alert("Skriv varenavn f√∏r lagring.");
                return;
              }
              addActivity({
                type: "shopping",
                title: "Ny vare",
                subtitle: `${s.items[0].name} ¬∑ ${s.items[0].supplier}`,
                route: "work",
                payload: { itemId: s.items[0].id }
              });
              await saveAll();
              renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        startJob: async (goWork) => {
          const jt = farm.farm.modules.jobTimer;
          if(jt.running){ alert("En jobb p√•g√•r allerede. Stopp den f√∏rst."); return; }

          const draft = { customer:"", task:"", note:"" };
          openEditor({
            title: "Start jobb",
            subtitle: "Skriv inn kunde og hva du gj√∏r.",
            fields: [
              { key:"customer", label:"Kunde", type:"text" },
              { key:"task", label:"Hva gj√∏r du", type:"text" },
              { key:"note", label:"Notat (valgfritt)", type:"text" }
            ],
            value: draft,
            onSave: async (nv) => {
              const customer = String(nv.customer||"").trim();
              const task = String(nv.task||"").trim();
              if(!customer || !task){
                alert("Fyll inn b√•de Kunde og Hva gj√∏r du.");
                return;
              }
              jt.running = { id: uuid(), customer, task, note: String(nv.note||"").trim(), startedAt: new Date().toISOString() };
              addActivity({
                type: "job",
                title: "Startet jobb",
                subtitle: `${customer} ¬∑ ${task}`,
                route: "work",
                payload: { running: true }
              });
              await saveAll();
              renderAll();
              if(goWork) routeTo("work");
            }
          });
        },

        stopJob: async (goWork) => {
          const jt = farm.farm.modules.jobTimer;
          if(!jt.running){ alert("Ingen jobb p√•g√•r."); return; }
          const end = new Date().toISOString();
          const r = jt.running;
          const minutes = Math.round((new Date(end) - new Date(r.startedAt)) / 60000);
          jt.sessions.unshift({
            id: r.id,
            customer: r.customer,
            task: r.task,
            note: r.note || "",
            startedAt: r.startedAt,
            endedAt: end,
            minutes: Math.max(0, minutes),
            status: "unbilled"
          });
          jt.running = null;

          addActivity({
            type: "job",
            title: "Stoppet jobb",
            subtitle: `${r.customer} ¬∑ ${r.task} ¬∑ ${Math.max(0, minutes)} min`,
            route: "work",
            payload: { running: false }
          });

          await saveAll();
          renderAll();
          if(goWork) routeTo("work");
        }
      };

      // =========================
      //  Rendering: Forside
      // =========================
      function renderTiles(){
        const host = $("#dashboardTiles");
        const hint = $("#dashboardHint");
        host.innerHTML = "";
        hint.textContent = "";

        // ensure weblinks are registered
        registerWeblinkActions();
        ensurePanelHasWeblinks();

        const visible = panel.order.filter(id => panel.visible[id] === true);

        if(!visible.length){
          hint.textContent = "Ingen snarveier valgt. √Öpne üß© Panel og sl√• p√• snarveier.";
          return;
        }

        for(const id of visible){
          const def = getAction(id);
          if(!def) continue;

          const tile = document.createElement("div");
          tile.className = "tile";
          tile.innerHTML = `
            <div class="tileIcon">${escapeHtml(def.icon?.() || "‚Ä¢")}</div>
            <div class="tileText">
              <div class="tileTitle">${escapeHtml(def.title?.() || id)}</div>
              <div class="tileSub">${escapeHtml(def.subtitle?.() || "")}</div>
            </div>
          `;
          tile.addEventListener("click", async () => {
            try { await def.run(); }
            catch(e){ alert("Noe gikk galt: " + (e?.message || String(e))); }
          });
          host.appendChild(tile);
        }
      }

      function renderActivities(){
        const host = $("#activityList");
        host.innerHTML = "";

        const list = farm.farm.activityLog || [];
        if(!list.length){
          const n = document.createElement("div");
          n.className = "note";
          n.textContent = "Ingen aktiviteter enn√•.";
          host.appendChild(n);
          return;
        }

        // show latest 40 for performance, full stored is larger
        const show = list.slice(0, 40);

        for(const a of show){
          const div = document.createElement("div");
          div.className = "actItem";
          div.innerHTML = `
            <div class="actTop">
              <div class="actTitle">${escapeHtml(a.title)}</div>
              <div class="actTime">${escapeHtml(fmtDateTime(a.ts))}</div>
            </div>
            <div class="actSub">${escapeHtml(a.subtitle || "")}</div>
          `;
          div.addEventListener("click", async () => {
            await openActivity(a);
          });
          host.appendChild(div);
        }
      }

      async function openActivity(a){
        // Basic, safe behavior:
        // - route to target
        // - if we have an ID, open view editor for that item
        const route = a.route || "dashboard";
        routeTo(route === "settings" ? "settings" : (route === "panelsetup" ? "panelsetup" : (route === "backup" ? "backup" : (route === "tests" ? "tests" : (route === "work" ? "work" : "dashboard")))));

        // open details where possible
        const p = a.payload || {};
        if(a.type === "event" && p.eventId){
          const ev = farm.farm.modules.events.entries.find(x => x.id === p.eventId);
          if(ev){
            openEditor({
              title: "Hendelse",
              subtitle: "Detaljer",
              fields: [
                { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
                { key:"category", label:"Kategori", type:"select", options: farm.farm.modules.events.categories.map(x => [x,x]) },
                { key:"text", label:"Tekst", type:"textarea" }
              ],
              value: ev,
              onSave: async (nv) => {
                Object.assign(ev, nv);
                addActivity({
                  type:"event",
                  title:"Redigert hendelse",
                  subtitle: `${ev.category} ¬∑ ${fmtDateISOToNO(ev.date)}`,
                  route:"work",
                  payload:{ eventId: ev.id }
                });
                await saveAll();
                renderAll();
              }
            });
          }
        }

        if(a.type === "todo" && p.todoId){
          const t = farm.farm.modules.todo.items.find(x => x.id === p.todoId);
          if(t){
            openEditor({
              title: t.done ? "Ferdig TO DO" : "TO DO",
              subtitle: "Detaljer",
              fields: [
                { key:"text", label:"Tekst", type:"text" },
                { key:"dueDate", label:"Frist (YYYY-MM-DD)", type:"text" }
              ],
              value: t,
              onSave: async (nv) => {
                Object.assign(t, nv);
                addActivity({
                  type:"todo",
                  title:"Redigert TO DO",
                  subtitle: String(t.text||"").slice(0,60),
                  route:"work",
                  payload:{ todoId: t.id }
                });
                await saveAll();
                renderAll();
              }
            });
          }
        }

        if(a.type === "shopping" && p.itemId){
          const it = farm.farm.modules.shopping.items.find(x => x.id === p.itemId);
          if(it){
            openEditor({
              title: it.bought ? "Kj√∏pt vare" : "Handleliste",
              subtitle: "Detaljer",
              fields: [
                { key:"name", label:"Vare", type:"text" },
                { key:"qty", label:"Mengde", type:"text" },
                { key:"supplier", label:"Leverand√∏r", type:"select", options: farm.farm.modules.shopping.suppliers.map(x => [x,x]) }
              ],
              value: it,
              onSave: async (nv) => {
                Object.assign(it, nv);
                addActivity({
                  type:"shopping",
                  title:"Redigert vare",
                  subtitle: `${it.name} ¬∑ ${it.supplier}`,
                  route:"work",
                  payload:{ itemId: it.id }
                });
                await saveAll();
                renderAll();
              }
            });
          }
        }
      }

      // =========================
      //  Rendering: Panel setup
      // =========================
      function renderPanelSetup(){
        const host = $("#panelSetupList");
        host.innerHTML = "";

        registerWeblinkActions();
        ensurePanelHasWeblinks();

        const ids = panel.order.slice();
        // also include any actions not yet in order
        for(const [id] of ActionRegistry.entries()){
          if(!ids.includes(id)) ids.push(id);
        }

        // ensure unique
        const seen = new Set();
        const finalIds = ids.filter(x => (seen.has(x) ? false : (seen.add(x), true)));

        for(const id of finalIds){
          const def = getAction(id);
          if(!def) continue;

          const on = panel.visible[id] === true;
          const isBase = ["events.new","todo.new","shopping.new","job.toggle","weather.yr"].includes(id);

          const row = document.createElement("div");
          row.className = "moduleRow";
          row.innerHTML = `
            <div class="moduleMeta">
              <div class="moduleTitle">${escapeHtml(def.title?.() || id)} ${isBase ? `<span class="badge free">Basis</span>` : (id.startsWith("weblink:") ? `<span class="badge free">Weblink</span>` : ``)}</div>
              <div class="moduleDesc">${escapeHtml(def.subtitle?.() || "")}</div>
            </div>
            <div class="moduleRight">
              <div class="moduleActions">
                <button class="btn secondary small" data-act="up">‚¨Ü</button>
                <button class="btn secondary small" data-act="down">‚¨á</button>
                <button class="btn ${on ? "secondary":""} small" data-act="toggle">${on ? "P√•" : "Av"}</button>
                ${id.startsWith("weblink:") ? `<button class="btn danger small" data-act="remove">Slett</button>` : ``}
              </div>
            </div>
          `;

          row.querySelector('[data-act="up"]').addEventListener("click", async () => {
            moveInOrder(id, -1);
            await dbSet(KEY_PANEL, panel);
            renderTiles(); renderPanelSetup();
          });
          row.querySelector('[data-act="down"]').addEventListener("click", async () => {
            moveInOrder(id, +1);
            await dbSet(KEY_PANEL, panel);
            renderTiles(); renderPanelSetup();
          });
          row.querySelector('[data-act="toggle"]').addEventListener("click", async () => {
            panel.visible[id] = !on;
            await dbSet(KEY_PANEL, panel);
            addActivity({
              type:"panel",
              title: panel.visible[id] ? "Snarvei p√•" : "Snarvei av",
              subtitle: def.title?.() || id,
              route:"dashboard",
              payload:{ actionId:id }
            });
            await saveAll();
            renderTiles(); renderPanelSetup(); renderActivities();
          });

          if(id.startsWith("weblink:")){
            row.querySelector('[data-act="remove"]').addEventListener("click", async () => {
              if(!confirm("Slette weblink og fjerne snarvei?")) return;
              const wId = id.split("weblink:")[1];
              weblinks.items = weblinks.items.filter(x => x.id !== wId);
              delete panel.visible[id];
              panel.order = panel.order.filter(x => x !== id);
              ActionRegistry.delete(id);

              addActivity({ type:"weblink", title:"Slettet weblink", subtitle:"", route:"panelsetup", payload:{} });
              await dbSet(KEY_WEBLINKS, weblinks);
              await dbSet(KEY_PANEL, panel);
              await saveAll();
              renderTiles(); renderPanelSetup(); renderActivities();
            });
          }

          host.appendChild(row);
        }
      }

      function moveInOrder(id, delta){
        const idx = panel.order.indexOf(id);
        if(idx < 0){
          panel.order.push(id);
          return;
        }
        const ni = idx + delta;
        if(ni < 0 || ni >= panel.order.length) return;
        const copy = panel.order.slice();
        [copy[idx], copy[ni]] = [copy[ni], copy[idx]];
        panel.order = copy;
      }

      // =========================
      //  Rendering: Work modules
      // =========================
      function renderWork(){
        const host = $("#workHost");
        host.innerHTML = "";

        // EVENTS
        host.appendChild(renderEventsCard());
        // TODO
        host.appendChild(renderTodoCard());
        // SHOPPING
        host.appendChild(renderShoppingCard());
        // JOB TIMER
        host.appendChild(renderJobCard());
      }

      function renderEventsCard(){
        const ev = farm.farm.modules.events;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h2>Hendelser</h2>
          <p class="muted">Registrer hva som skjedde, n√•r og kategori.</p>
          <div class="row">
            <span class="badge free">Antall: ${ev.entries.length}</span>
            <button class="btn" id="btnNewEvent">Ny hendelse</button>
          </div>
          <hr/>
          <div id="evList"></div>
        `;
        card.querySelector("#btnNewEvent").addEventListener("click", () => actions.newEvent(true));

        const list = card.querySelector("#evList");
        if(!ev.entries.length){
          const n = document.createElement("div");
          n.className = "note";
          n.textContent = "Ingen hendelser enn√•.";
          list.appendChild(n);
          return card;
        }

        ev.entries.slice(0, 50).forEach((it, i) => {
          const row = document.createElement("div");
          row.className = "moduleRow";
          row.innerHTML = `
            <div class="moduleMeta">
              <div class="moduleTitle">${escapeHtml(it.category)}</div>
              <div class="moduleDesc">${escapeHtml(fmtDateISOToNO(it.date))} ¬∑ ${escapeHtml(String(it.text||"").slice(0,140))}${String(it.text||"").length>140?"‚Ä¶":""}</div>
            </div>
            <div class="moduleRight">
              <div class="moduleActions">
                <button class="btn secondary" data-act="edit">Rediger</button>
                <button class="btn danger" data-act="del">Slett</button>
              </div>
            </div>
          `;
          row.querySelector('[data-act="del"]').addEventListener("click", async () => {
            if(!confirm("Slette hendelsen?")) return;
            const removed = ev.entries.splice(i,1)[0];
            addActivity({ type:"event", title:"Slettet hendelse", subtitle: removed?.category || "", route:"work", payload:{} });
            await saveAll();
            renderAll();
          });
          row.querySelector('[data-act="edit"]').addEventListener("click", () => {
            openEditor({
              title:"Rediger hendelse",
              subtitle:"Dato, kategori og tekst.",
              fields:[
                { key:"date", label:"Dato (YYYY-MM-DD)", type:"text" },
                { key:"category", label:"Kategori", type:"select", options: ev.categories.map(x => [x,x]) },
                { key:"text", label:"Tekst", type:"textarea" }
              ],
              value: it,
              onSave: async (nv) => {
                Object.assign(it, nv);
                addActivity({ type:"event", title:"Redigert hendelse", subtitle: `${it.category} ¬∑ ${fmtDateISOToNO(it.date)}`, route:"work", payload:{ eventId: it.id }});
                await saveAll();
                renderAll();
              }
            });
          });
          list.appendChild(row);
        });

        return card;
      }

      function renderTodoCard(){
        const t = farm.farm.modules.todo;
        const open = t.items.filter(x => !x.done);
        const done = t.items.filter(x => x.done);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h2>TO DO</h2>
          <p class="muted">Sletting av aktive er fjernet. Ferdige ligger under ‚ÄúFerdige‚Äù.</p>
          <div class="row">
            <span class="badge free">√Öpne: ${open.length}</span>
            <span class="badge free">Ferdige: ${done.length}</span>
            <button class="btn" id="btnNewTodo">Nytt gj√∏rem√•l</button>
          </div>

          <hr/>
          <h2 style="margin-top:0">√Öpne</h2>
          <div id="todoOpen"></div>

          <hr/>
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Ferdige</h2>
          </div>
          <label class="field" style="margin-top:10px">
            <span>S√∏k i ferdige</span>
            <input id="todoDoneSearch" type="text" placeholder="S√∏k..." />
          </label>
          <div id="todoDone"></div>
          <div class="hint">Permanent sletting finnes kun under Ferdige, med ekstra bekreftelse.</div>
        `;
        card.querySelector("#btnNewTodo").addEventListener("click", () => actions.newTodo(true));

        const openHost = card.querySelector("#todoOpen");
        if(!open.length){
          const n = document.createElement("div");
          n.className = "note";
          n.textContent = "Ingen √•pne gj√∏rem√•l.";
          openHost.appendChild(n);
        }else{
          open.forEach((it) => {
            const row = document.createElement("div");
            row.className = "moduleRow";
            row.innerHTML = `
              <div class="moduleMeta">
                <div class="moduleTitle">‚¨úÔ∏è ${escapeHtml(it.text || "Gj√∏rem√•l")}</div>
                <div class="moduleDesc">${it.dueDate ? ("Frist: "+escapeHtml(fmtDateISOToNO(it.dueDate))) : ""}</div>
              </div>
              <div class="moduleRight">
                <div class="moduleActions">
                  <button class="btn secondary" data-act="done">Ferdig</button>
                  <button class="btn secondary" data-act="edit">Rediger</button>
                </div>
              </div>
            `;
            row.querySelector('[data-act="done"]').addEventListener("click", async () => {
              it.done = true;
              it.doneAt = new Date().toISOString();
              addActivity({ type:"todo", title:"Fullf√∏rt TO DO", subtitle: String(it.text||"").slice(0,60), route:"work", payload:{ todoId: it.id }});
              await saveAll();
              renderAll();
            });
            row.querySelector('[data-act="edit"]').addEventListener("click", () => {
              openEditor({
                title:"Rediger TO DO",
                subtitle:"",
                fields:[
                  { key:"text", label:"Tekst", type:"text" },
                  { key:"dueDate", label:"Frist (YYYY-MM-DD)", type:"text" }
                ],
                value: it,
                onSave: async (nv) => {
                  Object.assign(it, nv);
                  addActivity({ type:"todo", title:"Redigert TO DO", subtitle: String(it.text||"").slice(0,60), route:"work", payload:{ todoId: it.id }});
                  await saveAll();
                  renderAll();
                }
              });
            });
            openHost.appendChild(row);
          });
        }

        const doneHost = card.querySelector("#todoDone");
        const search = card.querySelector("#todoDoneSearch");
        function renderDoneList(){
          doneHost.innerHTML = "";
          const q = (search.value || "").trim().toLowerCase();
          const doneFiltered = done.filter(it => {
            const text = String(it.text||"").toLowerCase();
            const date = it.doneAt ? fmtDateTime(it.doneAt).toLowerCase() : "";
            return !q || text.includes(q) || date.includes(q);
          });

          if(!doneFiltered.length){
            const n = document.createElement("div");
            n.className = "note";
            n.textContent = done.length ? "Ingen treff." : "Ingen ferdige gj√∏rem√•l.";
            doneHost.appendChild(n);
            return;
          }

          doneFiltered.slice(0, 200).forEach((it) => {
            const row = document.createElement("div");
            row.className = "moduleRow";
            row.innerHTML = `
              <div class="moduleMeta">
                <div class="moduleTitle">‚úÖ ${escapeHtml(it.text || "Gj√∏rem√•l")}</div>
                <div class="moduleDesc">
                  ${it.doneAt ? ("Ferdig: "+escapeHtml(fmtDateTime(it.doneAt))) : ""}
                </div>
              </div>
              <div class="moduleRight">
                <div class="moduleActions">
                  <button class="btn secondary" data-act="undo">Gjen√•pne</button>
                  <button class="btn danger" data-act="del">Slett permanent</button>
                </div>
              </div>
            `;
            row.querySelector('[data-act="undo"]').addEventListener("click", async () => {
              it.done = false;
              it.doneAt = null;
              addActivity({ type:"todo", title:"Gjen√•pnet TO DO", subtitle: String(it.text||"").slice(0,60), route:"work", payload:{ todoId: it.id }});
              await saveAll();
              renderAll();
            });
            row.querySelector('[data-act="del"]').addEventListener("click", async () => {
              const a = prompt("Skriv SLETT for √• bekrefte permanent sletting:");
              if(a !== "SLETT") return;
              const idx = t.items.findIndex(x => x.id === it.id);
              if(idx >= 0) t.items.splice(idx,1);
              addActivity({ type:"todo", title:"Slettet ferdig TO DO", subtitle: String(it.text||"").slice(0,60), route:"work", payload:{} });
              await saveAll();
              renderAll();
            });
            doneHost.appendChild(row);
          });
        }
        search.addEventListener("input", renderDoneList);
        renderDoneList();

        return card;
      }

      function renderShoppingCard(){
        const s = farm.farm.modules.shopping;
        const open = s.items.filter(x => !x.bought);
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h2>Handleliste</h2>
          <p class="muted">Legg inn varer. Velg leverand√∏r.</p>
          <div class="row">
            <span class="badge free">√Öpne: ${open.length}</span>
            <button class="btn" id="btnNewShop">Ny vare</button>
            <button class="btn danger" id="btnClearBought">Slett kj√∏pt</button>
          </div>
          <hr/>
          <div id="shopList"></div>
        `;
        card.querySelector("#btnNewShop").addEventListener("click", () => actions.newShopping(true));
        card.querySelector("#btnClearBought").addEventListener("click", async () => {
          if(!confirm("Slette alt som er markert kj√∏pt?")) return;
          s.items = s.items.filter(x => !x.bought);
          addActivity({ type:"shopping", title:"Slettet kj√∏pte varer", subtitle:"", route:"work", payload:{} });
          await saveAll();
          renderAll();
        });

        const list = card.querySelector("#shopList");
        if(!s.items.length){
          const n = document.createElement("div");
          n.className = "note";
          n.textContent = "Ingen varer enn√•.";
          list.appendChild(n);
          return card;
        }

        s.items.slice(0, 100).forEach((it, i) => {
          const row = document.createElement("div");
          row.className = "moduleRow";
          row.innerHTML = `
            <div class="moduleMeta">
              <div class="moduleTitle">${it.bought ? "‚úÖ" : "üõí"} ${escapeHtml(it.name || "Vare")}</div>
              <div class="moduleDesc">Leverand√∏r: <b>${escapeHtml(it.supplier || "‚Äî")}</b>${it.qty?(" ¬∑ Mengde: "+escapeHtml(it.qty)):""}${it.boughtAt?(" ¬∑ Kj√∏pt: "+escapeHtml(fmtDateTime(it.boughtAt))):""}</div>
            </div>
            <div class="moduleRight">
              <div class="moduleActions">
                <button class="btn secondary" data-act="toggle">${it.bought ? "Angre" : "Kj√∏pt"}</button>
                <button class="btn secondary" data-act="edit">Rediger</button>
                <button class="btn danger" data-act="del">Slett</button>
              </div>
            </div>
          `;
          row.querySelector('[data-act="toggle"]').addEventListener("click", async () => {
            it.bought = !it.bought;
            it.boughtAt = it.bought ? new Date().toISOString() : null;
            addActivity({ type:"shopping", title: it.bought ? "Markert kj√∏pt" : "Angret kj√∏pt", subtitle: `${it.name} ¬∑ ${it.supplier}`, route:"work", payload:{ itemId: it.id }});
            await saveAll();
            renderAll();
          });
          row.querySelector('[data-act="del"]').addEventListener("click", async () => {
            if(!confirm("Slette denne varen?")) return;
            const removed = s.items.splice(i,1)[0];
            addActivity({ type:"shopping", title:"Slettet vare", subtitle: removed?.name || "", route:"work", payload:{} });
            await saveAll();
            renderAll();
          });
          row.querySelector('[data-act="edit"]').addEventListener("click", () => {
            openEditor({
              title:"Rediger vare",
              subtitle:"Leverand√∏r brukes i historikk senere.",
              fields:[
                { key:"name", label:"Vare", type:"text" },
                { key:"qty", label:"Mengde", type:"text" },
                { key:"supplier", label:"Leverand√∏r", type:"select", options: s.suppliers.map(x => [x,x]) }
              ],
              value: it,
              onSave: async (nv) => {
                Object.assign(it, nv);
                addActivity({ type:"shopping", title:"Redigert vare", subtitle: `${it.name} ¬∑ ${it.supplier}`, route:"work", payload:{ itemId: it.id }});
                await saveAll();
                renderAll();
              }
            });
          });
          list.appendChild(row);
        });

        return card;
      }

      function renderJobCard(){
        const jt = farm.farm.modules.jobTimer;
        const unbilled = jt.sessions.filter(x => x.status === "unbilled");

        const card = document.createElement("div");
        card.className = "card";
        const runningTxt = jt.running ? `P√•g√•r: <b>${escapeHtml(jt.running.customer)}</b> ¬∑ ${escapeHtml(jt.running.task)} (startet ${escapeHtml(fmtDateTime(jt.running.startedAt))})` : "Ingen jobb p√•g√•r.";
        card.innerHTML = `
          <h2>Jobbklokke</h2>
          <p class="muted">${runningTxt}</p>
          <div class="row">
            <span class="badge free">Ufakturerte: ${unbilled.length}</span>
            <button class="btn" id="btnJobToggle">${jt.running ? "Stopp jobb" : "Start jobb"}</button>
          </div>
          <hr/>
          <h2 style="margin-top:0">Ufakturerte jobber</h2>
          <div id="jobList"></div>
        `;
        card.querySelector("#btnJobToggle").addEventListener("click", async () => {
          if(jt.running) await actions.stopJob(true);
          else await actions.startJob(true);
        });

        const list = card.querySelector("#jobList");
        if(!unbilled.length){
          const n = document.createElement("div");
          n.className = "note";
          n.textContent = "Ingen ufakturerte jobber enn√•.";
          list.appendChild(n);
          return card;
        }

        unbilled.slice(0, 50).forEach((s) => {
          const row = document.createElement("div");
          row.className = "moduleRow";
          row.innerHTML = `
            <div class="moduleMeta">
              <div class="moduleTitle">${escapeHtml(s.customer)} ¬∑ ${escapeHtml(s.task)}</div>
              <div class="moduleDesc">${escapeHtml(fmtDateTime(s.startedAt))} ‚Üí ${escapeHtml(fmtDateTime(s.endedAt))} ¬∑ <b>${escapeHtml(String(s.minutes||0))}</b> min${s.note?(" ¬∑ "+escapeHtml(s.note)):""}</div>
            </div>
            <div class="moduleRight">
              <div class="moduleActions">
                <button class="btn secondary" data-act="bill">Marker fakturert</button>
                <button class="btn danger" data-act="del">Slett</button>
              </div>
            </div>
          `;
          row.querySelector('[data-act="bill"]').addEventListener("click", async () => {
            const idx = jt.sessions.findIndex(x => x.id === s.id);
            if(idx >= 0) jt.sessions[idx].status = "billed";
            addActivity({ type:"job", title:"Markert fakturert", subtitle: `${s.customer} ¬∑ ${s.task}`, route:"work", payload:{} });
            await saveAll();
            renderAll();
          });
          row.querySelector('[data-act="del"]').addEventListener("click", async () => {
            if(!confirm("Slette denne jobb√∏kta?")) return;
            const idx = jt.sessions.findIndex(x => x.id === s.id);
            if(idx >= 0) jt.sessions.splice(idx, 1);
            addActivity({ type:"job", title:"Slettet jobb√∏kt", subtitle: `${s.customer} ¬∑ ${s.task}`, route:"work", payload:{} });
            await saveAll();
            renderAll();
          });
          list.appendChild(row);
        });

        return card;
      }

      // =========================
      //  Backup
      // =========================
      function downloadJSON(filename, obj){
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function exportBackup(){
        const payload = {
          exportedAt: new Date().toISOString(),
          appVersion: APP_VERSION,
          storageMode,
          farm,
          panel,
          weblinks
        };
        const safe = (farm.farm.name || "farm").toLowerCase().replace(/[^a-z0-9]+/g, "-");
        downloadJSON(`${safe}-backup.json`, payload);
        setStatus("Backup eksportert ‚úÖ");
      }

      async function importBackup(){
        const input = $("#importFile");
        const file = input.files?.[0];
        if(!file){ alert("Velg en backup-fil f√∏rst."); return; }
        let parsed;
        try { parsed = JSON.parse(await file.text()); }
        catch { alert("Ugyldig JSON."); return; }

        const f = parsed?.farm || parsed?.data || parsed;
        const p = parsed?.panel || null;
        const w = parsed?.weblinks || null;

        farm = patchFarm(f);
        panel = patchPanel(p);
        weblinks = patchWeblinks(w);

        registerBaseActions();
        registerWeblinkActions();
        ensurePanelHasWeblinks();

        farm.meta.updatedAt = new Date().toISOString();
        await dbSet(KEY_FARM, farm);
        await dbSet(KEY_PANEL, panel);
        await dbSet(KEY_WEBLINKS, weblinks);

        syncFarmToForm();
        renderAll();
        setStatus("Importert ‚úÖ");
        input.value = "";
      }

      // =========================
      //  Background (Phase 1 request included as future; NOT enabled here)
      //  (We keep hook ready but not exposed to UI in phase 1)
      // =========================
      function applyBackground(){
        // If you later add a background in data, you can set:
        // farm.farm.ui = { bgDataUrl:"data:image/..", dim:0.55 }
        const ui = farm.farm.ui || null;
        const bg = ui?.bgDataUrl ? `url("${ui.bgDataUrl}")` : "none";
        const dim = (typeof ui?.dim === "number") ? ui.dim : 0.55;
        document.documentElement.style.setProperty("--bgimg", bg);
        document.documentElement.style.setProperty("--bgdim", String(dim));
      }

      // =========================
      //  Selftest
      // =========================
      function runSelftest(){
        const results = [];
        function ok(name){ results.push({name, ok:true}); }
        function fail(name, err){ results.push({name, ok:false, err: err?.message || String(err)}); }

        try{
          if(!farm?.farm?.modules?.events) throw new Error("events missing");
          if(!farm?.farm?.modules?.todo) throw new Error("todo missing");
          if(!farm?.farm?.modules?.shopping) throw new Error("shopping missing");
          if(!farm?.farm?.modules?.jobTimer) throw new Error("jobTimer missing");
          ok("Datamodell finnes");
        }catch(e){ fail("Datamodell finnes", e); }

        try{
          const a = farm.farm.activityLog;
          if(!Array.isArray(a)) throw new Error("activityLog not array");
          ok("Aktivitetslogg OK");
        }catch(e){ fail("Aktivitetslogg OK", e); }

        try{
          const d = fmtDateTime(new Date().toISOString());
          if(!/\d{2}\.\d{2}\.\d{4}\s\d{2}:\d{2}/.test(d)) throw new Error("formatter mismatch: " + d);
          ok("Datoformat dd.mm.√•√•√•√• HH:MM");
        }catch(e){ fail("Datoformat dd.mm.√•√•√•√• HH:MM", e); }

        const host = $("#testResults");
        host.innerHTML = "";
        results.forEach(r => {
          const div = document.createElement("div");
          div.className = "moduleRow";
          div.innerHTML = `
            <div class="moduleMeta">
              <div class="moduleTitle">${escapeHtml(r.name)}</div>
              ${r.ok ? "" : `<div class="moduleDesc">${escapeHtml(r.err || "")}</div>`}
            </div>
            <div class="moduleRight">
              <span class="badge ${r.ok ? "ok":"fail"}">${r.ok ? "OK":"FEIL"}</span>
            </div>
          `;
          host.appendChild(div);
        });

        setStatus(`Selvtest: ${results.filter(x=>x.ok).length}/${results.length} OK`);
      }

      // =========================
      //  Render all
      // =========================
      function renderAll(){
        syncFarmToForm();
        renderKPIs();
        renderTiles();
        renderPanelSetup();
        renderWork();
        renderActivities();
      }

      // =========================
      //  Wire UI
      // =========================
      function wireUI(){
        $$("#tabs .tab").forEach(b => b.addEventListener("click", () => routeTo(b.dataset.route)));

        $("#btnMinGard").addEventListener("click", () => routeTo("settings"));
        $("#btnPanelSetup").addEventListener("click", () => routeTo("panelsetup"));

        $("#btnSaveFarmSettings").addEventListener("click", async () => {
          await saveAll();
          renderAll();
        });
        $("#btnSaveNow").addEventListener("click", async () => {
          await saveAll();
          renderAll();
        });

        ["#farmName","#areaDyrket","#areaBeite","#areaUtmark","#yrUrl"].forEach(id => {
          $(id).addEventListener("change", async () => {
            await saveAll();
            renderAll();
          });
        });

        $("#btnResetFarm").addEventListener("click", async () => {
          if(!confirm("Dette nullstiller g√•rden i appen. Ta backup f√∏rst.\n\nFortsette?")) return;
          await dbClear();
          farm = newFarm();
          panel = defaultPanel();
          weblinks = { items: [] };
          farm = patchFarm(farm);
          panel = patchPanel(panel);
          weblinks = patchWeblinks(weblinks);
          registerBaseActions();
          await dbSet(KEY_FARM, farm);
          await dbSet(KEY_PANEL, panel);
          await dbSet(KEY_WEBLINKS, weblinks);
          setStatus("Ny g√•rd opprettet ‚úÖ");
          renderAll();
          routeTo("dashboard");
        });

        $("#btnExport").addEventListener("click", exportBackup);
        $("#btnImport").addEventListener("click", () => {
          if(confirm("Import overskriver gjeldende g√•rd.\n\nFortsette?")) importBackup();
        });

        $("#btnRunTests").addEventListener("click", runSelftest);

        // Activities
        $("#btnClearActivity").addEventListener("click", async () => {
          if(!confirm("T√∏mme aktivitetsloggen?")) return;
          farm.farm.activityLog = [];
          await saveAll();
          renderActivities();
        });

        // Panel: add weblink
        $("#btnAddWeblink").addEventListener("click", async () => {
          const name = ($("#wlName").value || "").trim();
          const url = ($("#wlUrl").value || "").trim();
          if(!name || !url){ alert("Fyll inn b√•de navn og URL."); return; }
          if(!/^https?:\/\//i.test(url)){ alert("URL m√• starte med http:// eller https://"); return; }

          const item = { id: uuid(), name, url, createdAt: new Date().toISOString() };
          weblinks.items.push(item);

          $("#wlName").value = "";
          $("#wlUrl").value = "";

          addActivity({ type:"weblink", title:"La til weblink", subtitle:`${name} ¬∑ ${url}`, route:"panelsetup", payload:{ weblinkId:item.id } });

          await dbSet(KEY_WEBLINKS, weblinks);
          registerWeblinkActions();
          ensurePanelHasWeblinks();
          await dbSet(KEY_PANEL, panel);
          await saveAll();
          renderAll();
        });

        // Editor modal
        $("#editorOverlayBg").addEventListener("click", () => closeEditor(true));
        $("#btnEditorCancel").addEventListener("click", () => closeEditor(true));
        $("#btnEditorSave").addEventListener("click", async () => {
          if(!editor.onSave || !editor.value){ closeEditor(false); return; }
          await editor.onSave(editor.value);
          closeEditor(false);
          renderAll();
        });
      }

      // =========================
      //  Boot
      // =========================
      async function boot(){
        setStatus("Laster‚Ä¶");
        await dbProbe();

        // Load persisted
        farm = patchFarm(await dbGet(KEY_FARM) || newFarm());
        panel = patchPanel(await dbGet(KEY_PANEL) || defaultPanel());
        weblinks = patchWeblinks(await dbGet(KEY_WEBLINKS) || { items: [] });

        // Actions
        registerBaseActions();
        registerWeblinkActions();
        ensurePanelHasWeblinks();

        await dbSet(KEY_FARM, farm);
        await dbSet(KEY_PANEL, panel);
        await dbSet(KEY_WEBLINKS, weblinks);

        wireUI();
        renderAll();
        routeTo("dashboard");
        setStatus(`Klar ‚úÖ (${storageMode})`);
      }

      document.addEventListener("DOMContentLoaded", boot);
    })();
  </script>
</body>
</html>
